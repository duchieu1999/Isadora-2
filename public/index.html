<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bánh Xe Hiếu Gà - Quay Là Có Quà!</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Anton&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <!-- Anime.js for better animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Howler.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- HTML2Canvas for reward card capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #d82f2f;
            --primary-dark: #b71c1c;
            --secondary-color: #ffeb3b;
            --text-color: #4a3528;
            --background-color: #87CEEB;
            --wheel-section-color: #f0d6a3;
            --wheel-border-color: #d02b27;
            --wheel-dot-color: #ffeb3b;
            --wheel-text-color: #a3251b;
            --btn-color: #d82f2f;
            --btn-text: #ffeb3b;
            --btn-hover: #b71c1c;
            --outline-color: #ffbb00;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto Condensed', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            width: 100%;
            background-image: url('https://img.upanh.tv/2025/04/29/ChatGPT-Image-18_51_42-29-thg-4-2025.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Header styles */
        .header {
            text-align: center;
            padding: 10px 0;
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        
        .flag-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .flag-left, .flag-right {
            width: 90px;
            height: 70px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 10px;
        }
        
        .flag-left::before, .flag-right::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .title-banner {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 10px 20px;
            border: 2px solid var(--secondary-color);
            width: 250px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        
        .title-banner h1 {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            margin: 0;
            line-height: 1;
        }
        
        .title-banner h2 {
            font-family: 'Anton', sans-serif;
            font-size: 20px;
            margin: 5px 0 0;
            line-height: 1;
        }
        
        .pennant-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .pennant {
            width: 25px;
            height: 30px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 3px;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
        }
        
        .pennant::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        /* Main game container */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 0 10px;
            position: relative;
            z-index: 1;
        }
        
        /* Countdown timer */
        .event-countdown {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .countdown-title {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .countdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .countdown-value {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        
        .countdown-label {
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Wheel container */
        .wheel-outer-container {
            position: relative;
            width: 100%;
            max-width: 340px;
            margin: 10px auto;
        }
        
        .wheel-flag {
            position: absolute;
            top: -40px;
            left: -80px;
            width: 140px;
            height: 100px;
            z-index: 10;
        }
        
        .wheel-flag-content {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--secondary-color);
            font-family: 'Anton', sans-serif;
            font-size: 18px;
            line-height: 1.2;
            padding: 10px;
            text-align: center;
        }
        
        .wheel-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Square aspect ratio */
        }
        
        .wheel-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background-color: var(--wheel-section-color);
            border: 12px solid var(--wheel-border-color);
            box-shadow: 0 0 0 2px var(--secondary-color), 0 10px 20px rgba(0,0,0,0.3);
            will-change: transform;
            backface-visibility: hidden;
            transform: rotate(0deg);
        }
        
        .wheel-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 50%;
            transform-origin: bottom right;
            text-align: center;
            box-sizing: border-box;
            border: 1px solid #ba8f4a;
            overflow: hidden;
        }
        
        .wheel-section-content {
            position: absolute;
            width: 45px;
            height: 45px;
            top: 20px;
            left: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: rotate(45deg);
            overflow: visible;
        }
        
        .wheel-section-icon {
            font-size: 24px;
            margin-bottom: 5px;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }
        
        .wheel-section-text {
            font-size: 8px; 
            font-weight: bold;
            color: var(--wheel-text-color);
            text-align: center;
            width: 100%;
            line-height: 1;
            word-wrap: break-word;
            overflow: visible;
            padding: 0 2px;
            text-shadow: 0 0 2px white;
            white-space: nowrap;
        }
        
        .wheel-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .wheel-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--wheel-dot-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .wheel-center-fixed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15%;
            height: 15%;
            z-index: 5;
            pointer-events: none;
        }
        
        .wheel-center {
            width: 100%;
            height: 100%;
            background-color: var(--wheel-border-color);
            border: 3px solid var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-center-circle {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-pointer-container {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 6;
            width: 30px;
            height: 30px;
        }
        
        .wheel-pointer {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            border: 2px solid var(--secondary-color);
            border-bottom: none;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3));
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 0 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary-color);
            text-transform: uppercase;
            width: 100%;
            max-width: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            background-color: var(--btn-hover);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        .btn-shine {
            position: absolute;
            top: 0;
            left: -50px;
            width: 30px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            transform: skewX(-20deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -50px; }
            20% { left: 120%; }
            100% { left: 120%; }
        }
        
        .btn-spin::before {
            content: '🎲';
            margin-right: 10px;
        }
        
        .btn-redeem {
            background-color: #4CAF50;
        }
        
        .btn-redeem:hover {
            background-color: #388E3C;
        }
        
        /* Results */
        .result-container {
            width: 100%;
            min-height: 60px;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }
        
        .result-message {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        .result-icon {
            font-size: 32px;
            margin: 5px 0;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
            animation: iconPulse 1s infinite alternate;
        }
        
        @keyframes iconPulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
        
        .result-container.highlight {
            background: linear-gradient(135deg, #fff9c4, #ffffff, #ffecb3);
            background-size: 200% 200%;
            animation: gradientBg 2s ease infinite;
        }
        
        @keyframes gradientBg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Redeem section */
        .redeem-section {
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .redeem-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .redeem-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .redeem-option {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: calc(50% - 5px);
            box-sizing: border-box;
        }
        
        .redeem-option:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .redeem-option.selected {
            background-color: #d5f5d5;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px #4CAF50;
        }
        
        .redeem-option-amount {
            font-weight: bold;
            color: var(--primary-dark);
            font-size: 16px;
        }
        
        .redeem-option-points {
            font-size: 12px;
            color: #666;
        }
        
        .redeem-confirm-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .redeem-confirm-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .redeem-confirm-btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Reward card */
        .reward-card {
            width: 100%;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            display: none;
            margin: 10px 0;
            max-width: 400px;
        }
        
        .reward-card::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 235, 59, 0.05) 10px,
                rgba(255, 235, 59, 0.05) 20px
            );
            z-index: -1;
        }
        
        .reward-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .reward-logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .reward-title {
            font-size: 18px;
            color: var(--primary-dark);
            text-align: left;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .reward-subtitle {
            font-size: 12px;
            color: #666;
            text-align: left;
        }
        
        .reward-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-dark);
            margin: 20px 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,235,59,0.2), rgba(255,255,255,0.1));
            border-radius: 5px;
            display: inline-block;
        }
        
        .reward-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .reward-image {
            width: 100%;
            height: 150px;
            background-color: #f1f1f1;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed #999;
            overflow: hidden;
        }
        
        .reward-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .reward-qr-code {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            background-color: #f1f1f1;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .reward-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .reward-date {
            font-size: 12px;
            color: #666;
        }
        
        .reward-watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            transform: rotate(-15deg);
            opacity: 0.5;
        }
        
        .save-btn {
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .save-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .save-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20%;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
            animation: saveButtonShine 3s infinite;
        }
        
        @keyframes saveButtonShine {
            0% { left: -60%; }
            20% { left: 130%; }
            100% { left: 130%; }
        }
        
        /* Leaderboard */
        .leaderboard {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .leaderboard-title {
            font-size: 16px;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
            position: relative;
        }
        
        .leaderboard-title::after {
            content: '🏆';
            margin-left: 5px;
        }
        
        .leaderboard-list {
            list-style: none;
            padding: 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
        }
        
        .leaderboard-item:hover {
            background-color: rgba(255, 235, 59, 0.1);
            transform: translateX(2px);
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .leaderboard-item:nth-child(1) .leaderboard-rank {
            background-color: gold;
            color: black;
            box-shadow: 0 0 10px gold;
        }
        
        .leaderboard-item:nth-child(2) .leaderboard-rank {
            background-color: silver;
            color: black;
        }
        
        .leaderboard-item:nth-child(3) .leaderboard-rank {
            background-color: #cd7f32;
            color: white;
        }
        
        .leaderboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .leaderboard-name {
            font-weight: bold;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .leaderboard-score {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .leaderboard-status {
            height: 16px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .name-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .name-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .name-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .name-input button:hover {
            background-color: var(--primary-dark);
        }
        
        .user-id-hidden {
            display: none;
        }
        
        /* Loading spinner */
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s infinite linear;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Global spinner for page loading */
        .global-spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .global-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s infinite linear;
        }
        
        .global-spinner-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        /* Error page */
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        
        .error-message {
            font-size: 16px;
            color: white;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .error-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            margin-top: 20px;
            width: 100%;
            font-size: 12px;
        }
        
        .footer p {
            margin: 3px 0;
        }
        
        /* Special effects and animations */
        .glow {
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px -5px rgba(255, 235, 59, 0.5); }
            to { box-shadow: 0 0 20px 5px rgba(255, 235, 59, 0.8); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Jackpot effect */
        .jackpot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .jackpot-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px gold;
            transform: scale(0.8);
            transition: transform 0.5s;
        }
        
        .jackpot-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .jackpot-overlay.show .jackpot-content {
            transform: scale(1);
        }
        
        .jackpot-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .jackpot-points {
            font-size: 36px;
            color: gold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
            font-weight: bold;
        }
        
        .jackpot-close {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        
        /* Reset spinner animation */
        @keyframes resetSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .reset-icon {
            display: inline-block;
            animation: resetSpin 1s linear infinite;
            margin-right: 5px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease-out;
            font-size: 14px;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Name registration overlay */
        .name-registration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
        }
        
        .name-registration-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
        }
        
        .name-registration-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .name-registration-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .name-registration-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .name-registration-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .name-registration-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
        }
        
        .name-registration-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .name-registration-error {
            color: red;
            font-size: 14px;
            margin-bottom: 10px;
            display: none;
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-dot.online {
            background-color: #4CAF50;
        }
        
        .status-dot.syncing {
            background-color: #FFC107;
            animation: pulse 1s infinite;
        }
        
        .status-dot.error {
            background-color: #F44336;
        }
        
        /* Refresh button */
        .refresh-spins-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .refresh-spins-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Poster overlay styles */
        .poster-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .poster-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
            border: 5px solid var(--primary-color);
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
        
        .poster-instructions {
            color: white;
            text-align: center;
            margin-top: 20px;
            max-width: 90%;
        }
        
        .poster-instructions h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .poster-instructions p {
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .poster-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .poster-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .poster-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .poster-button.share {
            background-color: #0088cc;
            color: white;
        }
        
        .poster-button.close {
            background-color: #666;
            color: white;
        }
        
        .screenshot-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        /* Responsive adjustments */
        @media screen and (max-height: 700px) {
            .wheel-outer-container {
                max-width: 300px;
            }
            
            .title-banner {
                width: 200px;
                height: 100px;
            }
            
            .title-banner h1 {
                font-size: 28px;
            }
            
            .title-banner h2 {
                font-size: 16px;
            }
        }
        
        @media screen and (max-height: 600px) {
            .wheel-outer-container {
                max-width: 280px;
            }
            
            .controls, .stats, .result-container, .redeem-section, .leaderboard {
                margin: 5px 0;
            }
            
            .btn {
                padding: 8px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Global spinner -->
    <div class="global-spinner-container" id="global-spinner">
        <div class="global-spinner"></div>
        <div class="global-spinner-text">Đang kết nối với máy chủ...</div>
    </div>
    
    <!-- Error page -->
    <div class="error-container" id="error-container" style="display: none;">
        <div class="error-icon">⚠️</div>
        <div class="error-title">Không thể kết nối máy chủ</div>
        <div class="error-message" id="error-message">
            Đã xảy ra lỗi khi kết nối với máy chủ. Vui lòng thử lại sau.
        </div>
        <button class="error-button" onclick="location.reload()">Tải lại trang</button>
    </div>
    
    <!-- Status indicator -->
    <div class="status-indicator" id="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Đang kết nối...</span>
    </div>
    
    <div class="header">
        <div class="flag-banner">
            <div class="flag-left"></div>
            <div class="title-banner">
                <h1>30 THÁNG 4</h1>
                <h2>GIẢI PHÓNG MIỀN NAM</h2>
            </div>
            <div class="flag-right"></div>
        </div>
        <div class="pennant-banner">
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="event-countdown">
            <div class="countdown-title">Kết thúc sự kiện sau</div>
            <div class="countdown-timer">
                <div class="countdown-item">
                    <div class="countdown-value" id="days-value">00</div>
                    <div class="countdown-label">Ngày</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="hours-value">00</div>
                    <div class="countdown-label">Giờ</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="minutes-value">00</div>
                    <div class="countdown-label">Phút</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="seconds-value">00</div>
                    <div class="countdown-label">Giây</div>
                </div>
            </div>
        </div>
        
        <div class="wheel-outer-container">
            <div class="wheel-flag">
                <div class="wheel-flag-content">
                    THỐNG<br>NHẤT<br>ĐẤT<br>NƯỚC
                </div>
            </div>
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-dots" id="wheel-dots"></div>
                    <div class="wheel-center-fixed">
                        <div class="wheel-center">
                            <div class="wheel-center-circle"></div>
                        </div>
                    </div>
                    <div class="wheel-pointer-container">
                        <div class="wheel-pointer"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="points-value">0</div>
                <div class="stat-label">Điểm tích lũy</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="spins-value">50</div>
                <div class="stat-label">Lượt quay còn lại</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="timer-value">29:59</div>
                <div class="stat-label">+50 lượt quay sau</div>
                <button class="refresh-spins-button" id="refresh-spins-button" title="Kiểm tra làm mới lượt quay">↻</button>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-spin" id="spin-btn" disabled>
                <div class="btn-shine"></div>
                QUAY NGAY
            </button>
        </div>
        
        <div class="result-container" id="result">
            <div class="result-title">Kết quả quay thưởng</div>
            <div class="result-message">Hãy quay bánh xe để nhận thưởng!</div>
        </div>
        
        <div class="redeem-section" id="redeem-section">
            <div class="redeem-title">Đổi điểm lấy phần thưởng</div>
            <div class="redeem-options">
                <div class="redeem-option" data-amount="1000" data-points="1000">
                    <div class="redeem-option-amount">1.000 VNĐ</div>
                    <div class="redeem-option-points">1.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="2000" data-points="2000">
                    <div class="redeem-option-amount">2.000 VNĐ</div>
                    <div class="redeem-option-points">2.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="5000" data-points="5000">
                    <div class="redeem-option-amount">5.000 VNĐ</div>
                    <div class="redeem-option-points">5.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="10000" data-points="10000">
                    <div class="redeem-option-amount">10.000 VNĐ</div>
                    <div class="redeem-option-points">10.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="20000" data-points="20000">
                    <div class="redeem-option-amount">20.000 VNĐ</div>
                    <div class="redeem-option-points">20.000 điểm</div>
                </div>
            </div>
            <button class="redeem-confirm-btn" id="redeem-confirm-btn" disabled>ĐỔI NGAY</button>
        </div>
        
        <div class="reward-card" id="reward-card">
            <div class="reward-header">
                <div class="reward-logo">🎁</div>
                <div>
                    <div class="reward-title">THẺ QUÀ TẶNG</div>
                    <div class="reward-subtitle">Từ Hiếu Gà - Quay Là Có Quà</div>
                </div>
            </div>
            <div class="reward-value" id="reward-value">0 VNĐ</div>
            <div class="reward-info">Chúc mừng! Bạn đã đổi thành công điểm thưởng. Hãy tải về phiếu nhận thưởng và gửi cho Hiếu Gà để nhận thưởng</div>
            <div class="reward-image" id="reward-image">
                <img src="https://thietkehaithanh.com/wp-content/uploads/2018/12/in-voucher-1.jpg" alt="Hình ảnh mẫu" />
            </div>
            <div class="reward-footer">
                <div class="reward-date" id="reward-date">30/04/2025</div>
            </div>
            <div class="reward-watermark">SỰ KIỆN 30/4 HIẾU GÀ OFFICIAL</div>
            <button class="save-btn" id="save-reward-btn">XEM PHIẾU NHẬN THƯỞNG</button>
        </div>
        
        <div class="leaderboard">
            <div class="leaderboard-title">Bảng xếp hạng</div>
            <ul class="leaderboard-list" id="leaderboard-list">
                <!-- Leaderboard items will be added dynamically -->
                <li class="leaderboard-item">
                    <div class="spinner"></div>
                </li>
            </ul>
            <div class="leaderboard-status" id="leaderboard-status">Đang tải dữ liệu...</div>
            <div class="name-input">
                <input type="text" id="player-name" placeholder="Nhập tên của bạn">
                <button id="save-name-btn">Lưu</button>
            </div>
            <div class="user-id-hidden" id="user-id-container"></div>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2025 Bánh Xe Hiếu Gà - Quay Là Có Quà!</p>
        <p>Chào mừng ngày Giải phóng miền Nam 30/4</p>
    </div>
    
    <!-- Jackpot overlay -->
    <div class="jackpot-overlay" id="jackpot-overlay">
        <div class="jackpot-content">
            <div class="jackpot-title">🎉 JACKPOT! 🎉</div>
            <div>Bạn đã trúng JACKPOT đặc biệt!</div>
            <div class="jackpot-points" id="jackpot-points">+1000 điểm</div>
            <button class="jackpot-close" id="jackpot-close">TUYỆT VỜI!</button>
        </div>
    </div>
    
    <!-- Name registration overlay -->
    <div class="name-registration-overlay" id="name-registration-overlay" style="display: none;">
        <div class="name-registration-content">
            <div class="name-registration-title">Chào mừng bạn!</div>
            <div class="name-registration-subtitle">Vui lòng nhập tên của bạn để bắt đầu chơi và xuất hiện trên bảng xếp hạng.</div>
            <div class="name-registration-error" id="name-registration-error">Vui lòng nhập tên của bạn</div>
            <input type="text" class="name-registration-input" id="name-registration-input" placeholder="Nhập tên của bạn...">
            <button class="name-registration-button" id="name-registration-button">BẮT ĐẦU CHƠI</button>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Constants
        const API_BASE_URL = '/api';
        const MAX_SPINS = 50;
        const REFRESH_TIME_MS = 1800000; // 30 minutes
        const MAX_RETRY_ATTEMPTS = 3;
        const SYNC_INTERVAL = 30000; // Sync every 30 seconds
        
        // Sound effects
        const SOUNDS = {
            spin: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1925.mp3'],
                volume: 0.5
            }),
            win: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'],
                volume: 0.5
            }),
            jackpot: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-casino-win-notification-1980.mp3'],
                volume: 0.7
            }),
            lose: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-losing-bleeps-2026.mp3'],
                volume: 0.4
            }),
            click: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-simple-click-tone-1112.mp3'],
                volume: 0.3
            }),
            reward: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'],
                volume: 0.5
            })
        };
        
        // Game config
        const wheelSections = [
            { name: "Thắng lợi vẻ vang", icon: "🏆", points: 40, probability: 0.05 },
            { name: "Nhận gạo cứu trợ", icon: "🍚", points: 15, probability: 0.13 },
            { name: "Cưỡi xe tăng tiến vào dinh", icon: "🪖", points: 60, probability: 0.05 },
            { name: "Chụp ảnh ở Sài Gòn 1975", icon: "📸", points: 25, probability: 0.10 },
            { name: "Treo cờ thống nhất", icon: "🚩", points: 20, probability: 0.12 },
            { name: "Mất lượt", icon: "❌", points: 0, loseTurn: true, probability: 0.10 },
            { name: "Quà tặng bất ngờ", icon: "🎁", points: 0, randomCard: true, probability: 0.08 },
            { name: "Pháo hoa giải phóng", icon: "🎆", points: 10, extraSpin: true, probability: 0.07 },
            { name: "Lá cờ giải phóng", icon: "🚩", points: 80, probability: 0.04 },
            { name: "Bị kẹt đường vì xe tăng", icon: "🚧", points: -25, probability: 0.10 },
            { name: "Bị đánh thức bởi loa phường", icon: "🔊", points: -35, probability: 0.08 },
            { name: "Nhận đôi biếm ở lượt sau", icon: "👨‍🚀", points: 0, doubleNext: true, probability: 0.08 },
            // Jackpot prizes with low probability
            { name: "JACKPOT ĐẶC BIỆT", icon: "💰", points: 100, jackpot: true, probability: 0.001 },
            { name: "JACKPOT LỚN", icon: "💎", points: 150, jackpot: true, probability: 0.0005 }
        ];

        // DOM elements
        const wheel = document.getElementById('wheel');
        const wheelDots = document.getElementById('wheel-dots');
        const spinBtn = document.getElementById('spin-btn');
        const pointsValue = document.getElementById('points-value');
        const spinsValue = document.getElementById('spins-value');
        const timerValue = document.getElementById('timer-value');
        const refreshSpinsButton = document.getElementById('refresh-spins-button');
        const resultContainer = document.getElementById('result');
        const redeemSection = document.getElementById('redeem-section');
        const redeemOptions = document.querySelectorAll('.redeem-option');
        const redeemConfirmBtn = document.getElementById('redeem-confirm-btn');
        const rewardCard = document.getElementById('reward-card');
        const rewardValue = document.getElementById('reward-value');
        const rewardImage = document.getElementById('reward-image');
        const rewardDate = document.getElementById('reward-date');
        const saveRewardBtn = document.getElementById('save-reward-btn');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardStatus = document.getElementById('leaderboard-status');
        const playerNameInput = document.getElementById('player-name');
        const saveNameBtn = document.getElementById('save-name-btn');
        const userIdContainer = document.getElementById('user-id-container');
        const jackpotOverlay = document.getElementById('jackpot-overlay');
        const jackpotPoints = document.getElementById('jackpot-points');
        const jackpotClose = document.getElementById('jackpot-close');
        const notification = document.getElementById('notification');
        const nameRegistrationOverlay = document.getElementById('name-registration-overlay');
        const nameRegistrationInput = document.getElementById('name-registration-input');
        const nameRegistrationButton = document.getElementById('name-registration-button');
        const nameRegistrationError = document.getElementById('name-registration-error');
        const globalSpinner = document.getElementById('global-spinner');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        // Countdown elements
        const daysValue = document.getElementById('days-value');
        const hoursValue = document.getElementById('hours-value');
        const minutesValue = document.getElementById('minutes-value');
        const secondsValue = document.getElementById('seconds-value');

        // Game state
        let points = 0;
        let spinsLeft = MAX_SPINS;
        let isSpinning = false;
        let nextSpinDouble = false;
        let refreshTimer;
        let countdownTimer;
        let syncTimer;
        let playerName = '';
        let selectedRedeemOption = null;
        let isEventEnded = false;
        let userId = '';
        let lastWheelRotation = 0;
        let currentSections = [];
        let customPosterImage = null;
        let lastSpinRefreshTime = 0;
        let nextRefreshTime = 0;
        let isSaving = false;
        let dataLoaded = false;
        let retryCount = 0;
        let isOnline = navigator.onLine;
        
        // Initialize the game
        window.addEventListener('load', initGame);
        
        // Setup online/offline detection
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOfflineStatus);
        
      // Thay đổi trong hàm initGame để kiểm tra kết nối máy chủ trước
async function initGame() {
    try {
        console.log("Khởi tạo game...");
        
        // Đặt trạng thái là đang tải
        showLoadingState(true, "Đang kết nối với máy chủ...");
        
        // Thiết lập userId trước
        setupUserId();
        
        // Tạo bánh xe và các thiết lập UI
        createWheel();
        setupUIEvents();
        
        // Kiểm tra kết nối máy chủ
        try {
            const healthCheck = await fetch(`${API_BASE_URL}/health`, { 
                timeout: 5000,
                cache: 'no-cache'
            });
            
            if (!healthCheck.ok) {
                throw new Error('Kiểm tra kết nối máy chủ thất bại');
            }
            
            const healthData = await healthCheck.json();
            console.log("Trạng thái máy chủ:", healthData);
            
            if (!healthData.dbConnected) {
                console.warn("Cơ sở dữ liệu chưa được kết nối, có thể gặp vấn đề khi lưu dữ liệu");
                showNotification("Máy chủ đang khởi động, có thể gặp vấn đề khi lưu dữ liệu", 5000);
            }
        } catch (error) {
            console.error("Không thể kiểm tra trạng thái máy chủ:", error);
            showNotification("Không thể kiểm tra trạng thái máy chủ, tiếp tục với tính năng giới hạn", 5000);
        }
        
        // Tải dữ liệu từ máy chủ với retry
        await loadDataFromServerWithRetry();
        
        // Khởi động các bộ đếm thời gian
        startRefreshTimer();
        startEventCountdown();
        startSyncTimer();
        
        // Tải bảng xếp hạng sau khi dữ liệu đã được tải
        await loadLeaderboard();
        
        // Bật nút quay sau khi dữ liệu đã được tải
        spinBtn.disabled = false;
        
        // Ẩn trạng thái đang tải
        showLoadingState(false);
        
        // Đặt trạng thái là trực tuyến
        updateStatus('online', 'Đã kết nối');
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 3000);
        
        // Hiển thị thông báo
        showNotification("Đã kết nối với máy chủ thành công!");
        
        // Đăng ký tự động lưu trước khi rời trang
        window.addEventListener('beforeunload', () => {
            saveGameState(true); // Lưu ngay lập tức
        });
        
        // Thiết lập xử lý khi tab thay đổi hiển thị
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log("Tab trở thành hiển thị, đồng bộ dữ liệu...");
                syncWithServer();
            }
        });
        
        // Kiểm tra xem đăng ký tên là cần thiết
        checkNameRegistration();
        
    } catch (error) {
        console.error("Lỗi khởi tạo game:", error);
        handleInitError("Không thể kết nối với máy chủ. Vui lòng thử lại sau.");
    }
}
        // Hiển thị trạng thái đang tải
function showLoadingState(show, message = "Đang tải...") {
    if (show) {
        globalSpinner.style.display = 'flex';
        document.querySelector('.global-spinner-text').textContent = message;
    } else {
        globalSpinner.style.display = 'none';
    }
}

// Thêm hàm kiểm tra trạng thái máy chủ riêng
async function checkServerStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`, { 
            timeout: 5000,
            cache: 'no-cache'
        });
        
        if (!response.ok) return false;
        
        const data = await response.json();
        return data.status === 'ok' && data.dbConnected;
    } catch (e) {
        console.error("Lỗi kiểm tra trạng thái máy chủ:", e);
        return false;
    }
}
        
        // Load data from server with retry mechanism
        async function loadDataFromServerWithRetry() {
            retryCount = 0;
            let delay = 1000; // Start with 1 second delay
            
            while (retryCount < MAX_RETRY_ATTEMPTS) {
                try {
                    updateStatus('syncing', `Đang kết nối (lần ${retryCount + 1})...`);
                    await loadDataFromServer();
                    
                    // If successful, return
                    console.log("Data loaded successfully");
                    dataLoaded = true;
                    return;
                } catch (error) {
                    retryCount++;
                    console.error(`Attempt ${retryCount} failed:`, error);
                    
                    if (retryCount >= MAX_RETRY_ATTEMPTS) {
                        throw new Error("Maximum retry attempts reached");
                    }
                    
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Double the delay for next attempt
                }
            }
        }
        
      // Thay đổi trong hàm loadDataFromServer để thêm phục hồi từ bản sao lưu
async function loadDataFromServer() {
    if (!userId) {
        console.log("Không có userId, bỏ qua tải dữ liệu");
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/getScore?userId=${userId}`);
        
        if (response.status === 404) {
            console.log("Không tìm thấy người chơi trên máy chủ");
            
            // Thử khôi phục từ bản sao lưu trước
            if (tryRestoreFromBackup()) {
                console.log("Đã khôi phục từ bản sao lưu, đang lưu lên server");
                await saveGameState(true);
                return;
            }
            
            // Nếu không có bản sao lưu, sử dụng giá trị mặc định
            console.log("Sử dụng giá trị mặc định");
            points = 0;
            spinsLeft = MAX_SPINS;
            nextSpinDouble = false;
            lastSpinRefreshTime = Date.now();
            nextRefreshTime = lastSpinRefreshTime + REFRESH_TIME_MS;
            
            // Lưu trạng thái ban đầu lên server
            await saveGameState(true);
            return;
        }
        
        if (!response.ok) {
            throw new Error(`Lỗi máy chủ: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Dữ liệu nhận từ server:", data);
        
        // Cập nhật trạng thái game từ dữ liệu server
        points = data.score || 0;
        spinsLeft = data.spinsLeft !== undefined ? data.spinsLeft : MAX_SPINS;
        nextSpinDouble = data.nextSpinDouble || false;
        lastSpinRefreshTime = data.lastSpinRefreshTime || Date.now();
        nextRefreshTime = data.nextRefreshTime || (lastSpinRefreshTime + REFRESH_TIME_MS);
        lastWheelRotation = data.wheelRotation || 0;
        
        // Nếu tên người chơi chưa được thiết lập nhưng có trong dữ liệu, sử dụng nó
        if ((!playerName || playerName === '') && data.name) {
            playerName = data.name;
            playerNameInput.value = playerName;
            localStorage.setItem('playerName', playerName);
        }
        
        // Cập nhật UI
        updateStats();
        showNotification("Đã tải dữ liệu từ máy chủ thành công", 2000);
        
    } catch (error) {
        console.error("Lỗi khi tải dữ liệu từ máy chủ:", error);
        
        // Thử khôi phục từ bản sao lưu nếu không thể kết nối server
        if (tryRestoreFromBackup()) {
            showNotification("Đã khôi phục dữ liệu từ bản sao lưu cục bộ", 3000);
        } else {
            showNotification("Không thể tải dữ liệu từ máy chủ", 3000);
        }
        
        throw error; // Ném lỗi để xử lý ở nơi gọi hàm
    }
}
        
        // Setup user ID
        function setupUserId() {
            userId = localStorage.getItem('wheelGameUserId');
            if (!userId) {
                userId = generateUniqueId();
                localStorage.setItem('wheelGameUserId', userId);
            }
            userIdContainer.textContent = userId;
        }
        
        // Generate unique ID
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 10);
        }
        
        // Check if name registration is needed
        function checkNameRegistration() {
            // Get from localStorage first
            const savedName = localStorage.getItem('playerName');
            
            if (savedName) {
                playerName = savedName;
                playerNameInput.value = savedName;
                nameRegistrationOverlay.style.display = 'none';
            } else {
                // Show name registration overlay
                nameRegistrationOverlay.style.display = 'flex';
            }
        }
        
        // Setup UI events
        function setupUIEvents() {
            // Spin button
            spinBtn.addEventListener('click', spinWheel);
            
            // Redeem options
            redeemOptions.forEach(option => {
                option.addEventListener('click', handleRedeemOptionClick);
            });
            
            // Redeem confirm button
            redeemConfirmBtn.addEventListener('click', redeemPoints);
            
            // Save reward button
            saveRewardBtn.addEventListener('click', saveRewardPoster);
            
            // Save name button
            saveNameBtn.addEventListener('click', savePlayerName);
            
            // Refresh spins button
            refreshSpinsButton.addEventListener('click', checkAndRefreshSpins);
            
            // Jackpot close button
            jackpotClose.addEventListener('click', () => {
                jackpotOverlay.classList.remove('show');
            });
            
            // Name registration button
            nameRegistrationButton.addEventListener('click', handleNameRegistration);
            nameRegistrationInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleNameRegistration();
                }
            });
        }
        
        // Handle redeem option click
        function handleRedeemOptionClick() {
            if (isEventEnded) return;
            SOUNDS.click.play();
            
            const requiredPoints = parseInt(this.getAttribute('data-points'));
            
            if (points >= requiredPoints) {
                // Deselect all options
                redeemOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Select this option
                this.classList.add('selected');
                selectedRedeemOption = this;
                
                // Enable confirm button
                redeemConfirmBtn.disabled = false;
            } else {
                showResult('⚠️', `Bạn cần ít nhất ${requiredPoints} điểm để đổi phần thưởng này!`);
                anime({
                    targets: this,
                    translateX: [
                        { value: -5, duration: 50 },
                        { value: 5, duration: 50 },
                        { value: -5, duration: 50 },
                        { value: 5, duration: 50 },
                        { value: 0, duration: 50 }
                    ]
                });
            }
        }
        
        // Handle name registration
        function handleNameRegistration() {
            const name = nameRegistrationInput.value.trim();
            if (name.length < 2) {
                nameRegistrationError.style.display = 'block';
                nameRegistrationError.textContent = 'Vui lòng nhập tên có ít nhất 2 ký tự';
                nameRegistrationInput.focus();
                return;
            }
            
            playerName = name;
            localStorage.setItem('playerName', name);
            playerNameInput.value = name;
            nameRegistrationOverlay.style.display = 'none';
            
            // Save to API
            saveGameState();
            
            showNotification(`Chào mừng ${name} đến với Bánh Xe Hiếu Gà!`);
            SOUNDS.click.play();
        }
        
        // Start sync timer
        function startSyncTimer() {
            // Clear any existing timer
            if (syncTimer) clearInterval(syncTimer);
            
            // Sync every 30 seconds
            syncTimer = setInterval(() => {
                if (isOnline) {
                    syncWithServer();
                }
            }, SYNC_INTERVAL);
        }
        
        // Sync with server
        async function syncWithServer() {
            if (!isOnline || isSaving) return;
            
            try {
                updateStatus('syncing', 'Đang đồng bộ...');
                
                // Get latest data from server
                await loadDataFromServer();
                
                // Check if spins need to be refreshed
                await checkSpinsWithServer();
                
                // Update status
                updateStatus('online', 'Đã đồng bộ');
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error("Error syncing with server:", error);
                updateStatus('error', 'Lỗi đồng bộ');
            }
        }
        
        // Create the wheel
        function createWheel() {
            // Clear existing sections
            wheel.innerHTML = '';
            wheelDots.innerHTML = '';
            
            // Use only 12 sections for the wheel
            const sectionsPool = wheelSections.slice(); // Clone the array
            const numSections = 12; // Fixed number of sections
            
            // Initialize the wheel sections array
            let sectionsToUse = [];
            
            // Calculate total probability for normalization
            const totalProbability = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
            
            // Select the sections weighted by their probability
            for (let i = 0; i < numSections; i++) {
                // Normalize probabilities for the remaining pool
                const remainingTotal = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
                
                let random = Math.random() * remainingTotal;
                let cumulativeProbability = 0;
                let selectedIndex = 0;
                
                for (let j = 0; j < sectionsPool.length; j++) {
                    cumulativeProbability += sectionsPool[j].probability;
                    if (random <= cumulativeProbability) {
                        selectedIndex = j;
                        break;
                    }
                }
                
                // Add the selected section to our wheel and remove from the pool
                sectionsToUse.push(sectionsPool[selectedIndex]);
                sectionsPool.splice(selectedIndex, 1);
            }
            
            // Create wheel sections
            for (let i = 0; i < numSections; i++) {
                const section = sectionsToUse[i];
                const rotationAngle = (i * 360 / numSections);
                
                // Create section element
                const sectionElement = document.createElement('div');
                sectionElement.className = 'wheel-section';
                sectionElement.style.transform = `rotate(${rotationAngle}deg)`;
                sectionElement.dataset.index = i; // Store the index for reference
                
                // Position and style the section
                const sectionContent = document.createElement('div');
                sectionContent.className = 'wheel-section-content';
                
                // Create icon
                const iconElement = document.createElement('div');
                iconElement.className = 'wheel-section-icon';
                iconElement.textContent = section.icon;
                
                // Highlight jackpot sections with glow effect
                if (section.jackpot) {
                    iconElement.style.fontSize = '28px';
                    iconElement.style.filter = 'drop-shadow(0 0 5px gold)';
                    sectionElement.style.background = 'linear-gradient(135deg, #fff9c4 0%, #f0d6a3 100%)';
                }
                
                // Create text
                const textElement = document.createElement('div');
                textElement.className = 'wheel-section-text';
                textElement.textContent = section.name;
                
                // Assemble the section
                sectionContent.appendChild(iconElement);
                sectionContent.appendChild(textElement);
                sectionElement.appendChild(sectionContent);
                wheel.appendChild(sectionElement);
            }
            
            // Add dots around the wheel (24 dots)
            const dotsCount = 24;
            const radius = 48.5; // Percentage of wheel radius
            
            for (let i = 0; i < dotsCount; i++) {
                const angle = (i * 360 / dotsCount) * (Math.PI / 180);
                const x = 50 + radius * Math.cos(angle);
                const y = 50 + radius * Math.sin(angle);
                
                const dot = document.createElement('div');
                dot.className = 'wheel-dot';
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                wheelDots.appendChild(dot);
            }
            
            // Store the current sections
            currentSections = sectionsToUse;
        }
        
        // Thay đổi trong hàm spinWheel để đảm bảo lưu trạng thái sau mỗi lần quay
function spinWheel() {
    if (isSpinning || spinsLeft <= 0 || isEventEnded || !dataLoaded) return;
    
    // Kiểm tra nếu tên người chơi chưa được thiết lập
    if (!playerName || playerName.trim() === '') {
        showNameRegistrationOverlay();
        showNotification("Vui lòng nhập tên trước khi quay!", 3000);
        return;
    }
    
    SOUNDS.spin.play();
    
    isSpinning = true;
    spinsLeft--;
    updateStats();
    
    // Xác định phần thưởng đã được chọn
    const numSections = currentSections.length;
    let winningIndex = Math.floor(Math.random() * numSections);
    const winningSection = currentSections[winningIndex];
    
    // Tính góc quay để rơi vào phần thưởng đã chọn
    const sectionAngle = 360 / numSections;
    const targetAngle = 360 - (winningIndex * sectionAngle) - (sectionAngle / 2);
    
    // Đảm bảo quay đủ vòng (ít nhất 2 vòng) cộng với góc mục tiêu
    const fullRotations = 2 * 360;
    const destinationAngle = fullRotations + targetAngle;
    
    // Xóa chuyển động hiện có
    wheel.style.transition = 'none';
    wheel.offsetHeight; // Force reflow
    wheel.style.transform = `rotate(${lastWheelRotation}deg)`;
    wheel.offsetHeight; // Force reflow lại
    
    // Bây giờ thêm chuyển động và quay đến đích
    wheel.style.transition = 'transform 3s cubic-bezier(0.17, 0.89, 0.24, 1.0)';
    wheel.style.transform = `rotate(${destinationAngle}deg)`;
    
    // Thêm hiệu ứng trực quan trong quá trình quay
    anime({
        targets: '.wheel-pointer',
        scale: [1, 1.2, 1, 1.2, 1],
        opacity: [1, 0.8, 1, 0.8, 1],
        duration: 3000,
        easing: 'easeInOutQuad'
    });
    
    // Lưu góc quay hiện tại cho lần quay tiếp theo
    lastWheelRotation = destinationAngle % 360;
    
    // Tắt nút quay trong khi đang quay
    spinBtn.disabled = true;
    
    // Sau khi hoàn thành hoạt ảnh quay
    setTimeout(() => {
        isSpinning = false;
        spinBtn.disabled = false;
        processResult(winningSection);
        
        // Lưu trạng thái ngay sau khi quay, với nhiều lần thử lại
        saveGameStateWithLoading();
    }, 3000);
}
        // Thêm hàm lưu trạng thái với hiển thị trạng thái đang tải
async function saveGameStateWithLoading() {
    // Hiển thị trạng thái đang lưu
    updateStatus('syncing', 'Đang lưu...');
    
    try {
        await saveGameState(true); // Lưu trạng thái ngay lập tức
        updateStatus('online', 'Đã lưu');
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 2000);
    } catch (error) {
        console.error("Lỗi lưu trạng thái:", error);
        updateStatus('error', 'Lỗi lưu');
        showNotification("Không thể lưu trạng thái. Đang thử lại...", 3000);
        
        // Thử lại sau 3 giây
        setTimeout(async () => {
            try {
                await saveGameState(true);
                updateStatus('online', 'Đã lưu');
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 2000);
            } catch (retryError) {
                console.error("Lỗi khi thử lại lưu trạng thái:", retryError);
                updateStatus('error', 'Lỗi lưu');
                showNotification("Vẫn không thể lưu trạng thái. Vui lòng kiểm tra kết nối mạng.", 5000);
            }
        }, 3000);
    }
}
        // Hiển thị overlay đăng ký tên
function showNameRegistrationOverlay() {
    nameRegistrationOverlay.style.display = 'flex';
}
        
        // Process the result after spinning
        function processResult(section) {
            let pointsEarned = section.points;
            let message = '';
            let isJackpot = false;
            
            // Apply double if applicable
            if (nextSpinDouble) {
                pointsEarned *= 2;
                nextSpinDouble = false;
                message += '<strong>Nhận đôi biếm kích hoạt!</strong> Điểm nhân đôi! ';
            }
            
            // Process special effects
            if (section.jackpot) {
                isJackpot = true;
                message += `<strong>JACKPOT ĐẶC BIỆT!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                SOUNDS.jackpot.play();
                
                // Show jackpot overlay
                jackpotPoints.textContent = `+${pointsEarned} điểm`;
                setTimeout(() => {
                    jackpotOverlay.classList.add('show');
                }, 500);
            } else if (section.extraSpin) {
                // Add spin with limit check
                if (spinsLeft < MAX_SPINS) {
                    spinsLeft++;
                }
                updateStats();
                message += `<strong>${section.name}!</strong> Bạn nhận được thêm 1 lượt quay! `;
                SOUNDS.win.play();
            } else if (section.loseTurn) {
                message += `<strong>${section.name}!</strong> Thật tiếc, bạn mất lượt này. `;
                SOUNDS.lose.play();
            } else if (section.randomCard) {
                // Random card gives points between 10-90
                const randomPoints = Math.floor(Math.random() * 81) + 10;
                pointsEarned = randomPoints;
                message += `<strong>${section.name}!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                SOUNDS.win.play();
            } else if (section.doubleNext) {
                nextSpinDouble = true;
                message += `<strong>${section.name}!</strong> Lượt quay tiếp theo sẽ được nhân đôi điểm! `;
                SOUNDS.win.play();
            } else {
                if (pointsEarned > 0) {
                    message += `<strong>${section.name}!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                    SOUNDS.win.play();
                } else if (pointsEarned < 0) {
                    message += `<strong>${section.name}!</strong> Bạn mất ${Math.abs(pointsEarned)} điểm! `;
                    SOUNDS.lose.play();
                } else {
                    message += `<strong>${section.name}!</strong> `;
                    SOUNDS.click.play();
                }
            }
            
            // Update points
            points += pointsEarned;
            if (points < 0) points = 0;
            updateStats();
            
            // Highlight the points value with animation
            if (pointsEarned !== 0) {
                const pointsElement = document.getElementById('points-value');
                pointsElement.classList.remove('pulse');
                void pointsElement.offsetWidth; // Force reflow
                pointsElement.classList.add('pulse');
            }
            
            // Show the result with enhanced effects
            showResult(section.icon, message, pointsEarned, isJackpot);
            
            // Show celebration for big wins
            if (pointsEarned >= 60 || isJackpot) {
                createConfetti(pointsEarned >= 500 ? 200 : 50);
            }
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update redeem button state
            updateRedeemButtonState();
        }
        
        // Show the result message with enhanced effects
        function showResult(icon, message, pointsEarned = 0, isJackpot = false) {
            let resultHtml = `
                <div class="result-title">${isJackpot ? '🎊 JACKPOT! 🎊' : 'Kết quả quay thưởng'}</div>
                <div class="result-icon">${icon}</div>
                <div class="result-message">${message}</div>
            `;
            
            resultContainer.innerHTML = resultHtml;
            resultContainer.classList.remove('bounce', 'highlight', 'shake');
            void resultContainer.offsetWidth; // Force reflow
            
            // Apply different effects based on result
            if (isJackpot) {
                resultContainer.classList.add('highlight');
                resultContainer.classList.add('bounce');
            } else if (pointsEarned > 0) {
                resultContainer.classList.add('highlight');
            } else if (pointsEarned < 0) {
                resultContainer.classList.add('shake');
            } else {
                resultContainer.classList.add('bounce');
            }
        }
        
        // Create enhanced confetti effect
        function createConfetti(count = 50) {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#fff', '#fd0'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `-20px`;
                confetti.style.width = `${5 + Math.random() * 10}px`;
                confetti.style.height = `${5 + Math.random() * 10}px`;
                confetti.style.opacity = '1';
                document.body.appendChild(confetti);
                
                // Add more variety to confetti
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                } else {
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
                
                // Animate the confetti with more variety
                const duration = 1 + Math.random() * 3;
                const delay = Math.random() * 1;
                
                // Use anime.js for more complex animation
                anime({
                    targets: confetti,
                    translateY: window.innerHeight + 100,
                    translateX: [
                        { value: -50 + Math.random() * 100, duration: duration * 500 },
                        { value: -100 + Math.random() * 200, duration: duration * 500 }
                    ],
                    rotate: Math.random() * 720,
                    opacity: [
                        { value: 1, duration: duration * 400 },
                        { value: 0, duration: duration * 600 }
                    ],
                    delay: delay * 1000,
                    easing: 'easeOutQuad',
                    complete: function() {
                        if (document.body.contains(confetti)) {
                            document.body.removeChild(confetti);
                        }
                    }
                });
            }
        }
        
        // Update redeem button state
        function updateRedeemButtonState() {
            const hasEnoughPoints = Array.from(redeemOptions).some(option => {
                const requiredPoints = parseInt(option.getAttribute('data-points'));
                return points >= requiredPoints;
            });
            
            // If no option is selected but points are enough for at least one option, highlight the button
            if (!selectedRedeemOption && hasEnoughPoints) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'CHỌN MỘT MỨC';
                redeemConfirmBtn.classList.add('pulse');
            } else if (selectedRedeemOption) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'ĐỔI NGAY';
                redeemConfirmBtn.classList.remove('pulse');
            } else {
                redeemConfirmBtn.disabled = true;
                redeemConfirmBtn.textContent = 'KHÔNG ĐỦ ĐIỂM';
                redeemConfirmBtn.classList.remove('pulse');
            }
        }
        
        // Update game statistics display
        function updateStats() {
            pointsValue.textContent = points;
            spinsValue.textContent = spinsLeft;
            
            // Also update redeem button state
            updateRedeemButtonState();
        }
        
        // Start refresh timer
        function startRefreshTimer() {
            // First update once
            updateRefreshTimer();
            
            // Clear any existing timer
            if (refreshTimer) clearInterval(refreshTimer);
            
            // Update every second
            refreshTimer = setInterval(updateRefreshTimer, 1000);
        }
        
        // Update refresh timer display
        function updateRefreshTimer() {
            const now = new Date().getTime();
            
            // Make sure nextRefreshTime is set
            if (!nextRefreshTime || nextRefreshTime <= now) {
                // Calculate next refresh time
                nextRefreshTime = lastSpinRefreshTime + REFRESH_TIME_MS;
            }
            
            // Calculate time left
            let timeLeft = nextRefreshTime - now;
            
            if (timeLeft <= 0) {
                // Time to refresh spins
                checkAndRefreshSpins(true);
                return;
            }
            
            // Display time left
            const minutes = Math.floor((timeLeft / 1000) / 60);
            const seconds = Math.floor((timeLeft / 1000) % 60);
            timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Check and refresh spins (can be called manually or automatically)
        async function checkAndRefreshSpins(automatic = false) {
            try {
                if (!automatic) {
                    SOUNDS.click.play();
                    showNotification("Đang kiểm tra lượt quay...");
                }
                
                if (isOnline) {
                    // Try to refresh with server
                    await checkSpinsWithServer();
                } else {
                    // If offline, check locally
                    const now = new Date().getTime();
                    
                    if (now >= nextRefreshTime) {
                        // Time to refresh
                        refreshSpins();
                    } else {
                        // Not time yet
                        const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                        const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                        showNotification(`Chưa đến thời gian làm mới. Còn ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                    }
                }
            } catch (error) {
                console.error("Error checking spins:", error);
                showNotification("Lỗi khi kiểm tra lượt quay.");
            }
        }
        
        // Check spins with server
        async function checkSpinsWithServer() {
            try {
                updateStatus('syncing', 'Đang kiểm tra lượt quay...');
                
                const response = await fetch(`${API_BASE_URL}/checkSpins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.refreshed) {
                    // Server refreshed spins
                    spinsLeft = data.player.spinsLeft;
                    lastSpinRefreshTime = data.player.lastSpinRefreshTime;
                    nextRefreshTime = data.player.nextRefreshTime;
                    
                    // Update UI
                    updateStats();
                    showNotification("Lượt quay đã được làm mới! +50 lượt quay");
                    
                    // Show animation on spins value
                    spinsValue.classList.add('glow');
                    setTimeout(() => {
                        spinsValue.classList.remove('glow');
                    }, 3000);
                    
                    updateStatus('online', 'Đã làm mới lượt quay');
                    
                    return true;
                } else {
                    // No refresh needed
                    const now = new Date().getTime();
                    const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                    const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                    
                    if (minutes >= 0 && seconds >= 0) {
                        showNotification(`Chưa đến thời gian làm mới. Còn ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                    } else {
                        // Force refresh if time is negative
                        await forceRefreshSpins();
                    }
                    
                    updateStatus('online', 'Đã kiểm tra lượt quay');
                    
                    return false;
                }
                
            } catch (error) {
                console.error("Error checking spins with server:", error);
                showNotification("Lỗi khi kiểm tra lượt quay với máy chủ.");
                return false;
            }
        }
        
        // Force refresh spins
        async function forceRefreshSpins() {
            try {
                updateStatus('syncing', 'Đang làm mới lượt quay...');
                
                const response = await fetch(`${API_BASE_URL}/refreshSpins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update with server data
                spinsLeft = data.player.spinsLeft;
                lastSpinRefreshTime = data.player.lastSpinRefreshTime;
                nextRefreshTime = data.player.nextRefreshTime;
                
                // Update UI
                updateStats();
                showNotification("Lượt quay đã được làm mới! +50 lượt quay");
                
                // Show animation on spins value
                spinsValue.classList.add('glow');
                setTimeout(() => {
                    spinsValue.classList.remove('glow');
                }, 3000);
                
                updateStatus('online', 'Đã làm mới lượt quay');
                
                return true;
            } catch (error) {
                console.error("Error forcing refresh:", error);
                showNotification("Lỗi khi làm mới lượt quay.");
                return false;
            }
        }
        
        // Refresh spins locally
        function refreshSpins() {
            const now = new Date().getTime();
            
            // Refresh to max spins
            spinsLeft = MAX_SPINS;
            
            // Update refresh times
            lastSpinRefreshTime = now;
            nextRefreshTime = now + REFRESH_TIME_MS;
            
            // Update UI
            updateStats();
            
            // Show notification
            showNotification("Lượt quay đã được làm mới! +50 lượt quay");
            
            // Show animation on spins value
            spinsValue.classList.add('glow');
            setTimeout(() => {
                spinsValue.classList.remove('glow');
            }, 3000);
            
            // Save state
            saveGameState();
        }
        
        // Start event countdown timer
        function startEventCountdown() {
            const endDate = new Date('2025-05-01T00:00:00');
            
            function updateCountdown() {
                const now = new Date();
                const timeDiff = endDate - now;
                
                if (timeDiff <= 0) {
                    // Event ended
                    daysValue.textContent = '00';
                    hoursValue.textContent = '00';
                    minutesValue.textContent = '00';
                    secondsValue.textContent = '00';
                    
                    isEventEnded = true;
                    spinBtn.disabled = true;
                    spinBtn.textContent = 'SỰ KIỆN ĐÃ KẾT THÚC';
                    
                    clearInterval(countdownTimer);
                    return;
                }
                
                // Calculate days, hours, minutes, seconds
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                // Update UI
                daysValue.textContent = String(days).padStart(2, '0');
                hoursValue.textContent = String(hours).padStart(2, '0');
                minutesValue.textContent = String(minutes).padStart(2, '0');
                secondsValue.textContent = String(seconds).padStart(2, '0');
                
                // Add pulse effect when time is running low (last 24 hours)
                if (days === 0 && hours < 24) {
                    document.querySelectorAll('.countdown-value').forEach(el => {
                        el.classList.add('glow');
                    });
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            clearInterval(countdownTimer); // Clear any existing timer
            countdownTimer = setInterval(updateCountdown, 1000);
        }
        
        // Redeem points for rewards
        function redeemPoints() {
            if (!selectedRedeemOption) {
                showResult('⚠️', 'Vui lòng chọn một mức quy đổi!');
                return;
            }
            
            SOUNDS.reward.play();
            
            const amount = parseInt(selectedRedeemOption.getAttribute('data-amount'));
            const requiredPoints = parseInt(selectedRedeemOption.getAttribute('data-points'));
            
            if (points < requiredPoints) {
                showResult('⚠️', `Bạn cần ít nhất ${requiredPoints} điểm để đổi phần thưởng này!`);
                return;
            }
            
            // Deduct points
            points -= requiredPoints;
            updateStats();
            
            // Create reward poster
            generateRewardPoster(amount);
            
            // Update reward card
            rewardValue.textContent = `${amount.toLocaleString()} VNĐ`;
            rewardDate.textContent = new Date().toLocaleDateString('vi-VN');

            // Show reward card with animation
            rewardCard.style.display = 'block';
            
            // Update button text
            saveRewardBtn.textContent = 'XEM PHIẾU NHẬN THƯỞNG';
            
            // Show reward card with animation
            anime({
                targets: '#reward-card',
                scale: [0.9, 1],
                opacity: [0, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            
            // Reset selection
            selectedRedeemOption.classList.remove('selected');
            selectedRedeemOption = null;
            redeemConfirmBtn.disabled = true;
            
            // Save state
            saveGameState();
            
            // Show success message
            showResult('🎁', `Chúc mừng! Bạn đã đổi thành công ${requiredPoints.toLocaleString()} điểm lấy ${amount.toLocaleString()} VNĐ.`);
            
            // Update redeem button state
            updateRedeemButtonState();
            
            // Create mini celebration
            createConfetti(20);
        }
        
        // Generate reward poster 
        function generateRewardPoster(amount) {
            // Create a canvas element
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            canvas.width = 600;
            canvas.height = 800;
            
            // Draw background
            ctx.fillStyle = '#fff9e6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw border
            ctx.strokeStyle = '#d82f2f';
            ctx.lineWidth = 10;
            ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
            
            // Draw header
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, 20, canvas.width - 40, 100);
            
            // Draw title
            ctx.font = 'bold 48px Arial';
            ctx.fillStyle = '#ffeb3b';
            ctx.textAlign = 'center';
            ctx.fillText('PHIẾU NHẬN THƯỞNG', canvas.width / 2, 80);
            
            // Draw amount
            ctx.font = 'bold 72px Arial';
            ctx.fillStyle = '#d82f2f';
            ctx.fillText(`${amount.toLocaleString()} VNĐ`, canvas.width / 2, 250);
            
            // Draw player name
            ctx.font = '36px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText(`Người nhận: ${playerName}`, canvas.width / 2, 350);
            
            // Draw date
            const date = new Date().toLocaleDateString('vi-VN');
            ctx.font = '24px Arial';
            ctx.fillText(`Ngày: ${date}`, canvas.width / 2, 400);
            
            // Draw QR code placeholder
            ctx.fillStyle = '#f1f1f1';
            ctx.fillRect(canvas.width / 2 - 100, 450, 200, 200);
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText('Mã QR Hiếu Gà', canvas.width / 2, 550);
            
            // Draw footer
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, canvas.height - 120, canvas.width - 40, 100);
            ctx.fillStyle = '#ffeb3b';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('HIẾU GÀ OFFICIAL', canvas.width / 2, canvas.height - 60);
            
            // Draw user ID in small text
            ctx.fillStyle = '#999';
            ctx.font = '12px Arial';
            ctx.fillText(`ID: ${userId}`, canvas.width / 2, canvas.height - 20);
            
            // Get image URL
            const imageUrl = canvas.toDataURL('image/png');
            
            // Set the reward image
            const img = rewardImage.querySelector('img');
            img.src = imageUrl;
            
            // Store for download
            customPosterImage = imageUrl;
        }
        
        // Save reward poster
        function saveRewardPoster() {
            SOUNDS.click.play();
            
            // Show poster overlay
            showPosterOverlay();
            
            // Show notification
            showNotification('Hãy chụp màn hình để lưu phiếu thưởng!');
        }
        
        // Show poster overlay
        function showPosterOverlay() {
            // Remove existing overlay if any
            const existingOverlay = document.querySelector('.poster-overlay');
            if (existingOverlay) {
                document.body.removeChild(existingOverlay);
            }
            
            // Create new overlay
            const overlay = document.createElement('div');
            overlay.className = 'poster-overlay';
            
            // Create poster container
            const posterContainer = document.createElement('div');
            posterContainer.className = 'poster-container';
            
            // Create screenshot hint
            const screenshotHint = document.createElement('div');
            screenshotHint.className = 'screenshot-hint';
            screenshotHint.innerHTML = '📷 Chụp màn hình ở đây';
            
            // Clone reward card
            const posterClone = rewardCard.cloneNode(true);
            posterClone.style.display = 'block';
            posterClone.style.width = '100%';
            posterClone.style.maxWidth = '400px';
            posterClone.style.margin = '0 auto';
            posterClone.style.boxShadow = '0 0 30px rgba(216, 47, 47, 0.5)';
            posterClone.style.background = 'linear-gradient(135deg, #ffffff, #fff9e6)';
            
            // Remove save button from clone
            const saveBtn = posterClone.querySelector('#save-reward-btn');
            if (saveBtn) saveBtn.remove();
            
            // Add poster and hint to container
            posterContainer.appendChild(screenshotHint);
            posterContainer.appendChild(posterClone);
            
            // Create instructions
            const instructions = document.createElement('div');
            instructions.className = 'poster-instructions';
            instructions.innerHTML = `
                <h3>🔴 Hướng dẫn nhận thưởng 🔴</h3>
                <p>Chụp màn hình phiếu nhận thưởng và gửi cho Hiếu Gà</p>
                <p>Lưu ý: Phiếu chỉ có giá trị khi gửi kèm tên đã đăng ký (${playerName})</p>
            `;
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'poster-buttons';
            
            // Add share button for Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                const shareButton = document.createElement('button');
                shareButton.className = 'poster-button share';
                shareButton.innerHTML = '<span>🚀 Gửi cho Hiếu Gà</span>';
                shareButton.addEventListener('click', function() {
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify({
                            action: 'reward_claimed',
                            amount: rewardValue.textContent,
                            user: playerName,
                            userId: userId,
                            date: rewardDate.textContent
                        }));
                        // Close overlay
                        document.body.removeChild(overlay);
                    } catch (e) {
                        console.error("Error sharing to Telegram", e);
                    }
                });
                buttonContainer.appendChild(shareButton);
            }
            
            // Add close button
            const closeButton = document.createElement('button');
            closeButton.className = 'poster-button close';
            closeButton.textContent = 'Đóng';
            closeButton.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);
            
            // Assemble all components
            overlay.appendChild(posterContainer);
            overlay.appendChild(instructions);
            overlay.appendChild(buttonContainer);
            
            // Add to body
            document.body.appendChild(overlay);
            
            // Apply animation effect
            setTimeout(() => {
                posterContainer.style.transform = 'scale(1)';
            }, 50);
        }
        
    // Cập nhật phần saveGameState với nhiều retry và logging tốt hơn
async function saveGameState(forceImmediate = false) {
    if (isSaving && !forceImmediate) {
        console.log("Đang có một lưu trữ đang chạy, bỏ qua");
        return;
    }
    
    try {
        isSaving = true;
        
        // Kiểm tra nếu tên người chơi chưa được thiết lập
        if (!playerName || playerName.trim() === '') {
            console.log("Tên người chơi chưa được thiết lập, không lưu trạng thái");
            showNotification("Vui lòng nhập tên trước khi quay!", 3000);
            isSaving = false;
            return;
        }
        
        updateStatus('syncing', 'Đang lưu...');
        
        // Tạo đối tượng dữ liệu
        const gameState = {
            userId: userId,
            name: playerName,
            score: points,
            spinsLeft: spinsLeft,
            lastSpinRefreshTime: lastSpinRefreshTime,
            nextSpinDouble: nextSpinDouble,
            wheelRotation: lastWheelRotation,
            lastUpdate: Date.now()
        };
        
        console.log("Đang lưu trạng thái:", gameState);
        
        // Hàm lưu trữ với retry
        const saveWithRetry = async (retries = 3, delay = 1000) => {
            let error;
            
            for (let i = 0; i < retries; i++) {
                try {
                    // Thêm timeout để không chờ quá lâu
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                    
                    const response = await fetch(`${API_BASE_URL}/saveScore`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gameState),
                        signal: controller.signal
                    }).finally(() => clearTimeout(timeoutId));
                    
                    if (!response.ok) {
                        throw new Error(`Lỗi máy chủ: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log("Kết quả lưu trữ:", result);
                    
                    // Kiểm tra nếu server làm mới lượt quay
                    if (result.refreshed) {
                        console.log("Máy chủ đã làm mới lượt quay trong quá trình lưu");
                        
                        // Cập nhật dữ liệu từ server
                        spinsLeft = result.player.spinsLeft;
                        lastSpinRefreshTime = result.player.lastSpinRefreshTime;
                        nextRefreshTime = result.player.nextRefreshTime;
                        
                        // Cập nhật UI
                        updateStats();
                        showNotification("Lượt quay đã được làm mới! Bạn có " + spinsLeft + " lượt quay.");
                    }
                    
                    // Lưu dự phòng vào localStorage để có thể phục hồi nếu cần
                    localStorage.setItem('wheelGameBackup', JSON.stringify({
                        userId,
                        playerName,
                        points,
                        spinsLeft,
                        lastSpinRefreshTime,
                        nextRefreshTime,
                        nextSpinDouble,
                        lastWheelRotation,
                        timestamp: Date.now()
                    }));
                    
                    updateStatus('online', 'Đã lưu thành công');
                    console.log("Đã lưu trạng thái thành công");
                    return true;
                    
                } catch (err) {
                    console.error(`Lỗi lưu trữ lần ${i+1}:`, err);
                    error = err;
                    
                    // Nếu còn retry thì đợi rồi thử lại
                    if (i < retries - 1) {
                        console.log(`Đang chờ ${delay}ms trước khi thử lại...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            throw error; // Ném lỗi cuối cùng nếu tất cả retry đều thất bại
        };
        
        // Thực hiện lưu với retry
        await saveWithRetry();
        
        // Ẩn trạng thái sau khi lưu thành công
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 2000);
        
    } catch (error) {
        console.error("Lỗi lưu trạng thái sau khi đã thử lại nhiều lần:", error);
        updateStatus('error', 'Lỗi lưu');
        showNotification("Không thể lưu trạng thái. Dữ liệu sẽ được lưu tạm thời.", 5000);
        
        // Lưu dữ liệu vào localStorage để khôi phục sau này
        try {
            localStorage.setItem('wheelGameBackup', JSON.stringify({
                userId,
                playerName,
                points,
                spinsLeft,
                lastSpinRefreshTime,
                nextRefreshTime,
                nextSpinDouble,
                lastWheelRotation,
                timestamp: Date.now(),
                isBackup: true
            }));
            console.log("Đã lưu bản sao lưu vào localStorage");
        } catch (e) {
            console.error("Không thể lưu bản sao lưu:", e);
        }
    } finally {
        isSaving = false;
    }
}

        // Thêm hàm khôi phục dữ liệu từ bản sao lưu khi cần thiết
function tryRestoreFromBackup() {
    try {
        const backup = localStorage.getItem('wheelGameBackup');
        if (!backup) return false;
        
        const data = JSON.parse(backup);
        // Kiểm tra xem backup có phải cho userId hiện tại không và không quá cũ (24 giờ)
        if (data.userId === userId && Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
            console.log("Đang khôi phục từ bản sao lưu:", data);
            
            // Khôi phục dữ liệu
            if (data.playerName) playerName = data.playerName;
            if (data.points !== undefined) points = data.points;
            if (data.spinsLeft !== undefined) spinsLeft = data.spinsLeft;
            if (data.lastSpinRefreshTime) lastSpinRefreshTime = data.lastSpinRefreshTime;
            if (data.nextRefreshTime) nextRefreshTime = data.nextRefreshTime;
            if (data.nextSpinDouble !== undefined) nextSpinDouble = data.nextSpinDouble;
            if (data.lastWheelRotation !== undefined) lastWheelRotation = data.lastWheelRotation;
            
            updateStats();
            return true;
        }
    } catch (e) {
        console.error("Lỗi khi khôi phục từ bản sao lưu:", e);
    }
    return false;
}

        
        // Save player name
        async function savePlayerName() {
            const newName = playerNameInput.value.trim();
            if (newName) {
                SOUNDS.click.play();
                
                // Update name
                playerName = newName;
                localStorage.setItem('playerName', playerName);
                
                try {
                    // Save to server
                    await saveGameState(true);
                    
                    // Update leaderboard
                    await loadLeaderboard();
                    
                    // Show confirmation
                    showResult('✅', `Tên "${playerName}" đã được lưu thành công!`);
                    showNotification(`Tên đã cập nhật thành "${playerName}"!`);
                } catch (error) {
                    console.error("Error saving name:", error);
                    showNotification("Lỗi khi lưu tên. Vui lòng thử lại sau.");
                }
            }
        }
        
        // Load leaderboard
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<li class="leaderboard-item"><div class="spinner"></div></li>';
            leaderboardStatus.textContent = 'Đang tải dữ liệu...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/getLeaderboard`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const leaderboard = await response.json();
                
                if (!leaderboard || leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<li class="leaderboard-item" style="justify-content: center"><div style="color:#666;font-style:italic;">Chưa có dữ liệu xếp hạng</div></li>';
                    leaderboardStatus.textContent = 'Không có dữ liệu xếp hạng';
                    return;
                }
                
                // Update leaderboard display
                updateLeaderboardDisplay(leaderboard);
                
                // Update status
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
                leaderboardStatus.textContent = `Cập nhật: ${now.toLocaleTimeString('vi-VN', options)}`;
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = '<li class="leaderboard-item" style="justify-content: center"><div style="color:#666;font-style:italic;">Lỗi khi tải dữ liệu</div></li>';
                leaderboardStatus.textContent = 'Lỗi khi tải bảng xếp hạng';
            }
        }
        
        // Update leaderboard display
        function updateLeaderboardDisplay(leaderboard) {
            leaderboardList.innerHTML = '';
            
            // Sort leaderboard
            leaderboard.sort((a, b) => b.score - a.score);
            
            // Limit to top 10
            const topScores = leaderboard.slice(0, 10);
            
            topScores.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                const isCurrentPlayer = player.userId === userId;
                if (isCurrentPlayer) {
                    li.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                }
                
                // Add extra effects for top 3 places
                let specialEffect = '';
                if (index === 0) {
                    specialEffect = 'float';
                } else if (index === 1 || index === 2) {
                    specialEffect = 'pulse';
                }
                
                li.innerHTML = `
                    <div class="leaderboard-rank ${index < 3 ? specialEffect : ''}">${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${player.name}${isCurrentPlayer ? ' (Bạn)' : ''}</div>
                    </div>
                    <div class="leaderboard-score">${player.score.toLocaleString()}</div>
                `;
                
                leaderboardList.appendChild(li);
            });
            
            // Animation for leaderboard items
            anime({
                targets: '.leaderboard-item',
                translateX: [20, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                easing: 'easeOutQuad'
            });
        }
        
        // Update leaderboard
        async function updateLeaderboard() {
            if (!isOnline) return;
            
            try {
                // First save game state
                await saveGameState();
                
                // Then reload leaderboard (only sometimes to reduce API calls)
                if (Math.random() < 0.3) {
                    await loadLeaderboard();
                }
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Handle online status change
        function handleOnlineStatus() {
            console.log("Back online");
            isOnline = true;
            updateStatus('online', 'Đã kết nối lại');
            syncWithServer();
        }
        
        // Handle offline status change
        function handleOfflineStatus() {
            console.log("Gone offline");
            isOnline = false;
            updateStatus('error', 'Mất kết nối');
        }
        
        // Update status indicator
        function updateStatus(status, message) {
            statusIndicator.style.display = 'flex';
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = message;
        }
        
        // Handle initialization error
        function handleInitError(message) {
            globalSpinner.style.display = 'none';
            errorMessage.textContent = message;
            errorContainer.style.display = 'flex';
        }
    </script>
</body>
</html>
