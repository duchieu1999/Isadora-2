<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√°nh Xe Hi·∫øu G√† - Quay L√† C√≥ Qu√†!</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Anton&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <!-- Anime.js for better animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Howler.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- HTML2Canvas for reward card capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #d82f2f;
            --primary-dark: #b71c1c;
            --secondary-color: #ffeb3b;
            --text-color: #4a3528;
            --background-color: #87CEEB;
            --wheel-section-color: #f0d6a3;
            --wheel-border-color: #d02b27;
            --wheel-dot-color: #ffeb3b;
            --wheel-text-color: #a3251b;
            --btn-color: #d82f2f;
            --btn-text: #ffeb3b;
            --btn-hover: #b71c1c;
            --outline-color: #ffbb00;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto Condensed', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            width: 100%;
            background-image: url('https://img.upanh.tv/2025/04/29/ChatGPT-Image-18_51_42-29-thg-4-2025.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Header styles */
        .header {
            text-align: center;
            padding: 10px 0;
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        
        .flag-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .flag-left, .flag-right {
            width: 90px;
            height: 70px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 10px;
        }
        
        .flag-left::before, .flag-right::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .title-banner {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 10px 20px;
            border: 2px solid var(--secondary-color);
            width: 250px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        
        .title-banner h1 {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            margin: 0;
            line-height: 1;
        }
        
        .title-banner h2 {
            font-family: 'Anton', sans-serif;
            font-size: 20px;
            margin: 5px 0 0;
            line-height: 1;
        }
        
        .pennant-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .pennant {
            width: 25px;
            height: 30px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 3px;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
        }
        
        .pennant::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        /* Main game container */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 0 10px;
            position: relative;
            z-index: 1;
        }
        
        /* Countdown timer */
        .event-countdown {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .countdown-title {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .countdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .countdown-value {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        
        .countdown-label {
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Wheel container */
        .wheel-outer-container {
            position: relative;
            width: 100%;
            max-width: 340px;
            margin: 10px auto;
        }
        
        .wheel-flag {
            position: absolute;
            top: -40px;
            left: -80px;
            width: 140px;
            height: 100px;
            z-index: 10;
        }
        
        .wheel-flag-content {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--secondary-color);
            font-family: 'Anton', sans-serif;
            font-size: 18px;
            line-height: 1.2;
            padding: 10px;
            text-align: center;
        }
        
        .wheel-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Square aspect ratio */
        }
        
        .wheel-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background-color: var(--wheel-section-color);
            border: 12px solid var(--wheel-border-color);
            box-shadow: 0 0 0 2px var(--secondary-color), 0 10px 20px rgba(0,0,0,0.3);
            will-change: transform;
            backface-visibility: hidden;
            transform: rotate(0deg);
        }
        
        .wheel-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 50%;
            transform-origin: bottom right;
            text-align: center;
            box-sizing: border-box;
            border: 1px solid #ba8f4a;
            overflow: hidden;
        }
        
        .wheel-section-content {
            position: absolute;
            width: 45px;
            height: 45px;
            top: 20px;
            left: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: rotate(45deg);
            overflow: visible;
        }
        
        .wheel-section-icon {
            font-size: 24px;
            margin-bottom: 5px;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }
        
        .wheel-section-text {
            font-size: 8px; 
            font-weight: bold;
            color: var(--wheel-text-color);
            text-align: center;
            width: 100%;
            line-height: 1;
            word-wrap: break-word;
            overflow: visible;
            padding: 0 2px;
            text-shadow: 0 0 2px white;
            white-space: nowrap;
        }
        
        .wheel-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .wheel-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--wheel-dot-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .wheel-center-fixed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15%;
            height: 15%;
            z-index: 5;
            pointer-events: none;
        }
        
        .wheel-center {
            width: 100%;
            height: 100%;
            background-color: var(--wheel-border-color);
            border: 3px solid var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-center-circle {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-pointer-container {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 6;
            width: 30px;
            height: 30px;
        }
        
        .wheel-pointer {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            border: 2px solid var(--secondary-color);
            border-bottom: none;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3));
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 0 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary-color);
            text-transform: uppercase;
            width: 100%;
            max-width: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            background-color: var(--btn-hover);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        .btn-shine {
            position: absolute;
            top: 0;
            left: -50px;
            width: 30px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            transform: skewX(-20deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -50px; }
            20% { left: 120%; }
            100% { left: 120%; }
        }
        
        .btn-spin::before {
            content: 'üé≤';
            margin-right: 10px;
        }
        
        .btn-redeem {
            background-color: #4CAF50;
        }
        
        .btn-redeem:hover {
            background-color: #388E3C;
        }
        
        /* Results */
        .result-container {
            width: 100%;
            min-height: 60px;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }
        
        .result-message {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        .result-icon {
            font-size: 32px;
            margin: 5px 0;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
            animation: iconPulse 1s infinite alternate;
        }
        
        @keyframes iconPulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
        
        .result-container.highlight {
            background: linear-gradient(135deg, #fff9c4, #ffffff, #ffecb3);
            background-size: 200% 200%;
            animation: gradientBg 2s ease infinite;
        }
        
        @keyframes gradientBg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Redeem section */
        .redeem-section {
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .redeem-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .redeem-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .redeem-option {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: calc(50% - 5px);
            box-sizing: border-box;
        }
        
        .redeem-option:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .redeem-option.selected {
            background-color: #d5f5d5;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px #4CAF50;
        }
        
        .redeem-option-amount {
            font-weight: bold;
            color: var(--primary-dark);
            font-size: 16px;
        }
        
        .redeem-option-points {
            font-size: 12px;
            color: #666;
        }
        
        .redeem-confirm-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .redeem-confirm-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .redeem-confirm-btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Reward card */
        .reward-card {
            width: 100%;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            display: none;
            margin: 10px 0;
            max-width: 400px;
        }
        
        .reward-card::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 235, 59, 0.05) 10px,
                rgba(255, 235, 59, 0.05) 20px
            );
            z-index: -1;
        }
        
        .reward-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .reward-logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .reward-title {
            font-size: 18px;
            color: var(--primary-dark);
            text-align: left;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .reward-subtitle {
            font-size: 12px;
            color: #666;
            text-align: left;
        }
        
        .reward-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-dark);
            margin: 20px 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,235,59,0.2), rgba(255,255,255,0.1));
            border-radius: 5px;
            display: inline-block;
        }
        
        .reward-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .reward-image {
            width: 100%;
            height: 150px;
            background-color: #f1f1f1;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed #999;
            overflow: hidden;
        }
        
        .reward-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .reward-qr-code {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            background-color: #f1f1f1;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .reward-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .reward-date {
            font-size: 12px;
            color: #666;
        }
        
        .reward-watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            transform: rotate(-15deg);
            opacity: 0.5;
        }
        
        .save-btn {
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .save-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .save-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20%;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
            animation: saveButtonShine 3s infinite;
        }
        
        @keyframes saveButtonShine {
            0% { left: -60%; }
            20% { left: 130%; }
            100% { left: 130%; }
        }
        
        /* Leaderboard */
        .leaderboard {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .leaderboard-title {
            font-size: 16px;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
            position: relative;
        }
        
        .leaderboard-title::after {
            content: 'üèÜ';
            margin-left: 5px;
        }
        
        .leaderboard-list {
            list-style: none;
            padding: 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
        }
        
        .leaderboard-item:hover {
            background-color: rgba(255, 235, 59, 0.1);
            transform: translateX(2px);
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .leaderboard-item:nth-child(1) .leaderboard-rank {
            background-color: gold;
            color: black;
            box-shadow: 0 0 10px gold;
        }
        
        .leaderboard-item:nth-child(2) .leaderboard-rank {
            background-color: silver;
            color: black;
        }
        
        .leaderboard-item:nth-child(3) .leaderboard-rank {
            background-color: #cd7f32;
            color: white;
        }
        
        .leaderboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .leaderboard-name {
            font-weight: bold;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .leaderboard-score {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .leaderboard-status {
            height: 16px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .name-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .name-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .name-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .name-input button:hover {
            background-color: var(--primary-dark);
        }
        
        .user-id-hidden {
            display: none;
        }
        
        /* Loading spinner */
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s infinite linear;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Global spinner for page loading */
        .global-spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .global-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s infinite linear;
        }
        
        .global-spinner-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        /* Error page */
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        
        .error-message {
            font-size: 16px;
            color: white;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .error-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            margin-top: 20px;
            width: 100%;
            font-size: 12px;
        }
        
        .footer p {
            margin: 3px 0;
        }
        
        /* Special effects and animations */
        .glow {
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px -5px rgba(255, 235, 59, 0.5); }
            to { box-shadow: 0 0 20px 5px rgba(255, 235, 59, 0.8); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Jackpot effect */
        .jackpot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .jackpot-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px gold;
            transform: scale(0.8);
            transition: transform 0.5s;
        }
        
        .jackpot-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .jackpot-overlay.show .jackpot-content {
            transform: scale(1);
        }
        
        .jackpot-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .jackpot-points {
            font-size: 36px;
            color: gold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
            font-weight: bold;
        }
        
        .jackpot-close {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        
        /* Reset spinner animation */
        @keyframes resetSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .reset-icon {
            display: inline-block;
            animation: resetSpin 1s linear infinite;
            margin-right: 5px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease-out;
            font-size: 14px;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Name registration overlay */
        .name-registration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
        }
        
        .name-registration-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
        }
        
        .name-registration-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .name-registration-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .name-registration-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .name-registration-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .name-registration-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
        }
        
        .name-registration-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .name-registration-error {
            color: red;
            font-size: 14px;
            margin-bottom: 10px;
            display: none;
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-dot.online {
            background-color: #4CAF50;
        }
        
        .status-dot.syncing {
            background-color: #FFC107;
            animation: pulse 1s infinite;
        }
        
        .status-dot.error {
            background-color: #F44336;
        }
        
        /* Refresh button */
        .refresh-spins-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .refresh-spins-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Poster overlay styles */
        .poster-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .poster-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
            border: 5px solid var(--primary-color);
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
        
        .poster-instructions {
            color: white;
            text-align: center;
            margin-top: 20px;
            max-width: 90%;
        }
        
        .poster-instructions h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .poster-instructions p {
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .poster-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .poster-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .poster-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .poster-button.share {
            background-color: #0088cc;
            color: white;
        }
        
        .poster-button.close {
            background-color: #666;
            color: white;
        }
        
        .screenshot-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        /* Responsive adjustments */
        @media screen and (max-height: 700px) {
            .wheel-outer-container {
                max-width: 300px;
            }
            
            .title-banner {
                width: 200px;
                height: 100px;
            }
            
            .title-banner h1 {
                font-size: 28px;
            }
            
            .title-banner h2 {
                font-size: 16px;
            }
        }
        
        @media screen and (max-height: 600px) {
            .wheel-outer-container {
                max-width: 280px;
            }
            
            .controls, .stats, .result-container, .redeem-section, .leaderboard {
                margin: 5px 0;
            }
            
            .btn {
                padding: 8px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Global spinner -->
    <div class="global-spinner-container" id="global-spinner">
        <div class="global-spinner"></div>
        <div class="global-spinner-text">ƒêang k·∫øt n·ªëi v·ªõi m√°y ch·ªß...</div>
    </div>
    
    <!-- Error page -->
    <div class="error-container" id="error-container" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß</div>
        <div class="error-message" id="error-message">
            ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.
        </div>
        <button class="error-button" onclick="location.reload()">T·∫£i l·∫°i trang</button>
    </div>
    
    <!-- Status indicator -->
    <div class="status-indicator" id="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">ƒêang k·∫øt n·ªëi...</span>
    </div>
    
    <div class="header">
        <div class="flag-banner">
            <div class="flag-left"></div>
            <div class="title-banner">
                <h1>30 TH√ÅNG 4</h1>
                <h2>GI·∫¢I PH√ìNG MI·ªÄN NAM</h2>
            </div>
            <div class="flag-right"></div>
        </div>
        <div class="pennant-banner">
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="event-countdown">
            <div class="countdown-title">K·∫øt th√∫c s·ª± ki·ªán sau</div>
            <div class="countdown-timer">
                <div class="countdown-item">
                    <div class="countdown-value" id="days-value">00</div>
                    <div class="countdown-label">Ng√†y</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="hours-value">00</div>
                    <div class="countdown-label">Gi·ªù</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="minutes-value">00</div>
                    <div class="countdown-label">Ph√∫t</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="seconds-value">00</div>
                    <div class="countdown-label">Gi√¢y</div>
                </div>
            </div>
        </div>
        
        <div class="wheel-outer-container">
            <div class="wheel-flag">
                <div class="wheel-flag-content">
                    TH·ªêNG<br>NH·∫§T<br>ƒê·∫§T<br>N∆Ø·ªöC
                </div>
            </div>
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-dots" id="wheel-dots"></div>
                    <div class="wheel-center-fixed">
                        <div class="wheel-center">
                            <div class="wheel-center-circle"></div>
                        </div>
                    </div>
                    <div class="wheel-pointer-container">
                        <div class="wheel-pointer"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="points-value">0</div>
                <div class="stat-label">ƒêi·ªÉm t√≠ch l≈©y</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="spins-value">50</div>
                <div class="stat-label">L∆∞·ª£t quay c√≤n l·∫°i</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="timer-value">29:59</div>
                <div class="stat-label">+50 l∆∞·ª£t quay sau</div>
                <button class="refresh-spins-button" id="refresh-spins-button" title="Ki·ªÉm tra l√†m m·ªõi l∆∞·ª£t quay">‚Üª</button>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-spin" id="spin-btn" disabled>
                <div class="btn-shine"></div>
                QUAY NGAY
            </button>
        </div>
        
        <div class="result-container" id="result">
            <div class="result-title">K·∫øt qu·∫£ quay th∆∞·ªüng</div>
            <div class="result-message">H√£y quay b√°nh xe ƒë·ªÉ nh·∫≠n th∆∞·ªüng!</div>
        </div>
        
        <div class="redeem-section" id="redeem-section">
            <div class="redeem-title">ƒê·ªïi ƒëi·ªÉm l·∫•y ph·∫ßn th∆∞·ªüng</div>
            <div class="redeem-options">
                <div class="redeem-option" data-amount="1000" data-points="1000">
                    <div class="redeem-option-amount">1.000 VNƒê</div>
                    <div class="redeem-option-points">1.000 ƒëi·ªÉm</div>
                </div>
                <div class="redeem-option" data-amount="2000" data-points="2000">
                    <div class="redeem-option-amount">2.000 VNƒê</div>
                    <div class="redeem-option-points">2.000 ƒëi·ªÉm</div>
                </div>
                <div class="redeem-option" data-amount="5000" data-points="5000">
                    <div class="redeem-option-amount">5.000 VNƒê</div>
                    <div class="redeem-option-points">5.000 ƒëi·ªÉm</div>
                </div>
                <div class="redeem-option" data-amount="10000" data-points="10000">
                    <div class="redeem-option-amount">10.000 VNƒê</div>
                    <div class="redeem-option-points">10.000 ƒëi·ªÉm</div>
                </div>
                <div class="redeem-option" data-amount="20000" data-points="20000">
                    <div class="redeem-option-amount">20.000 VNƒê</div>
                    <div class="redeem-option-points">20.000 ƒëi·ªÉm</div>
                </div>
            </div>
            <button class="redeem-confirm-btn" id="redeem-confirm-btn" disabled>ƒê·ªîI NGAY</button>
        </div>
        
        <div class="reward-card" id="reward-card">
            <div class="reward-header">
                <div class="reward-logo">üéÅ</div>
                <div>
                    <div class="reward-title">TH·∫∫ QU√Ä T·∫∂NG</div>
                    <div class="reward-subtitle">T·ª´ Hi·∫øu G√† - Quay L√† C√≥ Qu√†</div>
                </div>
            </div>
            <div class="reward-value" id="reward-value">0 VNƒê</div>
            <div class="reward-info">Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng ƒëi·ªÉm th∆∞·ªüng. H√£y t·∫£i v·ªÅ phi·∫øu nh·∫≠n th∆∞·ªüng v√† g·ª≠i cho Hi·∫øu G√† ƒë·ªÉ nh·∫≠n th∆∞·ªüng</div>
            <div class="reward-image" id="reward-image">
                <img src="https://thietkehaithanh.com/wp-content/uploads/2018/12/in-voucher-1.jpg" alt="H√¨nh ·∫£nh m·∫´u" />
            </div>
            <div class="reward-footer">
                <div class="reward-date" id="reward-date">30/04/2025</div>
            </div>
            <div class="reward-watermark">S·ª∞ KI·ªÜN 30/4 HI·∫æU G√Ä OFFICIAL</div>
            <button class="save-btn" id="save-reward-btn">XEM PHI·∫æU NH·∫¨N TH∆Ø·ªûNG</button>
        </div>
        
        <div class="leaderboard">
            <div class="leaderboard-title">B·∫£ng x·∫øp h·∫°ng</div>
            <ul class="leaderboard-list" id="leaderboard-list">
                <!-- Leaderboard items will be added dynamically -->
                <li class="leaderboard-item">
                    <div class="spinner"></div>
                </li>
            </ul>
            <div class="leaderboard-status" id="leaderboard-status">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div class="name-input">
                <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                <button id="save-name-btn">L∆∞u</button>
            </div>
            <div class="user-id-hidden" id="user-id-container"></div>
        </div>
    </div>
    
    <div class="footer">
        <p>¬© 2025 B√°nh Xe Hi·∫øu G√† - Quay L√† C√≥ Qu√†!</p>
        <p>Ch√†o m·ª´ng ng√†y Gi·∫£i ph√≥ng mi·ªÅn Nam 30/4</p>
    </div>
    
    <!-- Jackpot overlay -->
    <div class="jackpot-overlay" id="jackpot-overlay">
        <div class="jackpot-content">
            <div class="jackpot-title">üéâ JACKPOT! üéâ</div>
            <div>B·∫°n ƒë√£ tr√∫ng JACKPOT ƒë·∫∑c bi·ªát!</div>
            <div class="jackpot-points" id="jackpot-points">+1000 ƒëi·ªÉm</div>
            <button class="jackpot-close" id="jackpot-close">TUY·ªÜT V·ªúI!</button>
        </div>
    </div>
    
    <!-- Name registration overlay -->
    <div class="name-registration-overlay" id="name-registration-overlay" style="display: none;">
        <div class="name-registration-content">
            <div class="name-registration-title">Ch√†o m·ª´ng b·∫°n!</div>
            <div class="name-registration-subtitle">Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i v√† xu·∫•t hi·ªán tr√™n b·∫£ng x·∫øp h·∫°ng.</div>
            <div class="name-registration-error" id="name-registration-error">Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n</div>
            <input type="text" class="name-registration-input" id="name-registration-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            <button class="name-registration-button" id="name-registration-button">B·∫ÆT ƒê·∫¶U CH∆†I</button>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Constants
        const API_BASE_URL = '/api';
        const MAX_SPINS = 50;
        const REFRESH_TIME_MS = 1800000; // 30 minutes
        const MAX_RETRY_ATTEMPTS = 3;
        const SYNC_INTERVAL = 30000; // Sync every 30 seconds
        
        // Sound effects
        const SOUNDS = {
            spin: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1925.mp3'],
                volume: 0.5
            }),
            win: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'],
                volume: 0.5
            }),
            jackpot: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-casino-win-notification-1980.mp3'],
                volume: 0.7
            }),
            lose: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-losing-bleeps-2026.mp3'],
                volume: 0.4
            }),
            click: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-simple-click-tone-1112.mp3'],
                volume: 0.3
            }),
            reward: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'],
                volume: 0.5
            })
        };
        
        // Game config
        const wheelSections = [
            { name: "Th·∫Øng l·ª£i v·∫ª vang", icon: "üèÜ", points: 40, probability: 0.05 },
            { name: "Nh·∫≠n g·∫°o c·ª©u tr·ª£", icon: "üçö", points: 15, probability: 0.13 },
            { name: "C∆∞·ª°i xe tƒÉng ti·∫øn v√†o dinh", icon: "ü™ñ", points: 60, probability: 0.05 },
            { name: "Ch·ª•p ·∫£nh ·ªü S√†i G√≤n 1975", icon: "üì∏", points: 25, probability: 0.10 },
            { name: "Treo c·ªù th·ªëng nh·∫•t", icon: "üö©", points: 20, probability: 0.12 },
            { name: "M·∫•t l∆∞·ª£t", icon: "‚ùå", points: 0, loseTurn: true, probability: 0.10 },
            { name: "Qu√† t·∫∑ng b·∫•t ng·ªù", icon: "üéÅ", points: 0, randomCard: true, probability: 0.08 },
            { name: "Ph√°o hoa gi·∫£i ph√≥ng", icon: "üéÜ", points: 10, extraSpin: true, probability: 0.07 },
            { name: "L√° c·ªù gi·∫£i ph√≥ng", icon: "üö©", points: 80, probability: 0.04 },
            { name: "B·ªã k·∫πt ƒë∆∞·ªùng v√¨ xe tƒÉng", icon: "üöß", points: -25, probability: 0.10 },
            { name: "B·ªã ƒë√°nh th·ª©c b·ªüi loa ph∆∞·ªùng", icon: "üîä", points: -35, probability: 0.08 },
            { name: "Nh·∫≠n ƒë√¥i bi·∫øm ·ªü l∆∞·ª£t sau", icon: "üë®‚ÄçüöÄ", points: 0, doubleNext: true, probability: 0.08 },
            // Jackpot prizes with low probability
            { name: "JACKPOT ƒê·∫∂C BI·ªÜT", icon: "üí∞", points: 100, jackpot: true, probability: 0.001 },
            { name: "JACKPOT L·ªöN", icon: "üíé", points: 150, jackpot: true, probability: 0.0005 }
        ];

        // DOM elements
        const wheel = document.getElementById('wheel');
        const wheelDots = document.getElementById('wheel-dots');
        const spinBtn = document.getElementById('spin-btn');
        const pointsValue = document.getElementById('points-value');
        const spinsValue = document.getElementById('spins-value');
        const timerValue = document.getElementById('timer-value');
        const refreshSpinsButton = document.getElementById('refresh-spins-button');
        const resultContainer = document.getElementById('result');
        const redeemSection = document.getElementById('redeem-section');
        const redeemOptions = document.querySelectorAll('.redeem-option');
        const redeemConfirmBtn = document.getElementById('redeem-confirm-btn');
        const rewardCard = document.getElementById('reward-card');
        const rewardValue = document.getElementById('reward-value');
        const rewardImage = document.getElementById('reward-image');
        const rewardDate = document.getElementById('reward-date');
        const saveRewardBtn = document.getElementById('save-reward-btn');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardStatus = document.getElementById('leaderboard-status');
        const playerNameInput = document.getElementById('player-name');
        const saveNameBtn = document.getElementById('save-name-btn');
        const userIdContainer = document.getElementById('user-id-container');
        const jackpotOverlay = document.getElementById('jackpot-overlay');
        const jackpotPoints = document.getElementById('jackpot-points');
        const jackpotClose = document.getElementById('jackpot-close');
        const notification = document.getElementById('notification');
        const nameRegistrationOverlay = document.getElementById('name-registration-overlay');
        const nameRegistrationInput = document.getElementById('name-registration-input');
        const nameRegistrationButton = document.getElementById('name-registration-button');
        const nameRegistrationError = document.getElementById('name-registration-error');
        const globalSpinner = document.getElementById('global-spinner');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        // Countdown elements
        const daysValue = document.getElementById('days-value');
        const hoursValue = document.getElementById('hours-value');
        const minutesValue = document.getElementById('minutes-value');
        const secondsValue = document.getElementById('seconds-value');

        // Game state
        let points = 0;
        let spinsLeft = MAX_SPINS;
        let isSpinning = false;
        let nextSpinDouble = false;
        let refreshTimer;
        let countdownTimer;
        let syncTimer;
        let playerName = '';
        let selectedRedeemOption = null;
        let isEventEnded = false;
        let userId = '';
        let lastWheelRotation = 0;
        let currentSections = [];
        let customPosterImage = null;
        let lastSpinRefreshTime = 0;
        let nextRefreshTime = 0;
        let isSaving = false;
        let dataLoaded = false;
        let retryCount = 0;
        let isOnline = navigator.onLine;
        
        // Initialize the game
        window.addEventListener('load', initGame);
        
        // Setup online/offline detection
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOfflineStatus);
        
      // Thay ƒë·ªïi trong h√†m initGame ƒë·ªÉ ki·ªÉm tra k·∫øt n·ªëi m√°y ch·ªß tr∆∞·ªõc
async function initGame() {
    try {
        console.log("Kh·ªüi t·∫°o game...");
        
        // ƒê·∫∑t tr·∫°ng th√°i l√† ƒëang t·∫£i
        showLoadingState(true, "ƒêang k·∫øt n·ªëi v·ªõi m√°y ch·ªß...");
        
        // Thi·∫øt l·∫≠p userId tr∆∞·ªõc
        setupUserId();
        
        // T·∫°o b√°nh xe v√† c√°c thi·∫øt l·∫≠p UI
        createWheel();
        setupUIEvents();
        
        // Ki·ªÉm tra k·∫øt n·ªëi m√°y ch·ªß
        try {
            const healthCheck = await fetch(`${API_BASE_URL}/health`, { 
                timeout: 5000,
                cache: 'no-cache'
            });
            
            if (!healthCheck.ok) {
                throw new Error('Ki·ªÉm tra k·∫øt n·ªëi m√°y ch·ªß th·∫•t b·∫°i');
            }
            
            const healthData = await healthCheck.json();
            console.log("Tr·∫°ng th√°i m√°y ch·ªß:", healthData);
            
            if (!healthData.dbConnected) {
                console.warn("C∆° s·ªü d·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi, c√≥ th·ªÉ g·∫∑p v·∫•n ƒë·ªÅ khi l∆∞u d·ªØ li·ªáu");
                showNotification("M√°y ch·ªß ƒëang kh·ªüi ƒë·ªông, c√≥ th·ªÉ g·∫∑p v·∫•n ƒë·ªÅ khi l∆∞u d·ªØ li·ªáu", 5000);
            }
        } catch (error) {
            console.error("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i m√°y ch·ªß:", error);
            showNotification("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i m√°y ch·ªß, ti·∫øp t·ª•c v·ªõi t√≠nh nƒÉng gi·ªõi h·∫°n", 5000);
        }
        
        // T·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß v·ªõi retry
        await loadDataFromServerWithRetry();
        
        // Kh·ªüi ƒë·ªông c√°c b·ªô ƒë·∫øm th·ªùi gian
        startRefreshTimer();
        startEventCountdown();
        startSyncTimer();
        
        // T·∫£i b·∫£ng x·∫øp h·∫°ng sau khi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i
        await loadLeaderboard();
        
        // B·∫≠t n√∫t quay sau khi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i
        spinBtn.disabled = false;
        
        // ·∫®n tr·∫°ng th√°i ƒëang t·∫£i
        showLoadingState(false);
        
        // ƒê·∫∑t tr·∫°ng th√°i l√† tr·ª±c tuy·∫øn
        updateStatus('online', 'ƒê√£ k·∫øt n·ªëi');
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 3000);
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        showNotification("ƒê√£ k·∫øt n·ªëi v·ªõi m√°y ch·ªß th√†nh c√¥ng!");
        
        // ƒêƒÉng k√Ω t·ª± ƒë·ªông l∆∞u tr∆∞·ªõc khi r·ªùi trang
        window.addEventListener('beforeunload', () => {
            saveGameState(true); // L∆∞u ngay l·∫≠p t·ª©c
        });
        
        // Thi·∫øt l·∫≠p x·ª≠ l√Ω khi tab thay ƒë·ªïi hi·ªÉn th·ªã
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log("Tab tr·ªü th√†nh hi·ªÉn th·ªã, ƒë·ªìng b·ªô d·ªØ li·ªáu...");
                syncWithServer();
            }
        });
        
        // Ki·ªÉm tra xem ƒëƒÉng k√Ω t√™n l√† c·∫ßn thi·∫øt
        checkNameRegistration();
        
    } catch (error) {
        console.error("L·ªói kh·ªüi t·∫°o game:", error);
        handleInitError("Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.");
    }
}
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
function showLoadingState(show, message = "ƒêang t·∫£i...") {
    if (show) {
        globalSpinner.style.display = 'flex';
        document.querySelector('.global-spinner-text').textContent = message;
    } else {
        globalSpinner.style.display = 'none';
    }
}

// Th√™m h√†m ki·ªÉm tra tr·∫°ng th√°i m√°y ch·ªß ri√™ng
async function checkServerStatus() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`, { 
            timeout: 5000,
            cache: 'no-cache'
        });
        
        if (!response.ok) return false;
        
        const data = await response.json();
        return data.status === 'ok' && data.dbConnected;
    } catch (e) {
        console.error("L·ªói ki·ªÉm tra tr·∫°ng th√°i m√°y ch·ªß:", e);
        return false;
    }
}
        
        // Load data from server with retry mechanism
        async function loadDataFromServerWithRetry() {
            retryCount = 0;
            let delay = 1000; // Start with 1 second delay
            
            while (retryCount < MAX_RETRY_ATTEMPTS) {
                try {
                    updateStatus('syncing', `ƒêang k·∫øt n·ªëi (l·∫ßn ${retryCount + 1})...`);
                    await loadDataFromServer();
                    
                    // If successful, return
                    console.log("Data loaded successfully");
                    dataLoaded = true;
                    return;
                } catch (error) {
                    retryCount++;
                    console.error(`Attempt ${retryCount} failed:`, error);
                    
                    if (retryCount >= MAX_RETRY_ATTEMPTS) {
                        throw new Error("Maximum retry attempts reached");
                    }
                    
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Double the delay for next attempt
                }
            }
        }
        
      // Thay ƒë·ªïi trong h√†m loadDataFromServer ƒë·ªÉ th√™m ph·ª•c h·ªìi t·ª´ b·∫£n sao l∆∞u
async function loadDataFromServer() {
    if (!userId) {
        console.log("Kh√¥ng c√≥ userId, b·ªè qua t·∫£i d·ªØ li·ªáu");
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/getScore?userId=${userId}`);
        
        if (response.status === 404) {
            console.log("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i tr√™n m√°y ch·ªß");
            
            // Th·ª≠ kh√¥i ph·ª•c t·ª´ b·∫£n sao l∆∞u tr∆∞·ªõc
            if (tryRestoreFromBackup()) {
                console.log("ƒê√£ kh√¥i ph·ª•c t·ª´ b·∫£n sao l∆∞u, ƒëang l∆∞u l√™n server");
                await saveGameState(true);
                return;
            }
            
            // N·∫øu kh√¥ng c√≥ b·∫£n sao l∆∞u, s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh
            console.log("S·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh");
            points = 0;
            spinsLeft = MAX_SPINS;
            nextSpinDouble = false;
            lastSpinRefreshTime = Date.now();
            nextRefreshTime = lastSpinRefreshTime + REFRESH_TIME_MS;
            
            // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu l√™n server
            await saveGameState(true);
            return;
        }
        
        if (!response.ok) {
            throw new Error(`L·ªói m√°y ch·ªß: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("D·ªØ li·ªáu nh·∫≠n t·ª´ server:", data);
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i game t·ª´ d·ªØ li·ªáu server
        points = data.score || 0;
        spinsLeft = data.spinsLeft !== undefined ? data.spinsLeft : MAX_SPINS;
        nextSpinDouble = data.nextSpinDouble || false;
        lastSpinRefreshTime = data.lastSpinRefreshTime || Date.now();
        nextRefreshTime = data.nextRefreshTime || (lastSpinRefreshTime + REFRESH_TIME_MS);
        lastWheelRotation = data.wheelRotation || 0;
        
        // N·∫øu t√™n ng∆∞·ªùi ch∆°i ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p nh∆∞ng c√≥ trong d·ªØ li·ªáu, s·ª≠ d·ª•ng n√≥
        if ((!playerName || playerName === '') && data.name) {
            playerName = data.name;
            playerNameInput.value = playerName;
            localStorage.setItem('playerName', playerName);
        }
        
        // C·∫≠p nh·∫≠t UI
        updateStats();
        showNotification("ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß th√†nh c√¥ng", 2000);
        
    } catch (error) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß:", error);
        
        // Th·ª≠ kh√¥i ph·ª•c t·ª´ b·∫£n sao l∆∞u n·∫øu kh√¥ng th·ªÉ k·∫øt n·ªëi server
        if (tryRestoreFromBackup()) {
            showNotification("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ b·∫£n sao l∆∞u c·ª•c b·ªô", 3000);
        } else {
            showNotification("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß", 3000);
        }
        
        throw error; // N√©m l·ªói ƒë·ªÉ x·ª≠ l√Ω ·ªü n∆°i g·ªçi h√†m
    }
}
        
        // Setup user ID
        function setupUserId() {
            userId = localStorage.getItem('wheelGameUserId');
            if (!userId) {
                userId = generateUniqueId();
                localStorage.setItem('wheelGameUserId', userId);
            }
            userIdContainer.textContent = userId;
        }
        
        // Generate unique ID
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 10);
        }
        
        // Check if name registration is needed
        function checkNameRegistration() {
            // Get from localStorage first
            const savedName = localStorage.getItem('playerName');
            
            if (savedName) {
                playerName = savedName;
                playerNameInput.value = savedName;
                nameRegistrationOverlay.style.display = 'none';
            } else {
                // Show name registration overlay
                nameRegistrationOverlay.style.display = 'flex';
            }
        }
        
        // Setup UI events
        function setupUIEvents() {
            // Spin button
            spinBtn.addEventListener('click', spinWheel);
            
            // Redeem options
            redeemOptions.forEach(option => {
                option.addEventListener('click', handleRedeemOptionClick);
            });
            
            // Redeem confirm button
            redeemConfirmBtn.addEventListener('click', redeemPoints);
            
            // Save reward button
            saveRewardBtn.addEventListener('click', saveRewardPoster);
            
            // Save name button
            saveNameBtn.addEventListener('click', savePlayerName);
            
            // Refresh spins button
            refreshSpinsButton.addEventListener('click', checkAndRefreshSpins);
            
            // Jackpot close button
            jackpotClose.addEventListener('click', () => {
                jackpotOverlay.classList.remove('show');
            });
            
            // Name registration button
            nameRegistrationButton.addEventListener('click', handleNameRegistration);
            nameRegistrationInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleNameRegistration();
                }
            });
        }
        
        // Handle redeem option click
        function handleRedeemOptionClick() {
            if (isEventEnded) return;
            SOUNDS.click.play();
            
            const requiredPoints = parseInt(this.getAttribute('data-points'));
            
            if (points >= requiredPoints) {
                // Deselect all options
                redeemOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Select this option
                this.classList.add('selected');
                selectedRedeemOption = this;
                
                // Enable confirm button
                redeemConfirmBtn.disabled = false;
            } else {
                showResult('‚ö†Ô∏è', `B·∫°n c·∫ßn √≠t nh·∫•t ${requiredPoints} ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi ph·∫ßn th∆∞·ªüng n√†y!`);
                anime({
                    targets: this,
                    translateX: [
                        { value: -5, duration: 50 },
                        { value: 5, duration: 50 },
                        { value: -5, duration: 50 },
                        { value: 5, duration: 50 },
                        { value: 0, duration: 50 }
                    ]
                });
            }
        }
        
        // Handle name registration
        function handleNameRegistration() {
            const name = nameRegistrationInput.value.trim();
            if (name.length < 2) {
                nameRegistrationError.style.display = 'block';
                nameRegistrationError.textContent = 'Vui l√≤ng nh·∫≠p t√™n c√≥ √≠t nh·∫•t 2 k√Ω t·ª±';
                nameRegistrationInput.focus();
                return;
            }
            
            playerName = name;
            localStorage.setItem('playerName', name);
            playerNameInput.value = name;
            nameRegistrationOverlay.style.display = 'none';
            
            // Save to API
            saveGameState();
            
            showNotification(`Ch√†o m·ª´ng ${name} ƒë·∫øn v·ªõi B√°nh Xe Hi·∫øu G√†!`);
            SOUNDS.click.play();
        }
        
        // Start sync timer
        function startSyncTimer() {
            // Clear any existing timer
            if (syncTimer) clearInterval(syncTimer);
            
            // Sync every 30 seconds
            syncTimer = setInterval(() => {
                if (isOnline) {
                    syncWithServer();
                }
            }, SYNC_INTERVAL);
        }
        
        // Sync with server
        async function syncWithServer() {
            if (!isOnline || isSaving) return;
            
            try {
                updateStatus('syncing', 'ƒêang ƒë·ªìng b·ªô...');
                
                // Get latest data from server
                await loadDataFromServer();
                
                // Check if spins need to be refreshed
                await checkSpinsWithServer();
                
                // Update status
                updateStatus('online', 'ƒê√£ ƒë·ªìng b·ªô');
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error("Error syncing with server:", error);
                updateStatus('error', 'L·ªói ƒë·ªìng b·ªô');
            }
        }
        
        // Create the wheel
        function createWheel() {
            // Clear existing sections
            wheel.innerHTML = '';
            wheelDots.innerHTML = '';
            
            // Use only 12 sections for the wheel
            const sectionsPool = wheelSections.slice(); // Clone the array
            const numSections = 12; // Fixed number of sections
            
            // Initialize the wheel sections array
            let sectionsToUse = [];
            
            // Calculate total probability for normalization
            const totalProbability = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
            
            // Select the sections weighted by their probability
            for (let i = 0; i < numSections; i++) {
                // Normalize probabilities for the remaining pool
                const remainingTotal = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
                
                let random = Math.random() * remainingTotal;
                let cumulativeProbability = 0;
                let selectedIndex = 0;
                
                for (let j = 0; j < sectionsPool.length; j++) {
                    cumulativeProbability += sectionsPool[j].probability;
                    if (random <= cumulativeProbability) {
                        selectedIndex = j;
                        break;
                    }
                }
                
                // Add the selected section to our wheel and remove from the pool
                sectionsToUse.push(sectionsPool[selectedIndex]);
                sectionsPool.splice(selectedIndex, 1);
            }
            
            // Create wheel sections
            for (let i = 0; i < numSections; i++) {
                const section = sectionsToUse[i];
                const rotationAngle = (i * 360 / numSections);
                
                // Create section element
                const sectionElement = document.createElement('div');
                sectionElement.className = 'wheel-section';
                sectionElement.style.transform = `rotate(${rotationAngle}deg)`;
                sectionElement.dataset.index = i; // Store the index for reference
                
                // Position and style the section
                const sectionContent = document.createElement('div');
                sectionContent.className = 'wheel-section-content';
                
                // Create icon
                const iconElement = document.createElement('div');
                iconElement.className = 'wheel-section-icon';
                iconElement.textContent = section.icon;
                
                // Highlight jackpot sections with glow effect
                if (section.jackpot) {
                    iconElement.style.fontSize = '28px';
                    iconElement.style.filter = 'drop-shadow(0 0 5px gold)';
                    sectionElement.style.background = 'linear-gradient(135deg, #fff9c4 0%, #f0d6a3 100%)';
                }
                
                // Create text
                const textElement = document.createElement('div');
                textElement.className = 'wheel-section-text';
                textElement.textContent = section.name;
                
                // Assemble the section
                sectionContent.appendChild(iconElement);
                sectionContent.appendChild(textElement);
                sectionElement.appendChild(sectionContent);
                wheel.appendChild(sectionElement);
            }
            
            // Add dots around the wheel (24 dots)
            const dotsCount = 24;
            const radius = 48.5; // Percentage of wheel radius
            
            for (let i = 0; i < dotsCount; i++) {
                const angle = (i * 360 / dotsCount) * (Math.PI / 180);
                const x = 50 + radius * Math.cos(angle);
                const y = 50 + radius * Math.sin(angle);
                
                const dot = document.createElement('div');
                dot.className = 'wheel-dot';
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                wheelDots.appendChild(dot);
            }
            
            // Store the current sections
            currentSections = sectionsToUse;
        }
        
        // Thay ƒë·ªïi trong h√†m spinWheel ƒë·ªÉ ƒë·∫£m b·∫£o l∆∞u tr·∫°ng th√°i sau m·ªói l·∫ßn quay
function spinWheel() {
    if (isSpinning || spinsLeft <= 0 || isEventEnded || !dataLoaded) return;
    
    // Ki·ªÉm tra n·∫øu t√™n ng∆∞·ªùi ch∆°i ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p
    if (!playerName || playerName.trim() === '') {
        showNameRegistrationOverlay();
        showNotification("Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªõc khi quay!", 3000);
        return;
    }
    
    SOUNDS.spin.play();
    
    isSpinning = true;
    spinsLeft--;
    updateStats();
    
    // X√°c ƒë·ªãnh ph·∫ßn th∆∞·ªüng ƒë√£ ƒë∆∞·ª£c ch·ªçn
    const numSections = currentSections.length;
    let winningIndex = Math.floor(Math.random() * numSections);
    const winningSection = currentSections[winningIndex];
    
    // T√≠nh g√≥c quay ƒë·ªÉ r∆°i v√†o ph·∫ßn th∆∞·ªüng ƒë√£ ch·ªçn
    const sectionAngle = 360 / numSections;
    const targetAngle = 360 - (winningIndex * sectionAngle) - (sectionAngle / 2);
    
    // ƒê·∫£m b·∫£o quay ƒë·ªß v√≤ng (√≠t nh·∫•t 2 v√≤ng) c·ªông v·ªõi g√≥c m·ª•c ti√™u
    const fullRotations = 2 * 360;
    const destinationAngle = fullRotations + targetAngle;
    
    // X√≥a chuy·ªÉn ƒë·ªông hi·ªán c√≥
    wheel.style.transition = 'none';
    wheel.offsetHeight; // Force reflow
    wheel.style.transform = `rotate(${lastWheelRotation}deg)`;
    wheel.offsetHeight; // Force reflow l·∫°i
    
    // B√¢y gi·ªù th√™m chuy·ªÉn ƒë·ªông v√† quay ƒë·∫øn ƒë√≠ch
    wheel.style.transition = 'transform 3s cubic-bezier(0.17, 0.89, 0.24, 1.0)';
    wheel.style.transform = `rotate(${destinationAngle}deg)`;
    
    // Th√™m hi·ªáu ·ª©ng tr·ª±c quan trong qu√° tr√¨nh quay
    anime({
        targets: '.wheel-pointer',
        scale: [1, 1.2, 1, 1.2, 1],
        opacity: [1, 0.8, 1, 0.8, 1],
        duration: 3000,
        easing: 'easeInOutQuad'
    });
    
    // L∆∞u g√≥c quay hi·ªán t·∫°i cho l·∫ßn quay ti·∫øp theo
    lastWheelRotation = destinationAngle % 360;
    
    // T·∫Øt n√∫t quay trong khi ƒëang quay
    spinBtn.disabled = true;
    
    // Sau khi ho√†n th√†nh ho·∫°t ·∫£nh quay
    setTimeout(() => {
        isSpinning = false;
        spinBtn.disabled = false;
        processResult(winningSection);
        
        // L∆∞u tr·∫°ng th√°i ngay sau khi quay, v·ªõi nhi·ªÅu l·∫ßn th·ª≠ l·∫°i
        saveGameStateWithLoading();
    }, 3000);
}
        // Th√™m h√†m l∆∞u tr·∫°ng th√°i v·ªõi hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
async function saveGameStateWithLoading() {
    // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang l∆∞u
    updateStatus('syncing', 'ƒêang l∆∞u...');
    
    try {
        await saveGameState(true); // L∆∞u tr·∫°ng th√°i ngay l·∫≠p t·ª©c
        updateStatus('online', 'ƒê√£ l∆∞u');
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 2000);
    } catch (error) {
        console.error("L·ªói l∆∞u tr·∫°ng th√°i:", error);
        updateStatus('error', 'L·ªói l∆∞u');
        showNotification("Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i. ƒêang th·ª≠ l·∫°i...", 3000);
        
        // Th·ª≠ l·∫°i sau 3 gi√¢y
        setTimeout(async () => {
            try {
                await saveGameState(true);
                updateStatus('online', 'ƒê√£ l∆∞u');
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 2000);
            } catch (retryError) {
                console.error("L·ªói khi th·ª≠ l·∫°i l∆∞u tr·∫°ng th√°i:", retryError);
                updateStatus('error', 'L·ªói l∆∞u');
                showNotification("V·∫´n kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.", 5000);
            }
        }, 3000);
    }
}
        // Hi·ªÉn th·ªã overlay ƒëƒÉng k√Ω t√™n
function showNameRegistrationOverlay() {
    nameRegistrationOverlay.style.display = 'flex';
}
        
        // Process the result after spinning
        function processResult(section) {
            let pointsEarned = section.points;
            let message = '';
            let isJackpot = false;
            
            // Apply double if applicable
            if (nextSpinDouble) {
                pointsEarned *= 2;
                nextSpinDouble = false;
                message += '<strong>Nh·∫≠n ƒë√¥i bi·∫øm k√≠ch ho·∫°t!</strong> ƒêi·ªÉm nh√¢n ƒë√¥i! ';
            }
            
            // Process special effects
            if (section.jackpot) {
                isJackpot = true;
                message += `<strong>JACKPOT ƒê·∫∂C BI·ªÜT!</strong> B·∫°n nh·∫≠n ƒë∆∞·ª£c ${pointsEarned} ƒëi·ªÉm! `;
                SOUNDS.jackpot.play();
                
                // Show jackpot overlay
                jackpotPoints.textContent = `+${pointsEarned} ƒëi·ªÉm`;
                setTimeout(() => {
                    jackpotOverlay.classList.add('show');
                }, 500);
            } else if (section.extraSpin) {
                // Add spin with limit check
                if (spinsLeft < MAX_SPINS) {
                    spinsLeft++;
                }
                updateStats();
                message += `<strong>${section.name}!</strong> B·∫°n nh·∫≠n ƒë∆∞·ª£c th√™m 1 l∆∞·ª£t quay! `;
                SOUNDS.win.play();
            } else if (section.loseTurn) {
                message += `<strong>${section.name}!</strong> Th·∫≠t ti·∫øc, b·∫°n m·∫•t l∆∞·ª£t n√†y. `;
                SOUNDS.lose.play();
            } else if (section.randomCard) {
                // Random card gives points between 10-90
                const randomPoints = Math.floor(Math.random() * 81) + 10;
                pointsEarned = randomPoints;
                message += `<strong>${section.name}!</strong> B·∫°n nh·∫≠n ƒë∆∞·ª£c ${pointsEarned} ƒëi·ªÉm! `;
                SOUNDS.win.play();
            } else if (section.doubleNext) {
                nextSpinDouble = true;
                message += `<strong>${section.name}!</strong> L∆∞·ª£t quay ti·∫øp theo s·∫Ω ƒë∆∞·ª£c nh√¢n ƒë√¥i ƒëi·ªÉm! `;
                SOUNDS.win.play();
            } else {
                if (pointsEarned > 0) {
                    message += `<strong>${section.name}!</strong> B·∫°n nh·∫≠n ƒë∆∞·ª£c ${pointsEarned} ƒëi·ªÉm! `;
                    SOUNDS.win.play();
                } else if (pointsEarned < 0) {
                    message += `<strong>${section.name}!</strong> B·∫°n m·∫•t ${Math.abs(pointsEarned)} ƒëi·ªÉm! `;
                    SOUNDS.lose.play();
                } else {
                    message += `<strong>${section.name}!</strong> `;
                    SOUNDS.click.play();
                }
            }
            
            // Update points
            points += pointsEarned;
            if (points < 0) points = 0;
            updateStats();
            
            // Highlight the points value with animation
            if (pointsEarned !== 0) {
                const pointsElement = document.getElementById('points-value');
                pointsElement.classList.remove('pulse');
                void pointsElement.offsetWidth; // Force reflow
                pointsElement.classList.add('pulse');
            }
            
            // Show the result with enhanced effects
            showResult(section.icon, message, pointsEarned, isJackpot);
            
            // Show celebration for big wins
            if (pointsEarned >= 60 || isJackpot) {
                createConfetti(pointsEarned >= 500 ? 200 : 50);
            }
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update redeem button state
            updateRedeemButtonState();
        }
        
        // Show the result message with enhanced effects
        function showResult(icon, message, pointsEarned = 0, isJackpot = false) {
            let resultHtml = `
                <div class="result-title">${isJackpot ? 'üéä JACKPOT! üéä' : 'K·∫øt qu·∫£ quay th∆∞·ªüng'}</div>
                <div class="result-icon">${icon}</div>
                <div class="result-message">${message}</div>
            `;
            
            resultContainer.innerHTML = resultHtml;
            resultContainer.classList.remove('bounce', 'highlight', 'shake');
            void resultContainer.offsetWidth; // Force reflow
            
            // Apply different effects based on result
            if (isJackpot) {
                resultContainer.classList.add('highlight');
                resultContainer.classList.add('bounce');
            } else if (pointsEarned > 0) {
                resultContainer.classList.add('highlight');
            } else if (pointsEarned < 0) {
                resultContainer.classList.add('shake');
            } else {
                resultContainer.classList.add('bounce');
            }
        }
        
        // Create enhanced confetti effect
        function createConfetti(count = 50) {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#fff', '#fd0'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `-20px`;
                confetti.style.width = `${5 + Math.random() * 10}px`;
                confetti.style.height = `${5 + Math.random() * 10}px`;
                confetti.style.opacity = '1';
                document.body.appendChild(confetti);
                
                // Add more variety to confetti
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                } else {
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
                
                // Animate the confetti with more variety
                const duration = 1 + Math.random() * 3;
                const delay = Math.random() * 1;
                
                // Use anime.js for more complex animation
                anime({
                    targets: confetti,
                    translateY: window.innerHeight + 100,
                    translateX: [
                        { value: -50 + Math.random() * 100, duration: duration * 500 },
                        { value: -100 + Math.random() * 200, duration: duration * 500 }
                    ],
                    rotate: Math.random() * 720,
                    opacity: [
                        { value: 1, duration: duration * 400 },
                        { value: 0, duration: duration * 600 }
                    ],
                    delay: delay * 1000,
                    easing: 'easeOutQuad',
                    complete: function() {
                        if (document.body.contains(confetti)) {
                            document.body.removeChild(confetti);
                        }
                    }
                });
            }
        }
        
        // Update redeem button state
        function updateRedeemButtonState() {
            const hasEnoughPoints = Array.from(redeemOptions).some(option => {
                const requiredPoints = parseInt(option.getAttribute('data-points'));
                return points >= requiredPoints;
            });
            
            // If no option is selected but points are enough for at least one option, highlight the button
            if (!selectedRedeemOption && hasEnoughPoints) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'CH·ªåN M·ªòT M·ª®C';
                redeemConfirmBtn.classList.add('pulse');
            } else if (selectedRedeemOption) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'ƒê·ªîI NGAY';
                redeemConfirmBtn.classList.remove('pulse');
            } else {
                redeemConfirmBtn.disabled = true;
                redeemConfirmBtn.textContent = 'KH√îNG ƒê·ª¶ ƒêI·ªÇM';
                redeemConfirmBtn.classList.remove('pulse');
            }
        }
        
        // Update game statistics display
        function updateStats() {
            pointsValue.textContent = points;
            spinsValue.textContent = spinsLeft;
            
            // Also update redeem button state
            updateRedeemButtonState();
        }
        
        // Start refresh timer
        function startRefreshTimer() {
            // First update once
            updateRefreshTimer();
            
            // Clear any existing timer
            if (refreshTimer) clearInterval(refreshTimer);
            
            // Update every second
            refreshTimer = setInterval(updateRefreshTimer, 1000);
        }
        
        // Update refresh timer display
        function updateRefreshTimer() {
            const now = new Date().getTime();
            
            // Make sure nextRefreshTime is set
            if (!nextRefreshTime || nextRefreshTime <= now) {
                // Calculate next refresh time
                nextRefreshTime = lastSpinRefreshTime + REFRESH_TIME_MS;
            }
            
            // Calculate time left
            let timeLeft = nextRefreshTime - now;
            
            if (timeLeft <= 0) {
                // Time to refresh spins
                checkAndRefreshSpins(true);
                return;
            }
            
            // Display time left
            const minutes = Math.floor((timeLeft / 1000) / 60);
            const seconds = Math.floor((timeLeft / 1000) % 60);
            timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Check and refresh spins (can be called manually or automatically)
        async function checkAndRefreshSpins(automatic = false) {
            try {
                if (!automatic) {
                    SOUNDS.click.play();
                    showNotification("ƒêang ki·ªÉm tra l∆∞·ª£t quay...");
                }
                
                if (isOnline) {
                    // Try to refresh with server
                    await checkSpinsWithServer();
                } else {
                    // If offline, check locally
                    const now = new Date().getTime();
                    
                    if (now >= nextRefreshTime) {
                        // Time to refresh
                        refreshSpins();
                    } else {
                        // Not time yet
                        const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                        const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                        showNotification(`Ch∆∞a ƒë·∫øn th·ªùi gian l√†m m·ªõi. C√≤n ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                    }
                }
            } catch (error) {
                console.error("Error checking spins:", error);
                showNotification("L·ªói khi ki·ªÉm tra l∆∞·ª£t quay.");
            }
        }
        
        // Check spins with server
        async function checkSpinsWithServer() {
            try {
                updateStatus('syncing', 'ƒêang ki·ªÉm tra l∆∞·ª£t quay...');
                
                const response = await fetch(`${API_BASE_URL}/checkSpins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.refreshed) {
                    // Server refreshed spins
                    spinsLeft = data.player.spinsLeft;
                    lastSpinRefreshTime = data.player.lastSpinRefreshTime;
                    nextRefreshTime = data.player.nextRefreshTime;
                    
                    // Update UI
                    updateStats();
                    showNotification("L∆∞·ª£t quay ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi! +50 l∆∞·ª£t quay");
                    
                    // Show animation on spins value
                    spinsValue.classList.add('glow');
                    setTimeout(() => {
                        spinsValue.classList.remove('glow');
                    }, 3000);
                    
                    updateStatus('online', 'ƒê√£ l√†m m·ªõi l∆∞·ª£t quay');
                    
                    return true;
                } else {
                    // No refresh needed
                    const now = new Date().getTime();
                    const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                    const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                    
                    if (minutes >= 0 && seconds >= 0) {
                        showNotification(`Ch∆∞a ƒë·∫øn th·ªùi gian l√†m m·ªõi. C√≤n ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                    } else {
                        // Force refresh if time is negative
                        await forceRefreshSpins();
                    }
                    
                    updateStatus('online', 'ƒê√£ ki·ªÉm tra l∆∞·ª£t quay');
                    
                    return false;
                }
                
            } catch (error) {
                console.error("Error checking spins with server:", error);
                showNotification("L·ªói khi ki·ªÉm tra l∆∞·ª£t quay v·ªõi m√°y ch·ªß.");
                return false;
            }
        }
        
        // Force refresh spins
        async function forceRefreshSpins() {
            try {
                updateStatus('syncing', 'ƒêang l√†m m·ªõi l∆∞·ª£t quay...');
                
                const response = await fetch(`${API_BASE_URL}/refreshSpins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update with server data
                spinsLeft = data.player.spinsLeft;
                lastSpinRefreshTime = data.player.lastSpinRefreshTime;
                nextRefreshTime = data.player.nextRefreshTime;
                
                // Update UI
                updateStats();
                showNotification("L∆∞·ª£t quay ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi! +50 l∆∞·ª£t quay");
                
                // Show animation on spins value
                spinsValue.classList.add('glow');
                setTimeout(() => {
                    spinsValue.classList.remove('glow');
                }, 3000);
                
                updateStatus('online', 'ƒê√£ l√†m m·ªõi l∆∞·ª£t quay');
                
                return true;
            } catch (error) {
                console.error("Error forcing refresh:", error);
                showNotification("L·ªói khi l√†m m·ªõi l∆∞·ª£t quay.");
                return false;
            }
        }
        
        // Refresh spins locally
        function refreshSpins() {
            const now = new Date().getTime();
            
            // Refresh to max spins
            spinsLeft = MAX_SPINS;
            
            // Update refresh times
            lastSpinRefreshTime = now;
            nextRefreshTime = now + REFRESH_TIME_MS;
            
            // Update UI
            updateStats();
            
            // Show notification
            showNotification("L∆∞·ª£t quay ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi! +50 l∆∞·ª£t quay");
            
            // Show animation on spins value
            spinsValue.classList.add('glow');
            setTimeout(() => {
                spinsValue.classList.remove('glow');
            }, 3000);
            
            // Save state
            saveGameState();
        }
        
        // Start event countdown timer
        function startEventCountdown() {
            const endDate = new Date('2025-05-01T00:00:00');
            
            function updateCountdown() {
                const now = new Date();
                const timeDiff = endDate - now;
                
                if (timeDiff <= 0) {
                    // Event ended
                    daysValue.textContent = '00';
                    hoursValue.textContent = '00';
                    minutesValue.textContent = '00';
                    secondsValue.textContent = '00';
                    
                    isEventEnded = true;
                    spinBtn.disabled = true;
                    spinBtn.textContent = 'S·ª∞ KI·ªÜN ƒê√É K·∫æT TH√öC';
                    
                    clearInterval(countdownTimer);
                    return;
                }
                
                // Calculate days, hours, minutes, seconds
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                // Update UI
                daysValue.textContent = String(days).padStart(2, '0');
                hoursValue.textContent = String(hours).padStart(2, '0');
                minutesValue.textContent = String(minutes).padStart(2, '0');
                secondsValue.textContent = String(seconds).padStart(2, '0');
                
                // Add pulse effect when time is running low (last 24 hours)
                if (days === 0 && hours < 24) {
                    document.querySelectorAll('.countdown-value').forEach(el => {
                        el.classList.add('glow');
                    });
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            clearInterval(countdownTimer); // Clear any existing timer
            countdownTimer = setInterval(updateCountdown, 1000);
        }
        
        // Redeem points for rewards
        function redeemPoints() {
            if (!selectedRedeemOption) {
                showResult('‚ö†Ô∏è', 'Vui l√≤ng ch·ªçn m·ªôt m·ª©c quy ƒë·ªïi!');
                return;
            }
            
            SOUNDS.reward.play();
            
            const amount = parseInt(selectedRedeemOption.getAttribute('data-amount'));
            const requiredPoints = parseInt(selectedRedeemOption.getAttribute('data-points'));
            
            if (points < requiredPoints) {
                showResult('‚ö†Ô∏è', `B·∫°n c·∫ßn √≠t nh·∫•t ${requiredPoints} ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi ph·∫ßn th∆∞·ªüng n√†y!`);
                return;
            }
            
            // Deduct points
            points -= requiredPoints;
            updateStats();
            
            // Create reward poster
            generateRewardPoster(amount);
            
            // Update reward card
            rewardValue.textContent = `${amount.toLocaleString()} VNƒê`;
            rewardDate.textContent = new Date().toLocaleDateString('vi-VN');

            // Show reward card with animation
            rewardCard.style.display = 'block';
            
            // Update button text
            saveRewardBtn.textContent = 'XEM PHI·∫æU NH·∫¨N TH∆Ø·ªûNG';
            
            // Show reward card with animation
            anime({
                targets: '#reward-card',
                scale: [0.9, 1],
                opacity: [0, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            
            // Reset selection
            selectedRedeemOption.classList.remove('selected');
            selectedRedeemOption = null;
            redeemConfirmBtn.disabled = true;
            
            // Save state
            saveGameState();
            
            // Show success message
            showResult('üéÅ', `Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng ${requiredPoints.toLocaleString()} ƒëi·ªÉm l·∫•y ${amount.toLocaleString()} VNƒê.`);
            
            // Update redeem button state
            updateRedeemButtonState();
            
            // Create mini celebration
            createConfetti(20);
        }
        
        // Generate reward poster 
        function generateRewardPoster(amount) {
            // Create a canvas element
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            canvas.width = 600;
            canvas.height = 800;
            
            // Draw background
            ctx.fillStyle = '#fff9e6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw border
            ctx.strokeStyle = '#d82f2f';
            ctx.lineWidth = 10;
            ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
            
            // Draw header
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, 20, canvas.width - 40, 100);
            
            // Draw title
            ctx.font = 'bold 48px Arial';
            ctx.fillStyle = '#ffeb3b';
            ctx.textAlign = 'center';
            ctx.fillText('PHI·∫æU NH·∫¨N TH∆Ø·ªûNG', canvas.width / 2, 80);
            
            // Draw amount
            ctx.font = 'bold 72px Arial';
            ctx.fillStyle = '#d82f2f';
            ctx.fillText(`${amount.toLocaleString()} VNƒê`, canvas.width / 2, 250);
            
            // Draw player name
            ctx.font = '36px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText(`Ng∆∞·ªùi nh·∫≠n: ${playerName}`, canvas.width / 2, 350);
            
            // Draw date
            const date = new Date().toLocaleDateString('vi-VN');
            ctx.font = '24px Arial';
            ctx.fillText(`Ng√†y: ${date}`, canvas.width / 2, 400);
            
            // Draw QR code placeholder
            ctx.fillStyle = '#f1f1f1';
            ctx.fillRect(canvas.width / 2 - 100, 450, 200, 200);
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText('M√£ QR Hi·∫øu G√†', canvas.width / 2, 550);
            
            // Draw footer
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, canvas.height - 120, canvas.width - 40, 100);
            ctx.fillStyle = '#ffeb3b';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('HI·∫æU G√Ä OFFICIAL', canvas.width / 2, canvas.height - 60);
            
            // Draw user ID in small text
            ctx.fillStyle = '#999';
            ctx.font = '12px Arial';
            ctx.fillText(`ID: ${userId}`, canvas.width / 2, canvas.height - 20);
            
            // Get image URL
            const imageUrl = canvas.toDataURL('image/png');
            
            // Set the reward image
            const img = rewardImage.querySelector('img');
            img.src = imageUrl;
            
            // Store for download
            customPosterImage = imageUrl;
        }
        
        // Save reward poster
        function saveRewardPoster() {
            SOUNDS.click.play();
            
            // Show poster overlay
            showPosterOverlay();
            
            // Show notification
            showNotification('H√£y ch·ª•p m√†n h√¨nh ƒë·ªÉ l∆∞u phi·∫øu th∆∞·ªüng!');
        }
        
        // Show poster overlay
        function showPosterOverlay() {
            // Remove existing overlay if any
            const existingOverlay = document.querySelector('.poster-overlay');
            if (existingOverlay) {
                document.body.removeChild(existingOverlay);
            }
            
            // Create new overlay
            const overlay = document.createElement('div');
            overlay.className = 'poster-overlay';
            
            // Create poster container
            const posterContainer = document.createElement('div');
            posterContainer.className = 'poster-container';
            
            // Create screenshot hint
            const screenshotHint = document.createElement('div');
            screenshotHint.className = 'screenshot-hint';
            screenshotHint.innerHTML = 'üì∑ Ch·ª•p m√†n h√¨nh ·ªü ƒë√¢y';
            
            // Clone reward card
            const posterClone = rewardCard.cloneNode(true);
            posterClone.style.display = 'block';
            posterClone.style.width = '100%';
            posterClone.style.maxWidth = '400px';
            posterClone.style.margin = '0 auto';
            posterClone.style.boxShadow = '0 0 30px rgba(216, 47, 47, 0.5)';
            posterClone.style.background = 'linear-gradient(135deg, #ffffff, #fff9e6)';
            
            // Remove save button from clone
            const saveBtn = posterClone.querySelector('#save-reward-btn');
            if (saveBtn) saveBtn.remove();
            
            // Add poster and hint to container
            posterContainer.appendChild(screenshotHint);
            posterContainer.appendChild(posterClone);
            
            // Create instructions
            const instructions = document.createElement('div');
            instructions.className = 'poster-instructions';
            instructions.innerHTML = `
                <h3>üî¥ H∆∞·ªõng d·∫´n nh·∫≠n th∆∞·ªüng üî¥</h3>
                <p>Ch·ª•p m√†n h√¨nh phi·∫øu nh·∫≠n th∆∞·ªüng v√† g·ª≠i cho Hi·∫øu G√†</p>
                <p>L∆∞u √Ω: Phi·∫øu ch·ªâ c√≥ gi√° tr·ªã khi g·ª≠i k√®m t√™n ƒë√£ ƒëƒÉng k√Ω (${playerName})</p>
            `;
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'poster-buttons';
            
            // Add share button for Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                const shareButton = document.createElement('button');
                shareButton.className = 'poster-button share';
                shareButton.innerHTML = '<span>üöÄ G·ª≠i cho Hi·∫øu G√†</span>';
                shareButton.addEventListener('click', function() {
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify({
                            action: 'reward_claimed',
                            amount: rewardValue.textContent,
                            user: playerName,
                            userId: userId,
                            date: rewardDate.textContent
                        }));
                        // Close overlay
                        document.body.removeChild(overlay);
                    } catch (e) {
                        console.error("Error sharing to Telegram", e);
                    }
                });
                buttonContainer.appendChild(shareButton);
            }
            
            // Add close button
            const closeButton = document.createElement('button');
            closeButton.className = 'poster-button close';
            closeButton.textContent = 'ƒê√≥ng';
            closeButton.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);
            
            // Assemble all components
            overlay.appendChild(posterContainer);
            overlay.appendChild(instructions);
            overlay.appendChild(buttonContainer);
            
            // Add to body
            document.body.appendChild(overlay);
            
            // Apply animation effect
            setTimeout(() => {
                posterContainer.style.transform = 'scale(1)';
            }, 50);
        }
        
    // C·∫≠p nh·∫≠t ph·∫ßn saveGameState v·ªõi nhi·ªÅu retry v√† logging t·ªët h∆°n
async function saveGameState(forceImmediate = false) {
    if (isSaving && !forceImmediate) {
        console.log("ƒêang c√≥ m·ªôt l∆∞u tr·ªØ ƒëang ch·∫°y, b·ªè qua");
        return;
    }
    
    try {
        isSaving = true;
        
        // Ki·ªÉm tra n·∫øu t√™n ng∆∞·ªùi ch∆°i ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p
        if (!playerName || playerName.trim() === '') {
            console.log("T√™n ng∆∞·ªùi ch∆°i ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p, kh√¥ng l∆∞u tr·∫°ng th√°i");
            showNotification("Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªõc khi quay!", 3000);
            isSaving = false;
            return;
        }
        
        updateStatus('syncing', 'ƒêang l∆∞u...');
        
        // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu
        const gameState = {
            userId: userId,
            name: playerName,
            score: points,
            spinsLeft: spinsLeft,
            lastSpinRefreshTime: lastSpinRefreshTime,
            nextSpinDouble: nextSpinDouble,
            wheelRotation: lastWheelRotation,
            lastUpdate: Date.now()
        };
        
        console.log("ƒêang l∆∞u tr·∫°ng th√°i:", gameState);
        
        // H√†m l∆∞u tr·ªØ v·ªõi retry
        const saveWithRetry = async (retries = 3, delay = 1000) => {
            let error;
            
            for (let i = 0; i < retries; i++) {
                try {
                    // Th√™m timeout ƒë·ªÉ kh√¥ng ch·ªù qu√° l√¢u
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 gi√¢y timeout
                    
                    const response = await fetch(`${API_BASE_URL}/saveScore`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gameState),
                        signal: controller.signal
                    }).finally(() => clearTimeout(timeoutId));
                    
                    if (!response.ok) {
                        throw new Error(`L·ªói m√°y ch·ªß: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log("K·∫øt qu·∫£ l∆∞u tr·ªØ:", result);
                    
                    // Ki·ªÉm tra n·∫øu server l√†m m·ªõi l∆∞·ª£t quay
                    if (result.refreshed) {
                        console.log("M√°y ch·ªß ƒë√£ l√†m m·ªõi l∆∞·ª£t quay trong qu√° tr√¨nh l∆∞u");
                        
                        // C·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ server
                        spinsLeft = result.player.spinsLeft;
                        lastSpinRefreshTime = result.player.lastSpinRefreshTime;
                        nextRefreshTime = result.player.nextRefreshTime;
                        
                        // C·∫≠p nh·∫≠t UI
                        updateStats();
                        showNotification("L∆∞·ª£t quay ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi! B·∫°n c√≥ " + spinsLeft + " l∆∞·ª£t quay.");
                    }
                    
                    // L∆∞u d·ª± ph√≤ng v√†o localStorage ƒë·ªÉ c√≥ th·ªÉ ph·ª•c h·ªìi n·∫øu c·∫ßn
                    localStorage.setItem('wheelGameBackup', JSON.stringify({
                        userId,
                        playerName,
                        points,
                        spinsLeft,
                        lastSpinRefreshTime,
                        nextRefreshTime,
                        nextSpinDouble,
                        lastWheelRotation,
                        timestamp: Date.now()
                    }));
                    
                    updateStatus('online', 'ƒê√£ l∆∞u th√†nh c√¥ng');
                    console.log("ƒê√£ l∆∞u tr·∫°ng th√°i th√†nh c√¥ng");
                    return true;
                    
                } catch (err) {
                    console.error(`L·ªói l∆∞u tr·ªØ l·∫ßn ${i+1}:`, err);
                    error = err;
                    
                    // N·∫øu c√≤n retry th√¨ ƒë·ª£i r·ªìi th·ª≠ l·∫°i
                    if (i < retries - 1) {
                        console.log(`ƒêang ch·ªù ${delay}ms tr∆∞·ªõc khi th·ª≠ l·∫°i...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            throw error; // N√©m l·ªói cu·ªëi c√πng n·∫øu t·∫•t c·∫£ retry ƒë·ªÅu th·∫•t b·∫°i
        };
        
        // Th·ª±c hi·ªán l∆∞u v·ªõi retry
        await saveWithRetry();
        
        // ·∫®n tr·∫°ng th√°i sau khi l∆∞u th√†nh c√¥ng
        setTimeout(() => {
            statusIndicator.style.display = 'none';
        }, 2000);
        
    } catch (error) {
        console.error("L·ªói l∆∞u tr·∫°ng th√°i sau khi ƒë√£ th·ª≠ l·∫°i nhi·ªÅu l·∫ßn:", error);
        updateStatus('error', 'L·ªói l∆∞u');
        showNotification("Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi.", 5000);
        
        // L∆∞u d·ªØ li·ªáu v√†o localStorage ƒë·ªÉ kh√¥i ph·ª•c sau n√†y
        try {
            localStorage.setItem('wheelGameBackup', JSON.stringify({
                userId,
                playerName,
                points,
                spinsLeft,
                lastSpinRefreshTime,
                nextRefreshTime,
                nextSpinDouble,
                lastWheelRotation,
                timestamp: Date.now(),
                isBackup: true
            }));
            console.log("ƒê√£ l∆∞u b·∫£n sao l∆∞u v√†o localStorage");
        } catch (e) {
            console.error("Kh√¥ng th·ªÉ l∆∞u b·∫£n sao l∆∞u:", e);
        }
    } finally {
        isSaving = false;
    }
}

        // Th√™m h√†m kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ b·∫£n sao l∆∞u khi c·∫ßn thi·∫øt
function tryRestoreFromBackup() {
    try {
        const backup = localStorage.getItem('wheelGameBackup');
        if (!backup) return false;
        
        const data = JSON.parse(backup);
        // Ki·ªÉm tra xem backup c√≥ ph·∫£i cho userId hi·ªán t·∫°i kh√¥ng v√† kh√¥ng qu√° c≈© (24 gi·ªù)
        if (data.userId === userId && Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
            console.log("ƒêang kh√¥i ph·ª•c t·ª´ b·∫£n sao l∆∞u:", data);
            
            // Kh√¥i ph·ª•c d·ªØ li·ªáu
            if (data.playerName) playerName = data.playerName;
            if (data.points !== undefined) points = data.points;
            if (data.spinsLeft !== undefined) spinsLeft = data.spinsLeft;
            if (data.lastSpinRefreshTime) lastSpinRefreshTime = data.lastSpinRefreshTime;
            if (data.nextRefreshTime) nextRefreshTime = data.nextRefreshTime;
            if (data.nextSpinDouble !== undefined) nextSpinDouble = data.nextSpinDouble;
            if (data.lastWheelRotation !== undefined) lastWheelRotation = data.lastWheelRotation;
            
            updateStats();
            return true;
        }
    } catch (e) {
        console.error("L·ªói khi kh√¥i ph·ª•c t·ª´ b·∫£n sao l∆∞u:", e);
    }
    return false;
}

        
        // Save player name
        async function savePlayerName() {
            const newName = playerNameInput.value.trim();
            if (newName) {
                SOUNDS.click.play();
                
                // Update name
                playerName = newName;
                localStorage.setItem('playerName', playerName);
                
                try {
                    // Save to server
                    await saveGameState(true);
                    
                    // Update leaderboard
                    await loadLeaderboard();
                    
                    // Show confirmation
                    showResult('‚úÖ', `T√™n "${playerName}" ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!`);
                    showNotification(`T√™n ƒë√£ c·∫≠p nh·∫≠t th√†nh "${playerName}"!`);
                } catch (error) {
                    console.error("Error saving name:", error);
                    showNotification("L·ªói khi l∆∞u t√™n. Vui l√≤ng th·ª≠ l·∫°i sau.");
                }
            }
        }
        
        // Load leaderboard
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<li class="leaderboard-item"><div class="spinner"></div></li>';
            leaderboardStatus.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/getLeaderboard`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const leaderboard = await response.json();
                
                if (!leaderboard || leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<li class="leaderboard-item" style="justify-content: center"><div style="color:#666;font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng</div></li>';
                    leaderboardStatus.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng';
                    return;
                }
                
                // Update leaderboard display
                updateLeaderboardDisplay(leaderboard);
                
                // Update status
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
                leaderboardStatus.textContent = `C·∫≠p nh·∫≠t: ${now.toLocaleTimeString('vi-VN', options)}`;
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = '<li class="leaderboard-item" style="justify-content: center"><div style="color:#666;font-style:italic;">L·ªói khi t·∫£i d·ªØ li·ªáu</div></li>';
                leaderboardStatus.textContent = 'L·ªói khi t·∫£i b·∫£ng x·∫øp h·∫°ng';
            }
        }
        
        // Update leaderboard display
        function updateLeaderboardDisplay(leaderboard) {
            leaderboardList.innerHTML = '';
            
            // Sort leaderboard
            leaderboard.sort((a, b) => b.score - a.score);
            
            // Limit to top 10
            const topScores = leaderboard.slice(0, 10);
            
            topScores.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                const isCurrentPlayer = player.userId === userId;
                if (isCurrentPlayer) {
                    li.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                }
                
                // Add extra effects for top 3 places
                let specialEffect = '';
                if (index === 0) {
                    specialEffect = 'float';
                } else if (index === 1 || index === 2) {
                    specialEffect = 'pulse';
                }
                
                li.innerHTML = `
                    <div class="leaderboard-rank ${index < 3 ? specialEffect : ''}">${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${player.name}${isCurrentPlayer ? ' (B·∫°n)' : ''}</div>
                    </div>
                    <div class="leaderboard-score">${player.score.toLocaleString()}</div>
                `;
                
                leaderboardList.appendChild(li);
            });
            
            // Animation for leaderboard items
            anime({
                targets: '.leaderboard-item',
                translateX: [20, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                easing: 'easeOutQuad'
            });
        }
        
        // Update leaderboard
        async function updateLeaderboard() {
            if (!isOnline) return;
            
            try {
                // First save game state
                await saveGameState();
                
                // Then reload leaderboard (only sometimes to reduce API calls)
                if (Math.random() < 0.3) {
                    await loadLeaderboard();
                }
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Handle online status change
        function handleOnlineStatus() {
            console.log("Back online");
            isOnline = true;
            updateStatus('online', 'ƒê√£ k·∫øt n·ªëi l·∫°i');
            syncWithServer();
        }
        
        // Handle offline status change
        function handleOfflineStatus() {
            console.log("Gone offline");
            isOnline = false;
            updateStatus('error', 'M·∫•t k·∫øt n·ªëi');
        }
        
        // Update status indicator
        function updateStatus(status, message) {
            statusIndicator.style.display = 'flex';
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = message;
        }
        
        // Handle initialization error
        function handleInitError(message) {
            globalSpinner.style.display = 'none';
            errorMessage.textContent = message;
            errorContainer.style.display = 'flex';
        }
    </script>
</body>
</html>
