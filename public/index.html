<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bánh Xe Hiếu Gà - Quay Là Có Quà!</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Anton&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <!-- Anime.js for better animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Howler.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- HTML2Canvas for reward card capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Sau khi tải trang, sẽ sử dụng setInterval để liên tục đồng bộ thời gian refresh -->
    <style>
        /* Giữ nguyên CSS từ file cũ */
        :root {
            --primary-color: #d82f2f;
            --primary-dark: #b71c1c;
            --secondary-color: #ffeb3b;
            --text-color: #4a3528;
            --background-color: #87CEEB;
            --wheel-section-color: #f0d6a3;
            --wheel-border-color: #d02b27;
            --wheel-dot-color: #ffeb3b;
            --wheel-text-color: #a3251b;
            --btn-color: #d82f2f;
            --btn-text: #ffeb3b;
            --btn-hover: #b71c1c;
            --outline-color: #ffbb00;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto Condensed', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            width: 100%;
            background-image: url('https://img.upanh.tv/2025/04/29/ChatGPT-Image-18_51_42-29-thg-4-2025.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Header styles */
        .header {
            text-align: center;
            padding: 10px 0;
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        
        .flag-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .flag-left, .flag-right {
            width: 90px;
            height: 70px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 10px;
        }
        
        .flag-left::before, .flag-right::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .title-banner {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 10px 20px;
            border: 2px solid var(--secondary-color);
            width: 250px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        
        .title-banner h1 {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            margin: 0;
            line-height: 1;
        }
        
        .title-banner h2 {
            font-family: 'Anton', sans-serif;
            font-size: 20px;
            margin: 5px 0 0;
            line-height: 1;
        }
        
        .pennant-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .pennant {
            width: 25px;
            height: 30px;
            background-color: var(--primary-color);
            position: relative;
            margin: 0 3px;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
        }
        
        .pennant::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffeb3b'%3E%3Cpath d='M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        /* Main game container */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 0 10px;
            position: relative;
            z-index: 1;
        }
        
        /* Countdown timer */
        .event-countdown {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .countdown-title {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .countdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .countdown-value {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-size: 18px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        
        .countdown-label {
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Wheel container */
        .wheel-outer-container {
            position: relative;
            width: 100%;
            max-width: 340px;
            margin: 10px auto;
        }
        
        .wheel-flag {
            position: absolute;
            top: -40px;
            left: -80px;
            width: 140px;
            height: 100px;
            z-index: 10;
        }
        
        .wheel-flag-content {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--secondary-color);
            font-family: 'Anton', sans-serif;
            font-size: 18px;
            line-height: 1.2;
            padding: 10px;
            text-align: center;
        }
        
        .wheel-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Square aspect ratio */
        }
        
        .wheel-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background-color: var(--wheel-section-color);
            border: 12px solid var(--wheel-border-color);
            box-shadow: 0 0 0 2px var(--secondary-color), 0 10px 20px rgba(0,0,0,0.3);
            will-change: transform;
            backface-visibility: hidden;
            transform: rotate(0deg);
        }
        
        .wheel-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 50%;
            transform-origin: bottom right;
            text-align: center;
            box-sizing: border-box;
            border: 1px solid #ba8f4a;
            overflow: hidden;
        }
        
        .wheel-section-content {
            position: absolute;
            width: 45px;
            height: 45px;
            top: 20px;
            left: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: rotate(45deg);
            overflow: visible;
        }
        
        .wheel-section-icon {
            font-size: 24px;
            margin-bottom: 5px;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }
        
        .wheel-section-text {
            font-size: 8px; 
            font-weight: bold;
            color: var(--wheel-text-color);
            text-align: center;
            width: 100%;
            line-height: 1;
            word-wrap: break-word;
            overflow: visible;
            padding: 0 2px;
            text-shadow: 0 0 2px white;
            white-space: nowrap;
        }
        
        .wheel-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .wheel-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--wheel-dot-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .wheel-center-fixed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15%;
            height: 15%;
            z-index: 5;
            pointer-events: none;
        }
        
        .wheel-center {
            width: 100%;
            height: 100%;
            background-color: var(--wheel-border-color);
            border: 3px solid var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-center-circle {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary-color);
            border-radius: 50%;
        }
        
        .wheel-pointer-container {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 6;
            width: 30px;
            height: 30px;
        }
        
        .wheel-pointer {
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            border: 2px solid var(--secondary-color);
            border-bottom: none;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3));
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 0 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
            width: 100%;
        }
        
        .btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid var(--secondary-color);
            text-transform: uppercase;
            width: 100%;
            max-width: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            background-color: var(--btn-hover);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        .btn-shine {
            position: absolute;
            top: 0;
            left: -50px;
            width: 30px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            transform: skewX(-20deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -50px; }
            20% { left: 120%; }
            100% { left: 120%; }
        }
        
        .btn-spin::before {
            content: '🎲';
            margin-right: 10px;
        }
        
        .btn-redeem {
            background-color: #4CAF50;
        }
        
        .btn-redeem:hover {
            background-color: #388E3C;
        }
        
        /* Results */
        .result-container {
            width: 100%;
            min-height: 60px;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .result-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }
        
        .result-message {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        .result-icon {
            font-size: 32px;
            margin: 5px 0;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
            animation: iconPulse 1s infinite alternate;
        }
        
        @keyframes iconPulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
        
        .result-container.highlight {
            background: linear-gradient(135deg, #fff9c4, #ffffff, #ffecb3);
            background-size: 200% 200%;
            animation: gradientBg 2s ease infinite;
        }
        
        @keyframes gradientBg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Redeem section */
        .redeem-section {
            width: 100%;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .redeem-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .redeem-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .redeem-option {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: calc(50% - 5px);
            box-sizing: border-box;
        }
        
        .redeem-option:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .redeem-option.selected {
            background-color: #d5f5d5;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px #4CAF50;
        }
        
        .redeem-option-amount {
            font-weight: bold;
            color: var(--primary-dark);
            font-size: 16px;
        }
        
        .redeem-option-points {
            font-size: 12px;
            color: #666;
        }
        
        .redeem-confirm-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .redeem-confirm-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .redeem-confirm-btn:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Reward card */
        .reward-card {
            width: 100%;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            display: none;
            margin: 10px 0;
            max-width: 400px;
        }
        
        .reward-card::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 235, 59, 0.05) 10px,
                rgba(255, 235, 59, 0.05) 20px
            );
            z-index: -1;
        }
        
        .reward-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .reward-logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .reward-title {
            font-size: 18px;
            color: var(--primary-dark);
            text-align: left;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .reward-subtitle {
            font-size: 12px;
            color: #666;
            text-align: left;
        }
        
        .reward-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-dark);
            margin: 20px 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,235,59,0.2), rgba(255,255,255,0.1));
            border-radius: 5px;
            display: inline-block;
        }
        
        .reward-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .reward-image {
            width: 100%;
            height: 150px;
            background-color: #f1f1f1;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed #999;
            overflow: hidden;
        }
        
        .reward-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .reward-qr-code {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            background-color: #f1f1f1;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .reward-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .reward-date {
            font-size: 12px;
            color: #666;
        }
        
        .reward-watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            transform: rotate(-15deg);
            opacity: 0.5;
        }
        
        .save-btn {
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .save-btn:hover {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .save-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20%;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
            animation: saveButtonShine 3s infinite;
        }
        
        @keyframes saveButtonShine {
            0% { left: -60%; }
            20% { left: 130%; }
            100% { left: 130%; }
        }
        
        /* Leaderboard */
        .leaderboard {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-color);
        }
        
        .leaderboard-title {
            font-size: 16px;
            color: var(--primary-dark);
            margin-bottom: 10px;
            text-align: center;
            position: relative;
        }
        
        .leaderboard-title::after {
            content: '🏆';
            margin-left: 5px;
        }
        
        .leaderboard-list {
            list-style: none;
            padding: 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
        }
        
        .leaderboard-item:hover {
            background-color: rgba(255, 235, 59, 0.1);
            transform: translateX(2px);
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .leaderboard-item:nth-child(1) .leaderboard-rank {
            background-color: gold;
            color: black;
            box-shadow: 0 0 10px gold;
        }
        
        .leaderboard-item:nth-child(2) .leaderboard-rank {
            background-color: silver;
            color: black;
        }
        
        .leaderboard-item:nth-child(3) .leaderboard-rank {
            background-color: #cd7f32;
            color: white;
        }
        
        .leaderboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .leaderboard-name {
            font-weight: bold;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .leaderboard-score {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .leaderboard-status {
            height: 16px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .name-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .name-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .name-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .name-input button:hover {
            background-color: var(--primary-dark);
        }
        
        .user-id-hidden {
            display: none;
        }
        
        /* Loading spinner */
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s infinite linear;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            margin-top: 20px;
            width: 100%;
            font-size: 12px;
        }
        
        .footer p {
            margin: 3px 0;
        }
        
        /* Special effects and animations */
        .glow {
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px -5px rgba(255, 235, 59, 0.5); }
            to { box-shadow: 0 0 20px 5px rgba(255, 235, 59, 0.8); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Jackpot effect */
        .jackpot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .jackpot-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px gold;
            transform: scale(0.8);
            transition: transform 0.5s;
        }
        
        .jackpot-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .jackpot-overlay.show .jackpot-content {
            transform: scale(1);
        }
        
        .jackpot-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .jackpot-points {
            font-size: 36px;
            color: gold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
            font-weight: bold;
        }
        
        .jackpot-close {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        
        /* Reset spinner animation */
        @keyframes resetSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .reset-icon {
            display: inline-block;
            animation: resetSpin 1s linear infinite;
            margin-right: 5px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease-out;
            font-size: 14px;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Name registration overlay */
        .name-registration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
        }
        
        .name-registration-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
        }
        
        .name-registration-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .name-registration-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .name-registration-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .name-registration-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .name-registration-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            width: 100%;
            transition: all 0.2s;
        }
        
        .name-registration-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .name-registration-error {
            color: red;
            font-size: 14px;
            margin-bottom: 10px;
            display: none;
        }
        
        /* Poster overlay styles - Enhanced and optimized for screenshot */
        .poster-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .poster-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(216, 47, 47, 0.5);
            border: 5px solid var(--primary-color);
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
        
        .poster-instructions {
            color: white;
            text-align: center;
            margin-top: 20px;
            max-width: 90%;
        }
        
        .poster-instructions h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .poster-instructions p {
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .poster-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .poster-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .poster-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .poster-button.share {
            background-color: #0088cc;
            color: white;
        }
        
        .poster-button.close {
            background-color: #666;
            color: white;
        }
        
        .screenshot-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        /* Timer refresh button */
        .refresh-spins-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .refresh-spins-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Status indicator */
        .sync-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .sync-status.online {
            background-color: rgba(0, 128, 0, 0.7);
        }
        
        .sync-status.offline {
            background-color: rgba(255, 0, 0, 0.7);
        }
        
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-indicator.online {
            background-color: #4CAF50;
        }
        
        .sync-indicator.offline {
            background-color: #f44336;
        }
        
        .sync-indicator.syncing {
            background-color: #ffc107;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        /* Responsive adjustments */
        @media screen and (max-height: 700px) {
            .wheel-outer-container {
                max-width: 300px;
            }
            
            .title-banner {
                width: 200px;
                height: 100px;
            }
            
            .title-banner h1 {
                font-size: 28px;
            }
            
            .title-banner h2 {
                font-size: 16px;
            }
        }
        
        @media screen and (max-height: 600px) {
            .wheel-outer-container {
                max-width: 280px;
            }
            
            .controls, .stats, .result-container, .redeem-section, .leaderboard {
                margin: 5px 0;
            }
            
            .btn {
                padding: 8px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="flag-banner">
            <div class="flag-left"></div>
            <div class="title-banner">
                <h1>30 THÁNG 4</h1>
                <h2>GIẢI PHÓNG MIỀN NAM</h2>
            </div>
            <div class="flag-right"></div>
        </div>
        <div class="pennant-banner">
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
            <div class="pennant"></div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="event-countdown">
            <div class="countdown-title">Kết thúc sự kiện sau</div>
            <div class="countdown-timer">
                <div class="countdown-item">
                    <div class="countdown-value" id="days-value">00</div>
                    <div class="countdown-label">Ngày</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="hours-value">00</div>
                    <div class="countdown-label">Giờ</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="minutes-value">00</div>
                    <div class="countdown-label">Phút</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-value" id="seconds-value">00</div>
                    <div class="countdown-label">Giây</div>
                </div>
            </div>
        </div>
        
        <div class="wheel-outer-container">
            <div class="wheel-flag">
                <div class="wheel-flag-content">
                    THỐNG<br>NHẤT<br>ĐẤT<br>NƯỚC
                </div>
            </div>
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div class="wheel" id="wheel"></div>
                    <div class="wheel-dots" id="wheel-dots"></div>
                    <div class="wheel-center-fixed">
                        <div class="wheel-center">
                            <div class="wheel-center-circle"></div>
                        </div>
                    </div>
                    <div class="wheel-pointer-container">
                        <div class="wheel-pointer"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="points-value">0</div>
                <div class="stat-label">Điểm tích lũy</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="spins-value">50</div>
                <div class="stat-label">Lượt quay còn lại</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="timer-value">29:59</div>
                <div class="stat-label">+50 lượt quay sau</div>
                <button class="refresh-spins-button" id="refresh-spins-button" title="Kiểm tra làm mới lượt quay">↻</button>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-spin" id="spin-btn">
                <div class="btn-shine"></div>
                QUAY NGAY
            </button>
        </div>
        
        <div class="result-container" id="result">
            <div class="result-title">Kết quả quay thưởng</div>
            <div class="result-message">Hãy quay bánh xe để nhận thưởng!</div>
        </div>
        
        <div class="redeem-section" id="redeem-section">
            <div class="redeem-title">Đổi điểm lấy phần thưởng</div>
            <div class="redeem-options">
                <div class="redeem-option" data-amount="1000" data-points="1000">
                    <div class="redeem-option-amount">1.000 VNĐ</div>
                    <div class="redeem-option-points">1.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="2000" data-points="2000">
                    <div class="redeem-option-amount">2.000 VNĐ</div>
                    <div class="redeem-option-points">2.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="5000" data-points="5000">
                    <div class="redeem-option-amount">5.000 VNĐ</div>
                    <div class="redeem-option-points">5.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="10000" data-points="10000">
                    <div class="redeem-option-amount">10.000 VNĐ</div>
                    <div class="redeem-option-points">10.000 điểm</div>
                </div>
                <div class="redeem-option" data-amount="20000" data-points="20000">
                    <div class="redeem-option-amount">20.000 VNĐ</div>
                    <div class="redeem-option-points">20.000 điểm</div>
                </div>
            </div>
            <button class="redeem-confirm-btn" id="redeem-confirm-btn" disabled>ĐỔI NGAY</button>
        </div>
        
        <div class="reward-card" id="reward-card">
            <div class="reward-header">
                <div class="reward-logo">🎁</div>
                <div>
                    <div class="reward-title">THẺ QUÀ TẶNG</div>
                    <div class="reward-subtitle">Từ Hiếu Gà - Quay Là Có Quà</div>
                </div>
            </div>
            <div class="reward-value" id="reward-value">0 VNĐ</div>
            <div class="reward-info">Chúc mừng! Bạn đã đổi thành công điểm thưởng. Hãy tải về phiếu nhận thưởng và gửi cho Hiếu Gà để nhận thưởng</div>
            <div class="reward-image" id="reward-image">
                <img src="https://thietkehaithanh.com/wp-content/uploads/2018/12/in-voucher-1.jpg" alt="Hình ảnh mẫu" />
            </div>
            <div class="reward-footer">
                <div class="reward-date" id="reward-date">30/04/2025</div>
            </div>
            <div class="reward-watermark">SỰ KIỆN 30/4 HIẾU GÀ OFFICIAL</div>
            <button class="save-btn" id="save-reward-btn">XEM PHIẾU NHẬN THƯỞNG</button>
        </div>
        
        <div class="leaderboard">
            <div class="leaderboard-title">Bảng xếp hạng</div>
            <ul class="leaderboard-list" id="leaderboard-list">
                <!-- Leaderboard items will be added dynamically -->
                <li class="leaderboard-item">
                    <div class="spinner"></div>
                </li>
            </ul>
            <div class="leaderboard-status" id="leaderboard-status">Đang tải dữ liệu...</div>
            <div class="name-input">
                <input type="text" id="player-name" placeholder="Nhập tên của bạn">
                <button id="save-name-btn">Lưu</button>
            </div>
            <div class="user-id-hidden" id="user-id-container"></div>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2025 Bánh Xe Hiếu Gà - Quay Là Có Quà!</p>
        <p>Chào mừng ngày Giải phóng miền Nam 30/4</p>
    </div>
    
    <!-- Jackpot overlay -->
    <div class="jackpot-overlay" id="jackpot-overlay">
        <div class="jackpot-content">
            <div class="jackpot-title">🎉 JACKPOT! 🎉</div>
            <div>Bạn đã trúng JACKPOT đặc biệt!</div>
            <div class="jackpot-points" id="jackpot-points">+1000 điểm</div>
            <button class="jackpot-close" id="jackpot-close">TUYỆT VỜI!</button>
        </div>
    </div>
    
    <!-- Name registration overlay -->
    <div class="name-registration-overlay" id="name-registration-overlay">
        <div class="name-registration-content">
            <div class="name-registration-title">Chào mừng bạn!</div>
            <div class="name-registration-subtitle">Vui lòng nhập tên của bạn để bắt đầu chơi và xuất hiện trên bảng xếp hạng.</div>
            <div class="name-registration-error" id="name-registration-error">Vui lòng nhập tên của bạn</div>
            <input type="text" class="name-registration-input" id="name-registration-input" placeholder="Nhập tên của bạn...">
            <button class="name-registration-button" id="name-registration-button">BẮT ĐẦU CHƠI</button>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Sync status indicator -->
    <div class="sync-status" id="sync-status">
        <span class="sync-indicator" id="sync-indicator"></span>
        <span id="sync-text">Đang đồng bộ dữ liệu...</span>
    </div>
    
    <script>
        // Sound effects
        const SOUNDS = {
            spin: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1925.mp3'],
                volume: 0.5
            }),
            win: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'],
                volume: 0.5
            }),
            jackpot: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-casino-win-notification-1980.mp3'],
                volume: 0.7
            }),
            lose: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-losing-bleeps-2026.mp3'],
                volume: 0.4
            }),
            click: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-simple-click-tone-1112.mp3'],
                volume: 0.3
            }),
            reward: new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'],
                volume: 0.5
            })
        };
        
        // Game config
        const wheelSections = [
            { name: "Thắng lợi vẻ vang", icon: "🏆", points: 40, probability: 0.05 },
            { name: "Nhận gạo cứu trợ", icon: "🍚", points: 15, probability: 0.13 },
            { name: "Cưỡi xe tăng tiến vào dinh", icon: "🪖", points: 60, probability: 0.05 },
            { name: "Chụp ảnh ở Sài Gòn 1975", icon: "📸", points: 25, probability: 0.10 },
            { name: "Treo cờ thống nhất", icon: "🚩", points: 20, probability: 0.12 },
            { name: "Mất lượt", icon: "❌", points: 0, loseTurn: true, probability: 0.10 },
            { name: "Quà tặng bất ngờ", icon: "🎁", points: 0, randomCard: true, probability: 0.08 },
            { name: "Pháo hoa giải phóng", icon: "🎆", points: 10, extraSpin: true, probability: 0.07 },
            { name: "Lá cờ giải phóng", icon: "🚩", points: 80, probability: 0.04 },
            { name: "Bị kẹt đường vì xe tăng", icon: "🚧", points: -25, probability: 0.10 },
            { name: "Bị đánh thức bởi loa phường", icon: "🔊", points: -35, probability: 0.08 },
            { name: "Nhận đôi biếm ở lượt sau", icon: "👨‍🚀", points: 0, doubleNext: true, probability: 0.08 },
            // Thêm phần thưởng jackpot với tỉ lệ thấp
            { name: "JACKPOT ĐẶC BIỆT", icon: "💰", points: 100, jackpot: true, probability: 0.001 },
            { name: "JACKPOT LỚN", icon: "💎", points: 150, jackpot: true, probability: 0.0005 }
        ];

        // Thời gian làm mới lượt quay (30 phút = 1800000ms)
        const REFRESH_TIME_MS = 1800000;
        const MAX_SPINS = 50; // Số lượt quay tối đa
        const SYNC_INTERVAL = 60000; // Đồng bộ mỗi 1 phút
        const API_BASE_URL = '/api';

        // DOM elements
        const wheel = document.getElementById('wheel');
        const wheelDots = document.getElementById('wheel-dots');
        const spinBtn = document.getElementById('spin-btn');
        const pointsValue = document.getElementById('points-value');
        const spinsValue = document.getElementById('spins-value');
        const timerValue = document.getElementById('timer-value');
        const refreshSpinsButton = document.getElementById('refresh-spins-button');
        const resultContainer = document.getElementById('result');
        const redeemSection = document.getElementById('redeem-section');
        const redeemOptions = document.querySelectorAll('.redeem-option');
        const redeemConfirmBtn = document.getElementById('redeem-confirm-btn');
        const rewardCard = document.getElementById('reward-card');
        const rewardValue = document.getElementById('reward-value');
        const rewardImage = document.getElementById('reward-image');
        const rewardDate = document.getElementById('reward-date');
        const saveRewardBtn = document.getElementById('save-reward-btn');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardStatus = document.getElementById('leaderboard-status');
        const playerNameInput = document.getElementById('player-name');
        const saveNameBtn = document.getElementById('save-name-btn');
        const userIdContainer = document.getElementById('user-id-container');
        const jackpotOverlay = document.getElementById('jackpot-overlay');
        const jackpotPoints = document.getElementById('jackpot-points');
        const jackpotClose = document.getElementById('jackpot-close');
        const notification = document.getElementById('notification');
        const nameRegistrationOverlay = document.getElementById('name-registration-overlay');
        const nameRegistrationInput = document.getElementById('name-registration-input');
        const nameRegistrationButton = document.getElementById('name-registration-button');
        const nameRegistrationError = document.getElementById('name-registration-error');
        const syncStatus = document.getElementById('sync-status');
        const syncIndicator = document.getElementById('sync-indicator');
        const syncText = document.getElementById('sync-text');
        
        // Countdown elements
        const daysValue = document.getElementById('days-value');
        const hoursValue = document.getElementById('hours-value');
        const minutesValue = document.getElementById('minutes-value');
        const secondsValue = document.getElementById('seconds-value');

        // Game state
        let points = 0;
        let spinsLeft = MAX_SPINS;
        let isSpinning = false;
        let nextSpinDouble = false;
        let refreshTimer;
        let countdownTimer;
        let syncTimer;
        let playerName = '';
        let selectedRedeemOption = null;
        let isEventEnded = false;
        let userId = '';
        let lastWheelRotation = 0;
        let currentSections = [];
        let customPosterImage = null;
        let lastSpinRefreshTime = 0; // Thời gian làm mới lượt quay gần nhất
        let nextRefreshTime = 0; // Thời gian làm mới tiếp theo
        let isSyncingWithServer = false; // Đang đồng bộ với server
        let isOnline = true; // Trạng thái kết nối

        // Initialize the game
        async function initGame() {
            try {
                // Phát hiện nếu đang chạy trong Telegram WebApp
                const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
                if (isTelegramWebApp) {
                    console.log("Running in Telegram WebApp environment");
                    
                    // Cấu hình cụ thể cho Telegram nếu cần
                    document.documentElement.style.setProperty('--primary-color', '#0088cc'); // Telegram blue
                    
                    // Nghe sự kiện từ Telegram WebApp nếu cần
                    window.Telegram.WebApp.onEvent('viewportChanged', function() {
                        // Điều chỉnh giao diện cho phù hợp với kích thước WebApp mới
                        adjustWheelSize();
                    });
                    
                    // Thay đổi văn bản nút phiếu quà
                    if (saveRewardBtn) {
                        saveRewardBtn.textContent = 'XEM PHIẾU NHẬN THƯỞNG';
                    }
                    
                    // Cho Telegram biết app đã sẵn sàng
                    window.Telegram.WebApp.ready();
                    
                    // Đặt màu nền chính của thanh main button trong Telegram (nếu cần)
                    window.Telegram.WebApp.setHeaderColor('#d82f2f');
                }
                
                // Khởi tạo các thành phần chính của game
                createWheel();
                setupUserId();
                checkNameRegistration();
                
                // Thiết lập trạng thái đồng bộ
                setupSyncStatus();
                
                // Load state từ server
                await syncWithServer();
                
                // Bắt đầu các bộ đếm thời gian
                startRefreshTimer();
                startEventCountdown();
                startSyncTimer();
                
                // Cập nhật UI
                updateStats();
                await loadLeaderboard();
                
                // Setup redeem options
                setupRedeemOptions();
                
                // Setup jackpot close
                jackpotClose.addEventListener('click', () => {
                    jackpotOverlay.classList.remove('show');
                });
                
                // Setup sound effect preloading
                Object.values(SOUNDS).forEach(sound => {
                    sound.load();
                });
                
                // Setup name registration
                nameRegistrationButton.addEventListener('click', handleNameRegistration);
                nameRegistrationInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleNameRegistration();
                    }
                });
                
                // Thêm sự kiện resize để điều chỉnh kích thước bánh xe trên các thiết bị khác nhau
                window.addEventListener('resize', adjustWheelSize);
                adjustWheelSize();
                
                // Thêm sự kiện cho nút làm mới
                refreshSpinsButton.addEventListener('click', forceCheckSpinReset);
                
                // Theo dõi trạng thái online/offline
                window.addEventListener('online', handleOnlineStatus);
                window.addEventListener('offline', handleOfflineStatus);
                
                // Trước khi rời khỏi trang, lưu trạng thái
                window.addEventListener('beforeunload', function() {
                    saveGameState(true); // Đánh dấu là lưu cuối cùng trước khi thoát
                });
                
                // Thiết lập để khi tab trở nên active, kiểm tra và đồng bộ lại
                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible') {
                        console.log("Tab trở thành visible, đồng bộ dữ liệu");
                        syncWithServer();
                    }
                });
                
                showNotification("Đã kết nối máy chủ thành công!");
            } catch (error) {
                console.error("Error initializing game:", error);
                handleOfflineMode();
                showNotification("Không thể kết nối máy chủ, chuyển sang chế độ offline");
            }
        }
        
        // Setup sync status display
        function setupSyncStatus() {
            syncStatus.style.display = 'block';
            updateSyncStatus('online');
            
            // Ẩn sau 5 giây
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 5000);
        }
        
        // Update sync status
        function updateSyncStatus(status, message) {
            syncStatus.style.display = 'block';
            syncIndicator.className = 'sync-indicator ' + status;
            
            if (status === 'online') {
                syncStatus.className = 'sync-status online';
                syncText.textContent = message || 'Đã kết nối máy chủ';
            } else if (status === 'offline') {
                syncStatus.className = 'sync-status offline';
                syncText.textContent = message || 'Đang chạy offline';
            } else if (status === 'syncing') {
                syncStatus.className = 'sync-status';
                syncText.textContent = message || 'Đang đồng bộ dữ liệu...';
            }
            
            // Ẩn sau 3 giây
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }
        
        // Handle online status
        function handleOnlineStatus() {
            isOnline = true;
            updateSyncStatus('online', 'Kết nối trở lại, đang đồng bộ...');
            syncWithServer();
        }
        
        // Handle offline status
        function handleOfflineStatus() {
            isOnline = false;
            updateSyncStatus('offline', 'Mất kết nối, dữ liệu sẽ được lưu cục bộ');
        }
        
        // Handle offline mode
        function handleOfflineMode() {
            isOnline = false;
            
            // Load từ local storage
            loadFromLocalStorage();
            
            // Cập nhật UI
            updateStats();
            updateSyncStatus('offline');
        }
        
        // Start sync timer
        function startSyncTimer() {
            // Clear any existing timer
            if (syncTimer) clearInterval(syncTimer);
            
            // Sync mỗi phút
            syncTimer = setInterval(async () => {
                if (isOnline && !isSyncingWithServer) {
                    await syncWithServer();
                }
            }, SYNC_INTERVAL);
        }
        
        // Sync with server
        async function syncWithServer() {
            if (isSyncingWithServer) return;
            
            try {
                isSyncingWithServer = true;
                updateSyncStatus('syncing');
                
                // Kiểm tra xem đã có người chơi chưa
                if (!userId) {
                    setupUserId();
                }
                
                // Kiểm tra xem có thông tin từ server không
                const response = await fetch(`${API_BASE_URL}/getScore?userId=${userId}`);
                
                if (response.ok) {
                    const serverData = await response.json();
                    
                    // Kiểm tra nextRefreshTime từ server
                    if (serverData.nextRefreshTime) {
                        nextRefreshTime = serverData.nextRefreshTime;
                        
                        // Lưu vào localStorage để sử dụng khi offline
                        localStorage.setItem('nextRefreshTime', nextRefreshTime);
                    }
                    
                    // Kiểm tra nếu dữ liệu server mới hơn
                    if (serverData.lastUpdate > (localStorage.getItem('lastUpdate') || 0)) {
                        console.log("Sử dụng dữ liệu từ server vì mới hơn");
                        
                        // Cập nhật game state từ server
                        points = serverData.score || 0;
                        
                        // Cập nhật spinsLeft nếu có
                        if (serverData.spinsLeft !== undefined) {
                            spinsLeft = serverData.spinsLeft;
                        }
                        
                        // Cập nhật lastSpinRefreshTime 
                        if (serverData.lastSpinRefreshTime) {
                            lastSpinRefreshTime = serverData.lastSpinRefreshTime;
                            localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
                        }
                        
                        // Cập nhật nextSpinDouble nếu có
                        if (serverData.nextSpinDouble !== undefined) {
                            nextSpinDouble = serverData.nextSpinDouble;
                        }
                        
                        // Cập nhật playerName nếu có và chưa được thiết lập
                        if (serverData.name && (!playerName || playerName.trim() === '')) {
                            playerName = serverData.name;
                            playerNameInput.value = playerName;
                            localStorage.setItem('playerName', playerName);
                        }
                        
                        // Lưu trạng thái cập nhật
                        localStorage.setItem('lastUpdate', serverData.lastUpdate);
                        
                        // Cập nhật UI
                        updateStats();
                    } else {
                        // Dữ liệu cục bộ mới hơn, đẩy lên server
                        console.log("Dữ liệu cục bộ mới hơn, đồng bộ lên server");
                        await saveGameState();
                    }
                    
                    // Kiểm tra xem cần làm mới lượt quay không
                    await checkSpinResetWithServer();
                } else if (response.status === 404) {
                    // Người chơi chưa tồn tại trên server, tạo mới
                    console.log("Người chơi chưa tồn tại trên server, tạo mới");
                    await saveGameState();
                } else {
                    throw new Error("Server error: " + response.status);
                }
                
                updateSyncStatus('online', 'Đã đồng bộ xong');
                isOnline = true;
            } catch (error) {
                console.error("Error syncing with server:", error);
                handleOfflineMode();
            } finally {
                isSyncingWithServer = false;
            }
        }
        
        // Check spin reset with server
        async function checkSpinResetWithServer() {
            try {
                const response = await fetch(`${API_BASE_URL}/checkSpins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.refreshed) {
                        // Server đã làm mới lượt quay
                        console.log("Server đã làm mới lượt quay");
                        
                        // Cập nhật trạng thái game từ server
                        spinsLeft = data.player.spinsLeft;
                        lastSpinRefreshTime = data.player.lastSpinRefreshTime;
                        nextRefreshTime = data.player.nextRefreshTime;
                        
                        // Lưu vào localStorage
                        localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
                        localStorage.setItem('nextRefreshTime', nextRefreshTime);
                        
                        // Cập nhật UI
                        updateStats();
                        showNotification("Lượt quay đã được làm mới! Bạn có " + spinsLeft + " lượt quay.");
                        
                        // Cập nhật bộ đếm ngược
                        restartRefreshTimer();
                        
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error("Error checking spins with server:", error);
                return false;
            }
        }
        
        // Load from local storage
        function loadFromLocalStorage() {
            const savedState = localStorage.getItem('wheelGameState');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                
                points = gameState.points || 0;
                spinsLeft = gameState.spinsLeft !== undefined ? gameState.spinsLeft : MAX_SPINS;
                nextSpinDouble = gameState.nextSpinDouble || false;
                lastWheelRotation = gameState.wheelRotation || 0;
                lastSpinRefreshTime = gameState.lastSpinRefreshTime || 0;
                
                // Kiểm tra xem cần làm mới lượt quay không
                const now = new Date().getTime();
                nextRefreshTime = localStorage.getItem('nextRefreshTime') || (lastSpinRefreshTime + REFRESH_TIME_MS);
                
                if (now >= nextRefreshTime) {
                    // Đã đến thời gian làm mới
                    spinsLeft = MAX_SPINS;
                    lastSpinRefreshTime = now;
                    nextRefreshTime = now + REFRESH_TIME_MS;
                    
                    // Lưu lại
                    localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
                    localStorage.setItem('nextRefreshTime', nextRefreshTime);
                    
                    // Thông báo
                    showNotification("Lượt quay đã được làm mới! Bạn có " + spinsLeft + " lượt quay.");
                }
                
                // Đảm bảo không vượt quá MAX_SPINS
                if (spinsLeft > MAX_SPINS) spinsLeft = MAX_SPINS;
            }
        }

        // Thêm hàm mới này vào mã JavaScript
        function updateButtonText() {
            const saveRewardBtn = document.getElementById('save-reward-btn');
            
            if (saveRewardBtn) {
                saveRewardBtn.textContent = 'XEM PHIẾU NHẬN THƯỞNG';
            }
        }

        // Đăng ký sự kiện để chạy sau khi DOM đã tải xong
        document.addEventListener('DOMContentLoaded', updateButtonText);

        // Check if name is registered
        function checkNameRegistration() {
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                playerName = savedName;
                playerNameInput.value = savedName;
                nameRegistrationOverlay.style.display = 'none';
            } else {
                nameRegistrationOverlay.style.display = 'flex';
            }
        }

        // Handle name registration
        function handleNameRegistration() {
            const name = nameRegistrationInput.value.trim();
            if (name.length < 2) {
                nameRegistrationError.style.display = 'block';
                nameRegistrationError.textContent = 'Vui lòng nhập tên có ít nhất 2 ký tự';
                nameRegistrationInput.focus();
                return;
            }
            
            playerName = name;
            localStorage.setItem('playerName', name);
            playerNameInput.value = name;
            nameRegistrationOverlay.style.display = 'none';
            
            // Save to API
            saveGameState();
            
            showNotification(`Chào mừng ${name} đến với Bánh Xe Hiếu Gà!`);
            SOUNDS.click.play();
        }

        // Show notification
        function showNotification(message, duration = 3000) {
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Setup unique user ID
        function setupUserId() {
            // Get user ID from local storage or create a new one
            userId = localStorage.getItem('wheelGameUserId');
            if (!userId) {
                userId = generateUniqueId();
                localStorage.setItem('wheelGameUserId', userId);
            }
            userIdContainer.textContent = userId;
        }

        // Generate a unique ID for the user
        function generateUniqueId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 10);
            return timestamp + random;
        }

        // Create the wheel sections with exact styling from the image
        function createWheel() {
            // Clear existing sections
            wheel.innerHTML = '';
            wheelDots.innerHTML = '';
            
            // Use only 12 sections for the wheel (keep the original structure)
            // But we'll select from all available sections including jackpot
            const sectionsPool = wheelSections.slice(); // Clone the array
            const numSections = 12; // Fixed number of sections
            
            // Initialize the wheel sections array
            let sectionsToUse = [];
            
            // Calculate total probability for normalization
            const totalProbability = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
            
            // First, let's select the sections weighted by their probability
            for (let i = 0; i < numSections; i++) {
                // Normalize probabilities for the remaining pool
                const remainingTotal = sectionsPool.reduce((sum, section) => sum + section.probability, 0);
                
                let random = Math.random() * remainingTotal;
                let cumulativeProbability = 0;
                let selectedIndex = 0;
                
                for (let j = 0; j < sectionsPool.length; j++) {
                    cumulativeProbability += sectionsPool[j].probability;
                    if (random <= cumulativeProbability) {
                        selectedIndex = j;
                        break;
                    }
                }
                
                // Add the selected section to our wheel and remove from the pool
                sectionsToUse.push(sectionsPool[selectedIndex]);
                sectionsPool.splice(selectedIndex, 1);
            }
            
            // Create wheel sections
            for (let i = 0; i < numSections; i++) {
                const section = sectionsToUse[i];
                const rotationAngle = (i * 360 / numSections);
                
                // Create section element
                const sectionElement = document.createElement('div');
                sectionElement.className = 'wheel-section';
                sectionElement.style.transform = `rotate(${rotationAngle}deg)`;
                sectionElement.dataset.index = i; // Store the index for reference
                
                // Position and style the section
                const sectionContent = document.createElement('div');
                sectionContent.className = 'wheel-section-content';
                
                // Create icon
                const iconElement = document.createElement('div');
                iconElement.className = 'wheel-section-icon';
                iconElement.textContent = section.icon;
                
                // Highlight jackpot sections with glow effect
                if (section.jackpot) {
                    iconElement.style.fontSize = '28px';
                    iconElement.style.filter = 'drop-shadow(0 0 5px gold)';
                    sectionElement.style.background = 'linear-gradient(135deg, #fff9c4 0%, #f0d6a3 100%)';
                }
                
                // Create text
                const textElement = document.createElement('div');
                textElement.className = 'wheel-section-text';
                textElement.textContent = section.name;
                
                // Assemble the section
                sectionContent.appendChild(iconElement);
                sectionContent.appendChild(textElement);
                sectionElement.appendChild(sectionContent);
                wheel.appendChild(sectionElement);
            }
            
            // Add dots around the wheel (24 dots)
            const dotsCount = 24;
            const radius = 48.5; // Percentage of wheel radius
            
            for (let i = 0; i < dotsCount; i++) {
                const angle = (i * 360 / dotsCount) * (Math.PI / 180);
                const x = 50 + radius * Math.cos(angle);
                const y = 50 + radius * Math.sin(angle);
                
                const dot = document.createElement('div');
                dot.className = 'wheel-dot';
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                wheelDots.appendChild(dot);
            }
            
            // Store the current sections
            currentSections = sectionsToUse;
        }

        // Spin the wheel
        function spinWheel() {
            if (isSpinning || spinsLeft <= 0 || isEventEnded) return;
            
            SOUNDS.spin.play();
            
            isSpinning = true;
            spinsLeft--;
            updateStats();
            
            // Determine the winning section
            const numSections = currentSections.length;
            
            // Select a winning section based on probability
            let winningIndex = Math.floor(Math.random() * numSections);
            const winningSection = currentSections[winningIndex];
            
            // Calculate rotation angle to land on the winning section
            const sectionAngle = 360 / numSections;
            const targetAngle = 360 - (winningIndex * sectionAngle) - (sectionAngle / 2); // Target middle of the section
            
            // Ensure a full rotation (at least 2 times) plus the target angle
            const fullRotations = 2 * 360; // 2 full rotations
            const destinationAngle = fullRotations + targetAngle;
            
            // Remove any existing transition
            wheel.style.transition = 'none';
            // Force a reflow to immediately apply the above style
            wheel.offsetHeight;
            // Reset the wheel to its starting position
            wheel.style.transform = `rotate(${lastWheelRotation}deg)`;
            
            // Force a reflow again to ensure the position is set
            wheel.offsetHeight;
            
            // Now add the transition and spin to the destination
            wheel.style.transition = 'transform 3s cubic-bezier(0.17, 0.89, 0.24, 1.0)';
            wheel.style.transform = `rotate(${destinationAngle}deg)`;
            
            // Add some visual effects during spinning
            anime({
                targets: '.wheel-pointer',
                scale: [1, 1.2, 1, 1.2, 1],
                opacity: [1, 0.8, 1, 0.8, 1],
                duration: 3000,
                easing: 'easeInOutQuad'
            });
            
            // Save the current rotation for next spin
            lastWheelRotation = destinationAngle % 360;
            
            // Disable spin button during spinning
            spinBtn.disabled = true;
            
            // After spinning animation completes
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                processResult(winningSection);
                saveGameState();
            }, 3000);
        }

        // Process the result after spinning
        function processResult(section) {
            let pointsEarned = section.points;
            let message = '';
            let isJackpot = false;
            
            // Apply double if applicable
            if (nextSpinDouble) {
                pointsEarned *= 2;
                nextSpinDouble = false;
                message += '<strong>Nhận đôi biếm kích hoạt!</strong> Điểm nhân đôi! ';
            }
            
            // Process special effects
            if (section.jackpot) {
                isJackpot = true;
                message += `<strong>JACKPOT ĐẶC BIỆT!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                SOUNDS.jackpot.play();
                
                // Show jackpot overlay
                jackpotPoints.textContent = `+${pointsEarned} điểm`;
                setTimeout(() => {
                    jackpotOverlay.classList.add('show');
                }, 500);
            } else if (section.extraSpin) {
                // Thêm kiểm tra giới hạn
                if (spinsLeft < MAX_SPINS) {
                    spinsLeft++;
                }
                updateStats();
                message += `<strong>${section.name}!</strong> Bạn nhận được thêm 1 lượt quay! `;
                SOUNDS.win.play();
            } else if (section.loseTurn) {
                message += `<strong>${section.name}!</strong> Thật tiếc, bạn mất lượt này. `;
                SOUNDS.lose.play();
            } else if (section.randomCard) {
                // Random card gives points between 10-200 (increased range)
                const randomPoints = Math.floor(Math.random() * 81) + 10;
                pointsEarned = randomPoints;
                message += `<strong>${section.name}!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                SOUNDS.win.play();
            } else if (section.doubleNext) {
                nextSpinDouble = true;
                message += `<strong>${section.name}!</strong> Lượt quay tiếp theo sẽ được nhân đôi điểm! `;
                SOUNDS.win.play();
            } else {
                if (pointsEarned > 0) {
                    message += `<strong>${section.name}!</strong> Bạn nhận được ${pointsEarned} điểm! `;
                    SOUNDS.win.play();
                } else if (pointsEarned < 0) {
                    message += `<strong>${section.name}!</strong> Bạn mất ${Math.abs(pointsEarned)} điểm! `;
                    SOUNDS.lose.play();
                } else {
                    message += `<strong>${section.name}!</strong> `;
                    SOUNDS.click.play();
                }
            }
            
            // Update points
            points += pointsEarned;
            if (points < 0) points = 0;
            updateStats();
            
            // Highlight the points value with animation
            if (pointsEarned !== 0) {
                const pointsElement = document.getElementById('points-value');
                pointsElement.classList.remove('pulse');
                void pointsElement.offsetWidth; // Force reflow
                pointsElement.classList.add('pulse');
            }
            
            // Show the result with enhanced effects
            showResult(section.icon, message, pointsEarned, isJackpot);
            
            // Show celebration for big wins
            if (pointsEarned >= 60 || isJackpot) {
                createConfetti(pointsEarned >= 500 ? 200 : 50);
            }
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update redeem button state
            updateRedeemButtonState();
        }

        // Show the result message with enhanced effects
        function showResult(icon, message, pointsEarned = 0, isJackpot = false) {
            let resultHtml = `
                <div class="result-title">${isJackpot ? '🎊 JACKPOT! 🎊' : 'Kết quả quay thưởng'}</div>
                <div class="result-icon">${icon}</div>
                <div class="result-message">${message}</div>
            `;
            
            resultContainer.innerHTML = resultHtml;
            resultContainer.classList.remove('bounce', 'highlight');
            void resultContainer.offsetWidth; // Force reflow
            
            // Apply different effects based on result
            if (isJackpot) {
                resultContainer.classList.add('highlight');
                resultContainer.classList.add('bounce');
            } else if (pointsEarned > 0) {
                resultContainer.classList.add('highlight');
            } else if (pointsEarned < 0) {
                resultContainer.classList.add('shake');
                setTimeout(() => {
                    resultContainer.classList.remove('shake');
                }, 500);
            } else {
                resultContainer.classList.add('bounce');
            }
        }

        // Create enhanced confetti effect
        function createConfetti(count = 50) {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#fff', '#fd0'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `-20px`;
                confetti.style.width = `${5 + Math.random() * 10}px`;
                confetti.style.height = `${5 + Math.random() * 10}px`;
                confetti.style.opacity = '1';
                document.body.appendChild(confetti);
                
                // Add more variety to confetti
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                } else {
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
                
                // Animate the confetti with more variety
                const duration = 1 + Math.random() * 3;
                const delay = Math.random() * 1;
                
                // Use anime.js for more complex animation
                anime({
                    targets: confetti,
                    translateY: window.innerHeight + 100,
                    translateX: [
                        { value: -50 + Math.random() * 100, duration: duration * 500 },
                        { value: -100 + Math.random() * 200, duration: duration * 500 }
                    ],
                    rotate: Math.random() * 720,
                    opacity: [
                        { value: 1, duration: duration * 400 },
                        { value: 0, duration: duration * 600 }
                    ],
                    delay: delay * 1000,
                    easing: 'easeOutQuad',
                    complete: function() {
                        if (document.body.contains(confetti)) {
                            document.body.removeChild(confetti);
                        }
                    }
                });
            }
        }

        // Setup redeem options
        function setupRedeemOptions() {
            redeemOptions.forEach(option => {
                option.addEventListener('click', () => {
                    if (isEventEnded) return;
                    SOUNDS.click.play();
                    
                    const requiredPoints = parseInt(option.getAttribute('data-points'));
                    
                    if (points >= requiredPoints) {
                        // Deselect all options
                        redeemOptions.forEach(opt => opt.classList.remove('selected'));
                        
                        // Select this option
                        option.classList.add('selected');
                        selectedRedeemOption = option;
                        
                        // Enable confirm button
                        redeemConfirmBtn.disabled = false;
                    } else {
                        showResult('⚠️', `Bạn cần ít nhất ${requiredPoints} điểm để đổi phần thưởng này!`);
                        anime({
                            targets: option,
                            translateX: [
                                { value: -5, duration: 50 },
                                { value: 5, duration: 50 },
                                { value: -5, duration: 50 },
                                { value: 5, duration: 50 },
                                { value: 0, duration: 50 }
                            ]
                        });
                    }
                });
            });
            
            redeemConfirmBtn.addEventListener('click', redeemPoints);
            
            // Initial update
            updateRedeemButtonState();
        }
        
        // Update redeem button state based on points
        function updateRedeemButtonState() {
            const hasEnoughPoints = Array.from(redeemOptions).some(option => {
                const requiredPoints = parseInt(option.getAttribute('data-points'));
                return points >= requiredPoints;
            });
            
            // If no option is selected but points are enough for at least one option, highlight the button
            if (!selectedRedeemOption && hasEnoughPoints) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'CHỌN MỘT MỨC';
                redeemConfirmBtn.classList.add('pulse');
            } else if (selectedRedeemOption) {
                redeemConfirmBtn.disabled = false;
                redeemConfirmBtn.textContent = 'ĐỔI NGAY';
                redeemConfirmBtn.classList.remove('pulse');
            } else {
                redeemConfirmBtn.disabled = true;
                redeemConfirmBtn.textContent = 'KHÔNG ĐỦ ĐIỂM';
                redeemConfirmBtn.classList.remove('pulse');
            }
        }

        // Update game statistics display
        function updateStats() {
            pointsValue.textContent = points;
            spinsValue.textContent = spinsLeft;
        }

        // Start refresh timer
        function startRefreshTimer() {
            // Cập nhật một lần ban đầu
            updateRefreshTimer();
            
            // Clear any existing timer
            if (refreshTimer) clearInterval(refreshTimer);
            
            // Update every second
            refreshTimer = setInterval(updateRefreshTimer, 1000);
        }
        
        // Restart refresh timer (khi thời gian được làm mới)
        function restartRefreshTimer() {
            // Clear existing timer
            if (refreshTimer) clearInterval(refreshTimer);
            
            // Lấy thời gian làm mới tiếp theo
            const now = new Date().getTime();
            
            // Nếu nextRefreshTime chưa được thiết lập hoặc đã quá hạn
            if (!nextRefreshTime || now >= nextRefreshTime) {
                // Tính thời gian làm mới mới (30 phút từ hiện tại)
                nextRefreshTime = now + REFRESH_TIME_MS;
                localStorage.setItem('nextRefreshTime', nextRefreshTime);
                lastSpinRefreshTime = now;
                localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
            }
            
            // Cập nhật timer ngay lập tức
            updateRefreshTimer();
            
            // Thiết lập timer mới
            refreshTimer = setInterval(updateRefreshTimer, 1000);
        }
        
        // Update refresh timer display
        function updateRefreshTimer() {
            const now = new Date().getTime();
            
            // Đảm bảo nextRefreshTime đã được thiết lập
            if (!nextRefreshTime) {
                nextRefreshTime = lastSpinRefreshTime + REFRESH_TIME_MS;
                localStorage.setItem('nextRefreshTime', nextRefreshTime);
            }
            
            // Tính thời gian còn lại
            let timeLeft = nextRefreshTime - now;
            
            // Nếu thời gian đã hết
            if (timeLeft <= 0) {
                // Thực hiện làm mới lượt quay
                refreshSpins();
                return;
            }
            
            // Hiển thị thời gian còn lại
            const minutes = Math.floor((timeLeft / 1000) / 60);
            const seconds = Math.floor((timeLeft / 1000) % 60);
            timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Highlight khi gần hết thời gian (dưới 2 phút)
            if (minutes < 2) {
                timerValue.classList.add('glow');
            } else {
                timerValue.classList.remove('glow');
            }
        }
        
        // Force check spin reset
        async function forceCheckSpinReset() {
            SOUNDS.click.play();
            
            // Hiển thị trạng thái đang kiểm tra
            updateSyncStatus('syncing', 'Đang kiểm tra lượt quay...');
            
            try {
                if (isOnline) {
                    // Kiểm tra với server
                    const wasReset = await checkSpinResetWithServer();
                    
                    if (!wasReset) {
                        const now = new Date().getTime();
                        
                        // Kiểm tra thời gian còn lại
                        if (nextRefreshTime && now < nextRefreshTime) {
                            const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                            const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                            showNotification(`Chưa đến thời gian làm mới. Còn ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                        } else {
                            // Làm mới lượt quay cưỡng bức
                            refreshSpins();
                        }
                    }
                } else {
                    // Nếu offline, kiểm tra local
                    const now = new Date().getTime();
                    
                    if (nextRefreshTime && now >= nextRefreshTime) {
                        refreshSpins();
                    } else if (nextRefreshTime) {
                        const minutes = Math.floor(((nextRefreshTime - now) / 1000) / 60);
                        const seconds = Math.floor(((nextRefreshTime - now) / 1000) % 60);
                        showNotification(`Chưa đến thời gian làm mới. Còn ${minutes}:${seconds < 10 ? '0' + seconds : seconds}.`);
                    } else {
                        // Nếu không có thông tin thời gian làm mới, làm mới ngay lập tức
                        refreshSpins();
                    }
                }
            } catch (error) {
                console.error("Error checking spin reset:", error);
                showNotification("Lỗi khi kiểm tra làm mới lượt quay.");
            }
        }
        
        // Refresh spins
        function refreshSpins() {
            const now = new Date().getTime();
            
            // Làm mới lượt quay về mức tối đa
            spinsLeft = MAX_SPINS;
            
            // Cập nhật thời gian làm mới
            lastSpinRefreshTime = now;
            nextRefreshTime = now + REFRESH_TIME_MS;
            
            // Lưu vào localStorage
            localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
            localStorage.setItem('nextRefreshTime', nextRefreshTime);
            
            // Cập nhật UI
            updateStats();
            
            // Lưu trạng thái
            saveGameState();
            
            // Hiệu ứng thông báo
            showNotification("Lượt quay đã được làm mới! +50 lượt quay", 5000);
            
            // Thêm hiệu ứng vào số lượt quay
            const spinsElement = document.getElementById('spins-value');
            spinsElement.classList.add('glow');
            setTimeout(() => {
                spinsElement.classList.remove('glow');
            }, 5000);
            
            // Khởi động lại bộ đếm
            restartRefreshTimer();
        }
        
        // Start event countdown timer
        function startEventCountdown() {
            const endDate = new Date('2025-05-01T00:00:00');
            
            function updateCountdown() {
                const now = new Date();
                const timeDiff = endDate - now;
                
                if (timeDiff <= 0) {
                    // Event ended
                    daysValue.textContent = '00';
                    hoursValue.textContent = '00';
                    minutesValue.textContent = '00';
                    secondsValue.textContent = '00';
                    
                    isEventEnded = true;
                    spinBtn.disabled = true;
                    spinBtn.textContent = 'SỰ KIỆN ĐÃ KẾT THÚC';
                    
                    clearInterval(countdownTimer);
                    return;
                }
                
                // Calculate days, hours, minutes, seconds
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                // Update UI
                daysValue.textContent = String(days).padStart(2, '0');
                hoursValue.textContent = String(hours).padStart(2, '0');
                minutesValue.textContent = String(minutes).padStart(2, '0');
                secondsValue.textContent = String(seconds).padStart(2, '0');
                
                // Add pulse effect when time is running low (last 24 hours)
                if (days === 0 && hours < 24) {
                    document.querySelectorAll('.countdown-value').forEach(el => {
                        el.classList.add('glow');
                    });
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            clearInterval(countdownTimer); // Clear any existing timer
            countdownTimer = setInterval(updateCountdown, 1000);
        }

        // Redeem points for rewards
        function redeemPoints() {
            if (!selectedRedeemOption) {
                showResult('⚠️', 'Vui lòng chọn một mức quy đổi!');
                return;
            }
            
            SOUNDS.reward.play();
            
            const amount = parseInt(selectedRedeemOption.getAttribute('data-amount'));
            const requiredPoints = parseInt(selectedRedeemOption.getAttribute('data-points'));
            
            if (points < requiredPoints) {
                showResult('⚠️', `Bạn cần ít nhất ${requiredPoints} điểm để đổi phần thưởng này!`);
                return;
            }
            
            // Deduct points
            points -= requiredPoints;
            updateStats();
            
            // Create reward poster
            generateRewardPoster(amount);
            
            // Update reward card
            rewardValue.textContent = `${amount.toLocaleString()} VNĐ`;
            rewardDate.textContent = new Date().toLocaleDateString('vi-VN');

             // Show reward card with animation
            rewardCard.style.display = 'block';
            
            // Cập nhật nội dung nút phù hợp với môi trường
            updateButtonText();
            
            // Show reward card with animation
            rewardCard.style.display = 'block';
            anime({
                targets: '#reward-card',
                scale: [0.9, 1],
                opacity: [0, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            
            // Reset selection
            selectedRedeemOption.classList.remove('selected');
            selectedRedeemOption = null;
            redeemConfirmBtn.disabled = true;
            
            // Save state
            saveGameState();
            
            // Show success message
            showResult('🎁', `Chúc mừng! Bạn đã đổi thành công ${requiredPoints.toLocaleString()} điểm lấy ${amount.toLocaleString()} VNĐ.`);
            
            // Update redeem button state
            updateRedeemButtonState();
            
            // Create mini celebration
            createConfetti(20);
        }

        // Generate reward poster 
        function generateRewardPoster(amount) {
            // Create a canvas element
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            canvas.width = 600;
            canvas.height = 800;
            
            // Draw background
            ctx.fillStyle = '#fff9e6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw border
            ctx.strokeStyle = '#d82f2f';
            ctx.lineWidth = 10;
            ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
            
            // Draw header
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, 20, canvas.width - 40, 100);
            
            // Draw title
            ctx.font = 'bold 48px Arial';
            ctx.fillStyle = '#ffeb3b';
            ctx.textAlign = 'center';
            ctx.fillText('PHIẾU NHẬN THƯỞNG', canvas.width / 2, 80);
            
            // Draw amount
            ctx.font = 'bold 72px Arial';
            ctx.fillStyle = '#d82f2f';
            ctx.fillText(`${amount.toLocaleString()} VNĐ`, canvas.width / 2, 250);
            
            // Draw player name
            ctx.font = '36px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText(`Người nhận: ${playerName}`, canvas.width / 2, 350);
            
            // Draw date
            const date = new Date().toLocaleDateString('vi-VN');
            ctx.font = '24px Arial';
            ctx.fillText(`Ngày: ${date}`, canvas.width / 2, 400);
            
            // Draw QR code placeholder
            ctx.fillStyle = '#f1f1f1';
            ctx.fillRect(canvas.width / 2 - 100, 450, 200, 200);
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText('Mã QR Hiếu Gà', canvas.width / 2, 550);
            
            // Draw footer
            ctx.fillStyle = '#d82f2f';
            ctx.fillRect(20, canvas.height - 120, canvas.width - 40, 100);
            ctx.fillStyle = '#ffeb3b';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('HIẾU GÀ OFFICIAL', canvas.width / 2, canvas.height - 60);
            
            // Draw user ID in small text
            ctx.fillStyle = '#999';
            ctx.font = '12px Arial';
            ctx.fillText(`ID: ${userId}`, canvas.width / 2, canvas.height - 20);
            
            // Get image URL
            const imageUrl = canvas.toDataURL('image/png');
            
            // Set the reward image
            const img = rewardImage.querySelector('img');
            img.src = imageUrl;
            
            // Store for download
            customPosterImage = imageUrl;
        }

        function saveRewardPoster() {
            SOUNDS.click.play();
            
            // Hiển thị phiếu thưởng dạng popup overlay cho tất cả môi trường
            showPosterOverlay();
            
            // Hiển thị thông báo
            showNotification('Hãy chụp màn hình để lưu phiếu thưởng!');
        }

        // Hiển thị phiếu thưởng dạng overlay toàn màn hình
        function showPosterOverlay() {
            // Xóa overlay cũ nếu có
            const existingOverlay = document.querySelector('.poster-overlay');
            if (existingOverlay) {
                document.body.removeChild(existingOverlay);
            }
            
            // Tạo overlay mới
            const overlay = document.createElement('div');
            overlay.className = 'poster-overlay';
            
            // Tạo container cho poster
            const posterContainer = document.createElement('div');
            posterContainer.className = 'poster-container';
            
            // Tạo gợi ý chụp màn hình
            const screenshotHint = document.createElement('div');
            screenshotHint.className = 'screenshot-hint';
            screenshotHint.innerHTML = '📷 Chụp màn hình ở đây';
            
            // Clone poster từ reward card
            const posterClone = rewardCard.cloneNode(true);
            posterClone.style.display = 'block';
            posterClone.style.width = '100%';
            posterClone.style.maxWidth = '400px';
            posterClone.style.margin = '0 auto';
            posterClone.style.boxShadow = '0 0 30px rgba(216, 47, 47, 0.5)';
            posterClone.style.background = 'linear-gradient(135deg, #ffffff, #fff9e6)';
            
            // Xóa nút lưu từ clone
            const saveBtn = posterClone.querySelector('#save-reward-btn');
            if (saveBtn) saveBtn.remove();
            
            // Thêm poster và gợi ý vào container
            posterContainer.appendChild(screenshotHint);
            posterContainer.appendChild(posterClone);
            
            // Tạo hướng dẫn
            const instructions = document.createElement('div');
            instructions.className = 'poster-instructions';
            instructions.innerHTML = `
                <h3>🔴 Hướng dẫn nhận thưởng 🔴</h3>
                <p>Chụp màn hình phiếu nhận thưởng và gửi cho Hiếu Gà</p>
                <p>Lưu ý: Phiếu chỉ có giá trị khi gửi kèm tên đã đăng ký (${playerName})</p>
            `;
            
            // Tạo container cho các nút
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'poster-buttons';
            
            // Nút chia sẻ nếu đang ở trong môi trường Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                const shareButton = document.createElement('button');
                shareButton.className = 'poster-button share';
                shareButton.innerHTML = '<span>🚀 Gửi cho Hiếu Gà</span>';
                shareButton.addEventListener('click', function() {
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify({
                            action: 'reward_claimed',
                            amount: rewardValue.textContent,
                            user: playerName,
                            userId: userId,
                            date: rewardDate.textContent
                        }));
                        // Đóng overlay
                        document.body.removeChild(overlay);
                    } catch (e) {
                        console.error("Error sharing to Telegram", e);
                    }
                });
                buttonContainer.appendChild(shareButton);
            }
            
            // Nút đóng
            const closeButton = document.createElement('button');
            closeButton.className = 'poster-button close';
            closeButton.textContent = 'Đóng';
            closeButton.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            buttonContainer.appendChild(closeButton);
            
            // Ghép tất cả các thành phần
            overlay.appendChild(posterContainer);
            overlay.appendChild(instructions);
            overlay.appendChild(buttonContainer);
            
            // Thêm vào body
            document.body.appendChild(overlay);
            
            // Áp dụng hiệu ứng
            setTimeout(() => {
                posterContainer.style.transform = 'scale(1)';
            }, 50);
        }

        // Save game state
        async function saveGameState(isExiting = false) {
            // Create game state object
            const gameState = {
                points: points,
                spinsLeft: spinsLeft,
                nextSpinDouble: nextSpinDouble,
                lastUpdate: Date.now(),
                wheelRotation: lastWheelRotation,
                lastSpinRefreshTime: lastSpinRefreshTime,
                isExiting: isExiting
            };
            
            // Save to localStorage
            localStorage.setItem('wheelGameState', JSON.stringify(gameState));
            localStorage.setItem('lastUpdate', gameState.lastUpdate);
            
            // Save to API if online
            if (isOnline && !isSyncingWithServer) {
                try {
                    // Kiểm tra xem người chơi đã nhập tên chưa
                    if (!playerName || playerName.trim() === '') {
                        console.log("Chưa có tên người chơi, chưa lưu lên server");
                        return;
                    }
                    
                    updateSyncStatus('syncing', 'Đang lưu trạng thái...');
                    isSyncingWithServer = true;
                    
                    const response = await fetch(`${API_BASE_URL}/saveScore`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userId,
                            name: playerName,
                            score: points,
                            spinsLeft: spinsLeft,
                            lastSpinRefreshTime: lastSpinRefreshTime,
                            nextSpinDouble: nextSpinDouble,
                            lastUpdate: gameState.lastUpdate
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to save score to server');
                    }
                    
                    const result = await response.json();
                    
                    // Kiểm tra nếu server đã làm mới lượt quay
                    if (result.refreshed) {
                        console.log("Server đã làm mới lượt quay trong quá trình lưu");
                        
                        // Cập nhật dữ liệu từ server
                        spinsLeft = result.player.spinsLeft;
                        lastSpinRefreshTime = result.player.lastSpinRefreshTime;
                        nextRefreshTime = result.player.nextRefreshTime;
                        
                        // Lưu vào localStorage
                        localStorage.setItem('lastSpinRefreshTime', lastSpinRefreshTime);
                        localStorage.setItem('nextRefreshTime', nextRefreshTime);
                        
                        // Cập nhật UI
                        updateStats();
                        restartRefreshTimer();
                        
                        // Thông báo
                        showNotification("Lượt quay đã được làm mới! Bạn có " + spinsLeft + " lượt quay.");
                    }
                    
                    updateSyncStatus('online', 'Đã lưu thành công');
                } catch (err) {
                    console.error("Error saving to API:", err);
                    updateSyncStatus('offline', 'Lưu offline');
                } finally {
                    isSyncingWithServer = false;
                    
                    // Ẩn trạng thái sau 3 giây
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // Save player name
        async function savePlayerName() {
            const newName = playerNameInput.value.trim();
            if (newName) {
                SOUNDS.click.play();
                
                playerName = newName;
                localStorage.setItem('playerName', playerName);
                
                // Save to API
                try {
                    await saveGameState();
                    await loadLeaderboard();
                    
                    // Show confirmation
                    showResult('✅', `Tên "${playerName}" đã được lưu thành công!`);
                    showNotification(`Tên đã cập nhật thành "${playerName}"!`);
                } catch (err) {
                    console.error("Error saving name to API:", err);
                    updateLocalLeaderboard();
                    
                    // Vẫn hiển thị thông báo
                    showNotification(`Tên đã cập nhật thành "${playerName}"! (chế độ offline)`);
                }
            }
        }

        function updateLocalLeaderboard() {
            // Chỉ lưu trữ dữ liệu của người dùng hiện tại
            let leaderboard = [];
            
            // Nếu có điểm, thêm người dùng vào bảng xếp hạng
            if (points > 0 && playerName) {
                leaderboard = [{
                    userId: userId,
                    name: playerName,
                    score: points
                }];
            }
            
            // Lưu vào localStorage để dùng làm cache tạm thời
            localStorage.setItem('localLeaderboard', JSON.stringify(leaderboard));
            
            // Update UI
            updateLeaderboardDisplay(leaderboard);
        }

        // Load leaderboard
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<li class="leaderboard-item"><div class="spinner"></div></li>';
            leaderboardStatus.textContent = 'Đang tải dữ liệu...';
            
            try {
                // Nếu đang offline, sử dụng dữ liệu cục bộ
                if (!isOnline) {
                    const localData = localStorage.getItem('localLeaderboard');
                    if (localData) {
                        const leaderboard = JSON.parse(localData);
                        updateLeaderboardDisplay(leaderboard);
                        leaderboardStatus.textContent = 'Đang hiển thị dữ liệu cục bộ (offline)';
                    } else {
                        updateLocalLeaderboard();
                    }
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/getLeaderboard`);
                
                if (!response.ok) {
                    throw new Error('Failed to load leaderboard');
                }
                
                const leaderboard = await response.json();
                
                if (!leaderboard || leaderboard.length === 0) {
                    throw new Error('No leaderboard data');
                }
                
                // Lưu vào localStorage để dùng khi offline
                localStorage.setItem('serverLeaderboard', JSON.stringify(leaderboard));
                
                updateLeaderboardDisplay(leaderboard);
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
                leaderboardStatus.textContent = `Cập nhật: ${now.toLocaleTimeString('vi-VN', options)}`;
            } catch (err) {
                console.error("Error loading leaderboard:", err);
                
                // Thử dùng dữ liệu từ server đã cache
                const cachedData = localStorage.getItem('serverLeaderboard');
                if (cachedData) {
                    const leaderboard = JSON.parse(cachedData);
                    updateLeaderboardDisplay(leaderboard);
                    leaderboardStatus.textContent = 'Dữ liệu từ lần đồng bộ cuối';
                } else {
                    // Nếu không có dữ liệu cache, hiển thị chỉ người dùng hiện tại
                    updateLocalLeaderboard();
                    leaderboardStatus.textContent = 'Chỉ hiển thị dữ liệu cục bộ';
                }
            }
        }

        function updateLeaderboardDisplay(leaderboard) {
            leaderboardList.innerHTML = '';
            
            // Hiển thị thông báo nếu không có dữ liệu
            if (!leaderboard || leaderboard.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'leaderboard-item';
                emptyItem.style.justifyContent = 'center';
                emptyItem.innerHTML = '<div style="color:#666;font-style:italic;">Chưa có dữ liệu xếp hạng</div>';
                leaderboardList.appendChild(emptyItem);
                return;
            }
            
            // Sort the leaderboard
            leaderboard.sort((a, b) => b.score - a.score);
            
            // Limit to top 10
            const topScores = leaderboard.slice(0, 10);
            
            topScores.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                const isCurrentPlayer = player.userId === userId;
                if (isCurrentPlayer) {
                    li.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
                }
                
                // Add extra effects for top 3 places
                let specialEffect = '';
                if (index === 0) {
                    specialEffect = 'float';
                } else if (index === 1 || index === 2) {
                    specialEffect = 'pulse';
                }
                
                li.innerHTML = `
                    <div class="leaderboard-rank ${index < 3 ? specialEffect : ''}">${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${player.name}${isCurrentPlayer ? ' (Bạn)' : ''}</div>
                    </div>
                    <div class="leaderboard-score">${player.score.toLocaleString()}</div>
                `;
                
                leaderboardList.appendChild(li);
            });
            
            // Animation for leaderboard items
            anime({
                targets: '.leaderboard-item',
                translateX: [20, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                easing: 'easeOutQuad'
            });
        }

        // Update leaderboard
        async function updateLeaderboard() {
            // First update the local leaderboard as fallback
            updateLocalLeaderboard();
            
            // Then try to update via API
            try {
                if (isOnline) {
                    // Wait for saveGameState to complete
                    await saveGameState();
                    
                    // Only reload leaderboard sometimes to reduce API calls
                    if (Math.random() < 0.3) {
                        await loadLeaderboard();
                    }
                }
            } catch (err) {
                console.error("Error updating leaderboard:", err);
            }
        }

        // Adjust wheel size
        function adjustWheelSize() {
            // Function placeholder to adjust wheel size on various devices
            // Add implementation if needed
        }

        // Event listeners
        spinBtn.addEventListener('click', spinWheel);
        saveRewardBtn.addEventListener('click', saveRewardPoster);
        saveNameBtn.addEventListener('click', savePlayerName);

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
