<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cờ Chiến Thắng - Game 30/4</title>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.2.4/dist/pixi.min.js"></script>
    <style>
        :root {
            --primary-color: #d22730;
            --secondary-color: #ffff00;
            --text-color: #ffffff;
            --background-color: #f5f5f5;
            --control-bg: rgba(210, 39, 48, 0.7);
            --shop-bg: rgba(0, 0, 0, 0.8);
        }
        
        .dark {
            --primary-color: #c41e2a;
            --secondary-color: #ffff00;
            --text-color: #ffffff;
            --background-color: #181818;
            --control-bg: rgba(196, 30, 42, 0.8);
            --shop-bg: rgba(20, 20, 20, 0.9);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: var(--background-color);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        
        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #joystickContainer {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 120px;
            height: 120px;
            pointer-events: auto;
        }
        
        #joystickBase {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--control-bg);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #joystickKnob {
            width: 50%;
            height: 50%;
            border-radius: 50%;
            background: var(--secondary-color);
            position: relative;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        #collectButton {
            position: absolute;
            bottom: 120px;
            right: 50px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--control-bg);
            border: 3px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-color);
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        
        #collectButtonIcon {
            width: 40px;
            height: 40px;
        }
        
        #scoreContainer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--control-bg);
            padding: 10px 15px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #flagIcon {
            width: 24px;
            height: 16px;
        }
        
        #goldContainer {
            position: absolute;
            top: 65px;
            left: 20px;
            background: var(--control-bg);
            padding: 10px 15px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #goldIcon {
            width: 20px;
            height: 20px;
            background-color: #FFD700;
            border-radius: 50%;
            border: 2px solid #B8860B;
        }
        
        #shopButton, #leaderboardButton {
            position: absolute;
            top: 20px;
            padding: 10px 15px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            background: var(--control-bg);
            pointer-events: auto;
            cursor: pointer;
        }
        
        #shopButton {
            right: 160px;
        }
        
        #leaderboardButton {
            right: 20px;
        }
        
        #shopPanel, #leaderboardPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background: var(--shop-bg);
            border-radius: 15px;
            padding: 20px;
            color: var(--text-color);
            pointer-events: auto;
            display: none;
            z-index: 20;
        }
        
        .panel-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }
        
        #shopItemsContainer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .shop-item-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .shop-item-price {
            color: gold;
        }
        
        .shop-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #closeShop, #closeLeaderboard {
            display: block;
            margin: 20px auto 0;
            padding: 8px 20px;
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #leaderboardList {
            list-style: none;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .leaderboard-rank {
            width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .leaderboard-name {
            flex: 1;
            margin: 0 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .leaderboard-score {
            width: 50px;
            text-align: right;
        }
        
        #introScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            padding: 20px;
        }
        
        #gameTitle {
            color: var(--primary-color);
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        #gameTitle span {
            color: var(--secondary-color);
        }
        
        #nameInput {
            margin: 20px 0;
            padding: 15px;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            font-size: 16px;
            text-align: center;
        }
        
        #startButton {
            padding: 15px 40px;
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #startButton:active {
            transform: scale(0.95);
        }
        
        #connectionStatus {
            position: absolute;
            top: 110px;
            left: 20px;
            background: var(--control-bg);
            padding: 5px 10px;
            border-radius: 10px;
            color: var(--text-color);
            font-size: 14px;
        }
        
        #gameMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        
        #shieldIndicator {
            position: absolute;
            top: 70px;
            right: 20px;
            background: var(--control-bg);
            padding: 10px 15px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 16px;
            display: none;
        }
        
        #enemyAlert {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        @media (max-width: 767px) {
            #joystickContainer {
                bottom: 80px;
                left: 30px;
                width: 100px;
                height: 100px;
            }
            
            #collectButton {
                bottom: 100px;
                right: 30px;
                width: 70px;
                height: 70px;
            }
            
            #collectButtonIcon {
                width: 35px;
                height: 35px;
            }
            
            #gameTitle {
                font-size: 28px;
            }
            
            #shopButton {
                right: 120px;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            #leaderboardButton {
                right: 15px;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            #shopItemsContainer {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="gameUI">
            <div id="joystickContainer">
                <div id="joystickBase">
                    <div id="joystickKnob"></div>
                </div>
            </div>
            <div id="collectButton">
                <svg id="collectButtonIcon" viewBox="0 0 24 24" fill="white">
                    <path d="M12,5.5l7,7H5l7-7M12,1L3,10h18L12,1z M12,16.5l-7-7h14l-7,7M12,21l9-9H3L12,21z"/>
                </svg>
            </div>
            <div id="scoreContainer">
                <svg id="flagIcon" viewBox="0 0 24 16">
                    <rect x="0" y="0" width="24" height="16" fill="#d22730"/>
                    <polygon points="12,3 14,8 19,8 15,11 17,16 12,13 7,16 9,11 5,8 10,8" fill="#ffff00"/>
                </svg>
                <span id="scoreValue">0</span>
            </div>
            <div id="goldContainer">
                <div id="goldIcon"></div>
                <span id="goldValue">0</span>
            </div>
            <div id="connectionStatus">Chế độ Vô Tận</div>
            <div id="shopButton">Cửa Hàng</div>
            <div id="leaderboardButton">Thành tích</div>
            <div id="gameMessage"></div>
            <div id="shieldIndicator">Khiên bảo vệ: <span id="shieldTime">0</span>s</div>
            <div id="enemyAlert">Kẻ cướp đang tiếp cận!</div>
        </div>
        
        <div id="shopPanel">
            <h2 class="panel-title">Cửa Hàng</h2>
            <div id="shopItemsContainer">
                <div class="shop-item" data-item="BOMB">
                    <div class="shop-item-icon">
                        <svg viewBox="0 0 24 24" width="40" height="40">
                            <circle cx="12" cy="12" r="10" fill="black"/>
                            <circle cx="12" cy="4" r="3" fill="#DD0000"/>
                        </svg>
                    </div>
                    <div class="shop-item-name">Bom</div>
                    <div class="shop-item-price">200 Vàng</div>
                </div>
                <div class="shop-item" data-item="SHIELD">
                    <div class="shop-item-icon">
                        <svg viewBox="0 0 24 24" width="40" height="40">
                            <circle cx="12" cy="12" r="10" fill="rgba(0,136,255,0.7)"/>
                            <circle cx="12" cy="12" r="8" fill="none" stroke="#0055AA" stroke-width="2"/>
                            <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">S</text>
                        </svg>
                    </div>
                    <div class="shop-item-name">Khiên</div>
                    <div class="shop-item-price">300 Vàng</div>
                </div>
                <div class="shop-item" data-item="SPEED">
                    <div class="shop-item-icon">
                        <svg viewBox="0 0 24 24" width="40" height="40">
                            <path d="M12,2 L3,9 L3,22 L21,22 L21,9 Z" fill="#cccccc"/>
                            <polygon points="12,6 18,12 12,18 6,12" fill="#ffaa00"/>
                        </svg>
                    </div>
                    <div class="shop-item-name">Tốc độ</div>
                    <div class="shop-item-price">500 Vàng</div>
                </div>
                <div class="shop-item" data-item="MAGNET">
                    <div class="shop-item-icon">
                        <svg viewBox="0 0 24 24" width="40" height="40">
                            <path d="M6,4 L18,4 C20,4 20,6 20,8 L20,16 L16,20 L8,20 L4,16 L4,8 C4,6 4,4 6,4 Z" fill="#ff5555"/>
                            <path d="M8,4 L8,12 L12,16 L16,12 L16,4 Z" fill="#aa0000"/>
                        </svg>
                    </div>
                    <div class="shop-item-name">Nam châm</div>
                    <div class="shop-item-price">800 Vàng</div>
                </div>
            </div>
            <button id="closeShop">Đóng</button>
        </div>
        
        <div id="leaderboardPanel">
            <h2 class="panel-title">Thành tích cao nhất</h2>
            <ul id="leaderboardList"></ul>
            <button id="closeLeaderboard">Đóng</button>
        </div>
        
        <div id="introScreen">
            <h1 id="gameTitle">CỜ <span>CHIẾN THẮNG</span></h1>
            <p style="color: white; text-align: center; margin-bottom: 15px;">Tự hào kỷ niệm ngày Giải phóng miền Nam 30/4</p>
            <input type="text" id="nameInput" placeholder="Nhập tên của bạn" maxlength="15">
            <button id="startButton">BẮT ĐẦU CHƠI</button>
        </div>
    </div>

    <script>
        // Xử lý chế độ màu (Dark/Light)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Các thiết lập game
        const GAME_CONFIG = {
            CHUNK_SIZE: 1000,           // Kích thước mỗi chunk của bản đồ
            ACTIVE_CHUNKS_RADIUS: 3,    // Số chunk hoạt động xung quanh người chơi
            PLAYER_SPEED: 4,            // Giảm tốc độ xe tăng (1/3 so với trước)
            COLLECT_DISTANCE: 120,      // Khoảng cách có thể nhặt items
            FIREWORK_COUNT: 30,
            SEED: Date.now(),           // Seed cho việc tạo vị trí ngẫu nhiên giống nhau
            TANK_SCALE: 0.08,           // Giảm kích thước xe tăng (1/3 so với trước)
            TANK_ROTATION_OFFSET: Math.PI/2, // Xoay tank thêm 90 độ
            FLAG_SCALE: 0.5,            // Tỉ lệ kích thước lá cờ
            ITEM_SPAWN_CHANCE: {        // Tỉ lệ xuất hiện các item
                FLAG: 0.15,             // Cờ tăng tỉ lệ xuất hiện (15%) 
                GOLD: 0.30,             // Vàng phổ biến (30%)
                BOMB: 0.05,             // Bom ít hiếm (5%)
                SHIELD: 0.03            // Khiên rất hiếm (3%)
            },
            ITEM_SPAWN_INTERVAL: 2000,  // Thời gian kiểm tra spawn (2 giây)
            ITEM_VALUE: {               // Giá trị điểm của các item
                FLAG: 1,
                GOLD: 100,
                BOMB: -50,
                SHIELD: 0
            },
            MAX_ITEMS_PER_CHUNK: 10,    // Số lượng item tối đa mỗi chunk
            SHOP_PRICES: {              // Giá các item trong shop
                BOMB: 200,
                SHIELD: 300,
                SPEED: 500,
                MAGNET: 800
            },
            SPEED_BOOST_DURATION: 30000, // Thời gian tăng tốc (30 giây)
            SPEED_BOOST_MULTIPLIER: 1.5, // Hệ số tăng tốc
            MAGNET_DURATION: 20000,     // Thời gian hút item (20 giây)
            MAGNET_RADIUS: 300,         // Bán kính hút
            ENEMY_SPAWN_INTERVAL: 60000, // Thời gian xuất hiện kẻ thù (60 giây)
            ENEMY_SPEED: 3,             // Tốc độ kẻ thù
            ENEMY_DETECTION_RADIUS: 500, // Bán kính phát hiện kẻ thù
            CLOUD_COUNT: 20,            // Số lượng đám mây
            CLOUD_MOVE_SPEED: 0.2       // Tốc độ di chuyển của mây
        };

        // Class người chơi
        class Player {
            constructor(id, name, x, y) {
                this.id = id;
                this.name = name;
                this.x = x;
                this.y = y;
                this.score = 0;
                this.gold = 0;
                this.angle = 0;
                this.speedX = 0;
                this.speedY = 0;
                this.inventory = {
                    BOMB: 0,
                    SHIELD: 0
                };
                this.speedBoostEndTime = 0;
                this.magnetEndTime = 0;
            }
        }
        
        // Class Enemy
        class Enemy {
            constructor(id, x, y, targetPlayer) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.targetPlayer = targetPlayer;
                this.speed = GAME_CONFIG.ENEMY_SPEED;
                this.angle = 0;
                this.active = true;
                this.health = 100;
            }
            
            update(delta) {
                if (!this.active || !this.targetPlayer) return;
                
                // Calculate direction to player
                const dx = this.targetPlayer.x - this.x;
                const dy = this.targetPlayer.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // If close enough, try to steal a flag
                if (distance < 50) {
                    this.tryStealFlag();
                    return;
                }
                
                // Move towards player
                this.angle = Math.atan2(dy, dx);
                const speedX = Math.cos(this.angle) * this.speed;
                const speedY = Math.sin(this.angle) * this.speed;
                
                this.x += speedX * delta;
                this.y += speedY * delta;
            }
            
            tryStealFlag() {
                // Only try once
                if (!this.active) return;
                
                // Check if player has flags
                if (this.targetPlayer.score > 0) {
                    this.targetPlayer.score -= 1;
                    
                    // Alert player
                    const alert = document.getElementById('enemyAlert');
                    alert.textContent = 'Kẻ cướp đã lấy 1 lá cờ của bạn!';
                    alert.style.opacity = '1';
                    setTimeout(() => {
                        alert.style.opacity = '0';
                    }, 3000);
                }
                
                // Go inactive for a while
                this.active = false;
                setTimeout(() => {
                    this.active = true;
                }, 5000);
            }
            
            takeDamage(amount) {
                this.health -= amount;
                if (this.health <= 0) {
                    this.active = false;
                    return true; // Enemy defeated
                }
                return false;
            }
        }

        // Item class
        class Item {
            constructor(id, type, x, y) {
                this.id = id;
                this.type = type; // 'FLAG', 'GOLD', 'BOMB', 'SHIELD'
                this.x = x;
                this.y = y;
                this.collected = false;
                this.collectedBy = null;
            }
        }
        
        // Cloud class
        class Cloud {
            constructor(x, y, scale, speed) {
                this.x = x;
                this.y = y;
                this.scale = scale;
                this.speed = speed;
                this.sprite = null;
            }
            
            update() {
                this.x += this.speed;
                
                // Wrap around when off-screen
                if (this.x > GAME_CONFIG.CHUNK_SIZE * 5) {
                    this.x = -GAME_CONFIG.CHUNK_SIZE * 5;
                }
                
                if (this.sprite) {
                    this.sprite.x = this.x;
                }
            }
        }
        
        class Game {
            constructor() {
                this.app = null;
                this.gameStarted = false;
                this.player = null;
                this.players = {};
                this.items = [];
                this.enemies = [];
                this.clouds = [];
                this.mapContainer = null;
                this.skyContainer = null;
                this.backgroundContainer = null;
                this.decorationContainer = null;
                this.playerContainer = null;
                this.itemContainer = null;
                this.enemyContainer = null;
                this.playerSprites = {};
                this.itemSprites = {};
                this.enemySprites = {};
                this.lastTimestamp = 0;
                this.lastItemGeneration = 0;
                this.lastEnemySpawn = 0;
                this.joystickActive = false;
                this.joystickAngle = 0;
                this.joystickStrength = 0;
                this.collectButtonActive = false;
                this.collectCooldown = false;
                this.shopVisible = false;
                this.leaderboardVisible = false;
                this.randomGenerator = null;
                this.highScore = 0;
                this.playerTexture = null;
                this.enemyTexture = null;
                this.activeChunks = new Set();
                this.chunkDecorations = {};
                this.nextItemId = 0;
                this.shieldActive = false;
                this.shieldEndTime = 0;
                this.speedBoostActive = false;
                this.speedBoostEndTime = 0;
                this.magnetActive = false;
                this.magnetEndTime = 0;
            }

            // Khởi tạo game
            init() {
                // Khởi tạo PIXI.js
                this.app = new PIXI.Application({
                    view: document.getElementById('gameCanvas'),
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x87CEEB, // Màu nền bầu trời
                    resolution: window.devicePixelRatio || 1,
                    antialias: true,
                    autoDensity: true,
                });

                // Tạo map container
                this.mapContainer = new PIXI.Container();
                this.app.stage.addChild(this.mapContainer);
                
                // Tạo container cho bầu trời và mây
                this.skyContainer = new PIXI.Container();
                this.mapContainer.addChild(this.skyContainer);

                // Tạo container cho nền
                this.backgroundContainer = new PIXI.Container();
                this.mapContainer.addChild(this.backgroundContainer);
                
                // Tạo container cho trang trí
                this.decorationContainer = new PIXI.Container();
                this.mapContainer.addChild(this.decorationContainer);

                // Tạo container cho các item
                this.itemContainer = new PIXI.Container();
                this.mapContainer.addChild(this.itemContainer);
                
                // Tạo container cho kẻ thù
                this.enemyContainer = new PIXI.Container();
                this.mapContainer.addChild(this.enemyContainer);

                // Tạo container cho người chơi - đảm bảo ở trên cùng
                this.playerContainer = new PIXI.Container();
                this.mapContainer.addChild(this.playerContainer);

                // Tạo random generator với seed cố định
                this.randomGenerator = this.createRandomGenerator(GAME_CONFIG.SEED);

                // Tải hình ảnh xe tăng 
                this.loadTextures().then(() => {
                    // Vẽ bản đồ
                    this.createMap();
                    
                    // Tạo các đám mây
                    this.createClouds();

                    // Xử lý sự kiện resize
                    window.addEventListener('resize', () => this.handleResize());
                    this.handleResize();

                    // Khởi tạo các điều khiển game
                    this.initControls();

                    // Khởi tạo UI sự kiện
                    this.initUIEvents();

                    // Tải dữ liệu từ localStorage nếu có
                    this.loadGameState();

                    // Lấy điểm cao nhất
                    this.highScore = parseInt(localStorage.getItem('highScore') || '0');

                    // Cập nhật trạng thái kết nối
                    document.getElementById('connectionStatus').textContent = 'Chế độ Vô Tận';

                    // Bắt đầu vòng lặp game
                    this.app.ticker.add(this.gameLoop.bind(this));
                });
            }

            // Tải texture cho xe tăng và kẻ thù
            async loadTextures() {
                return new Promise((resolve) => {
                    try {
                        const tankUrl = 'https://img.upanh.tv/2025/04/29/ChatGPT-Image-12_31_11-29-thg-4-2025.png';
                        
                        // Tạo texture dự phòng trước khi tải
                        const graphics = new PIXI.Graphics();
                        graphics.beginFill(0x5D5CDE);
                        graphics.drawRect(-32, -32, 64, 64);
                        graphics.endFill();
                        this.playerTexture = this.app.renderer.generateTexture(graphics);
                        
                        // Texture cho kẻ thù (xe tăng đỏ)
                        const enemyGraphics = new PIXI.Graphics();
                        enemyGraphics.beginFill(0xFF0000);
                        enemyGraphics.drawRect(-32, -32, 64, 64);
                        enemyGraphics.endFill();
                        this.enemyTexture = this.app.renderer.generateTexture(enemyGraphics);
                        
                        // Tải hình ảnh xe tăng
                        const img = new Image();
                        img.crossOrigin = "Anonymous";
                        img.onload = () => {
                            this.playerTexture = PIXI.Texture.from(img);
                            console.log("Tank texture loaded successfully");
                            
                            // Sử dụng texture tương tự cho kẻ thù nhưng với màu khác
                            this.enemyTexture = PIXI.Texture.from(img);
                            resolve();
                        };
                        img.onerror = (e) => {
                            console.error("Error loading tank image:", e);
                            // Đã có texture dự phòng, tiếp tục
                            resolve();
                        };
                        img.src = tankUrl;
                    } catch (error) {
                        console.error("Error in loadTextures:", error);
                        // Đảm bảo luôn có texture dự phòng nếu có lỗi
                        if (!this.playerTexture) {
                            const graphics = new PIXI.Graphics();
                            graphics.beginFill(0x5D5CDE);
                            graphics.drawRect(-32, -32, 64, 64);
                            graphics.endFill();
                            this.playerTexture = this.app.renderer.generateTexture(graphics);
                        }
                        resolve();
                    }
                });
            }

            // Tạo random generator với seed cố định để đảm bảo các vị trí giống nhau trên mọi máy
            createRandomGenerator(seed) {
                return {
                    _seed: seed,
                    next: function() {
                        this._seed = (this._seed * 9301 + 49297) % 233280;
                        return this._seed / 233280;
                    },
                    nextInt: function(min, max) {
                        return Math.floor(min + this.next() * (max - min + 1));
                    }
                };
            }

            // Tạo bản đồ game vô tận
            createMap() {
                // Vẽ nền cỏ cho bản đồ (nền cỏ sẽ được vô hạn)
                const grass = new PIXI.Graphics();
                grass.beginFill(0x5EB45E);
                grass.drawRect(-GAME_CONFIG.CHUNK_SIZE * 5, -GAME_CONFIG.CHUNK_SIZE * 5, 
                               GAME_CONFIG.CHUNK_SIZE * 10, GAME_CONFIG.CHUNK_SIZE * 10);
                grass.endFill();
                this.backgroundContainer.addChild(grass);

                // Tạo biểu tượng kỷ niệm 30/4 ở trung tâm (0,0)
                const centerFlag = new PIXI.Graphics();
                centerFlag.beginFill(0xd22730);
                centerFlag.drawRect(-150, -100, 300, 200);
                centerFlag.endFill();
                
                centerFlag.beginFill(0xffff00);
                this.drawStar(centerFlag, 0, 0, 5, 60, 30);
                centerFlag.endFill();
                
                this.decorationContainer.addChild(centerFlag);
                
                // Thêm các trang trí kỷ niệm ngày 30/4
                
                // Thêm đài tưởng niệm đơn giản
                const monument = new PIXI.Graphics();
                monument.beginFill(0xDDDDDD);
                monument.drawRect(-30, -200, 60, 180);
                monument.endFill();
                
                // Đế đài tưởng niệm
                monument.beginFill(0xAAAAAA);
                monument.drawRect(-50, -20, 100, 20);
                monument.endFill();
                
                // Các bậc thang
                monument.beginFill(0xCCCCCC);
                monument.drawRect(-80, 0, 160, 15);
                monument.drawRect(-100, 15, 200, 15);
                monument.endFill();
                
                // Ngọn lửa trên đài
                const flame = new PIXI.Graphics();
                flame.beginFill(0xFF5500);
                flame.drawCircle(0, -210, 20);
                flame.endFill();
                
                // Hiệu ứng nhấp nháy cho ngọn lửa
                this.app.ticker.add(() => {
                    const scale = 0.9 + Math.sin(this.app.ticker.lastTime / 300) * 0.2;
                    flame.scale.set(scale, scale);
                    
                    // Màu của lửa thay đổi
                    const red = 1;
                    const green = 0.3 + Math.sin(this.app.ticker.lastTime / 500) * 0.2;
                    const blue = 0;
                    flame.tint = PIXI.utils.rgb2hex([red, green, blue]);
                });
                
                monument.addChild(flame);
                monument.x = 300;
                monument.y = 300;
                this.decorationContainer.addChild(monument);
                
                // Thêm biểu ngữ kỷ niệm
                const banner = new PIXI.Graphics();
                banner.beginFill(0xd22730);
                banner.drawRect(-300, -50, 600, 100);
                banner.endFill();
                
                const text = new PIXI.Text("CHÀO MỪNG NGÀY GIẢI PHÓNG\nMIỀN NAM 30/4", {
                    fontFamily: "Arial",
                    fontSize: 28,
                    fill: 0xffff00,
                    align: "center",
                    fontWeight: "bold"
                });
                text.anchor.set(0.5, 0.5);
                banner.addChild(text);
                
                banner.x = -400;
                banner.y = 250;
                banner.rotation = -0.1;
                this.decorationContainer.addChild(banner);
                
                // Tạo một số cờ trang trí cố định
                const decorationFlags = [
                    {x: -200, y: -300},
                    {x: 200, y: -300},
                    {x: -350, y: 100},
                    {x: 350, y: 100}
                ];
                
                decorationFlags.forEach((pos, i) => {
                    const flagPole = new PIXI.Graphics();
                    flagPole.beginFill(0x8B4513);
                    flagPole.drawRect(-5, 0, 10, 150);
                    flagPole.endFill();
                    
                    const flag = new PIXI.Graphics();
                    flag.beginFill(0xd22730);
                    flag.drawRect(0, 0, 80, 50);
                    flag.endFill();
                    
                    flag.beginFill(0xffff00);
                    this.drawStar(flag, 40, 25, 5, 15, 8);
                    flag.endFill();
                    
                    flag.x = 5;
                    flag.y = 10;
                    
                    // Hiệu ứng phấp phới
                    this.app.ticker.add(() => {
                        flag.skew.y = Math.sin(this.app.ticker.lastTime / 500 + i) * 0.1;
                    });
                    
                    flagPole.addChild(flag);
                    flagPole.x = pos.x;
                    flagPole.y = pos.y;
                    this.decorationContainer.addChild(flagPole);
                });
                
                const memorial = new PIXI.Text("30/4", {
                    fontFamily: "Arial",
                    fontSize: 72,
                    fill: 0xd22730,
                    fontWeight: "bold",
                    stroke: 0xffff00,
                    strokeThickness: 8
                });
                memorial.anchor.set(0.5, 0.5);
                memorial.x = 0;
                memorial.y = 150;
                this.decorationContainer.addChild(memorial);
                
                // Cập nhật các chunk ban đầu xung quanh vị trí ban đầu (0,0)
                this.updateActiveChunks(0, 0);
            }
            
            // Tạo các đám mây
            createClouds() {
                for (let i = 0; i < GAME_CONFIG.CLOUD_COUNT; i++) {
                    // Vị trí ngẫu nhiên trong phạm vi rộng
                    const x = this.randomGenerator.nextInt(-GAME_CONFIG.CHUNK_SIZE * 5, GAME_CONFIG.CHUNK_SIZE * 5);
                    const y = this.randomGenerator.nextInt(-500, 0);
                    
                    // Kích thước và tốc độ ngẫu nhiên
                    const scale = 0.8 + this.randomGenerator.next() * 1.5;
                    const speed = (0.5 + this.randomGenerator.next()) * GAME_CONFIG.CLOUD_MOVE_SPEED;
                    
                    const cloud = new Cloud(x, y, scale, speed);
                    this.clouds.push(cloud);
                    
                    // Vẽ đám mây
                    const cloudSprite = new PIXI.Graphics();
                    
                    // Màu trắng cho đám mây
                    cloudSprite.beginFill(0xFFFFFF, 0.8);
                    
                    // Vẽ các quả cầu tròn chồng lên nhau để tạo hình dạng đám mây
                    const baseSize = 30 * scale;
                    cloudSprite.drawCircle(0, 0, baseSize);
                    cloudSprite.drawCircle(baseSize, 0, baseSize * 0.7);
                    cloudSprite.drawCircle(-baseSize, 0, baseSize * 0.7);
                    cloudSprite.drawCircle(baseSize * 0.5, -baseSize * 0.5, baseSize * 0.7);
                    cloudSprite.drawCircle(-baseSize * 0.5, -baseSize * 0.5, baseSize * 0.7);
                    cloudSprite.endFill();
                    
                    cloudSprite.x = x;
                    cloudSprite.y = y;
                    cloudSprite.alpha = 0.8; // Trong suốt một chút
                    
                    this.skyContainer.addChild(cloudSprite);
                    cloud.sprite = cloudSprite;
                }
            }
            
            // Cập nhật chuyển động của mây
            updateClouds() {
                for (const cloud of this.clouds) {
                    cloud.update();
                }
            }
            
            // Lấy ID của chunk dựa vào tọa độ
            getChunkId(x, y) {
                const chunkX = Math.floor(x / GAME_CONFIG.CHUNK_SIZE);
                const chunkY = Math.floor(y / GAME_CONFIG.CHUNK_SIZE);
                return `${chunkX},${chunkY}`;
            }
            
            // Tạo nội dung ngẫu nhiên cho một chunk
            createChunk(chunkId) {
                if (this.chunkDecorations[chunkId]) return;
                
                const [chunkX, chunkY] = chunkId.split(',').map(Number);
                const startX = chunkX * GAME_CONFIG.CHUNK_SIZE;
                const startY = chunkY * GAME_CONFIG.CHUNK_SIZE;
                
                // Container cho chunk này
                const chunkContainer = new PIXI.Container();
                chunkContainer.x = startX;
                chunkContainer.y = startY;
                
                // Tạo seed ngẫu nhiên nhưng ổn định cho chunk này
                const chunkSeed = this.hashString(`${GAME_CONFIG.SEED}-${chunkId}`);
                const chunkRandom = this.createRandomGenerator(chunkSeed);
                
                // Tạo cây cối và các yếu tố trang trí trong chunk
                const treeCount = chunkRandom.nextInt(10, 25);
                const bushCount = chunkRandom.nextInt(15, 30);
                const flowerCount = chunkRandom.nextInt(20, 40);
                
                // Tạo cây
                for (let i = 0; i < treeCount; i++) {
                    const treeSize = chunkRandom.nextInt(30, 60);
                    const treeX = chunkRandom.nextInt(20, GAME_CONFIG.CHUNK_SIZE - 20);
                    const treeY = chunkRandom.nextInt(20, GAME_CONFIG.CHUNK_SIZE - 20);
                    
                    const tree = new PIXI.Graphics();
                    // Thân cây
                    tree.beginFill(0x8B4513);
                    tree.drawRect(-5, 0, 10, 20);
                    tree.endFill();
                    
                    // Tán lá
                    tree.beginFill(0x2E8B57);
                    tree.drawCircle(0, -15, treeSize / 2);
                    tree.endFill();
                    
                    // Đổ bóng đơn giản
                    const shadow = new PIXI.Graphics();
                    shadow.beginFill(0x000000, 0.3);
                    shadow.drawEllipse(0, 20, treeSize / 3, 5);
                    shadow.endFill();
                    
                    tree.addChild(shadow);
                    tree.x = treeX;
                    tree.y = treeY;
                    
                    chunkContainer.addChild(tree);
                }
                
                // Tạo bụi cây
                for (let i = 0; i < bushCount; i++) {
                    const bushSize = chunkRandom.nextInt(15, 25);
                    const bushX = chunkRandom.nextInt(10, GAME_CONFIG.CHUNK_SIZE - 10);
                    const bushY = chunkRandom.nextInt(10, GAME_CONFIG.CHUNK_SIZE - 10);
                    
                    const bush = new PIXI.Graphics();
                    bush.beginFill(0x3CB371);
                    bush.drawCircle(0, 0, bushSize / 2);
                    bush.endFill();
                    
                    // Đổ bóng đơn giản
                    const shadow = new PIXI.Graphics();
                    shadow.beginFill(0x000000, 0.2);
                    shadow.drawEllipse(0, bushSize/2, bushSize / 3, 3);
                    shadow.endFill();
                    
                    bush.addChild(shadow);
                    bush.x = bushX;
                    bush.y = bushY;
                    
                    chunkContainer.addChild(bush);
                }
                
                // Tạo hoa
                for (let i = 0; i < flowerCount; i++) {
                    const flowerX = chunkRandom.nextInt(5, GAME_CONFIG.CHUNK_SIZE - 5);
                    const flowerY = chunkRandom.nextInt(5, GAME_CONFIG.CHUNK_SIZE - 5);
                    const flowerColor = [0xFF69B4, 0xFFFF00, 0xFF6347, 0x9370DB, 0xFF4500][chunkRandom.nextInt(0, 4)];
                    
                    const flower = new PIXI.Graphics();
                    flower.beginFill(flowerColor);
                    flower.drawCircle(0, 0, 3);
                    flower.endFill();
                    
                    flower.x = flowerX;
                    flower.y = flowerY;
                    
                    chunkContainer.addChild(flower);
                }
                
                // Thêm container chunk vào decorationContainer
                this.decorationContainer.addChild(chunkContainer);
                
                // Lưu reference cho chunk này
                this.chunkDecorations[chunkId] = {
                    container: chunkContainer,
                    items: []
                };
                
                // Khả năng tạo đường đi trong chunk (40%)
                if (chunkRandom.next() < 0.4) {
                    const isHorizontal = chunkRandom.next() < 0.5;
                    const pathWidth = 30;
                    
                    const path = new PIXI.Graphics();
                    path.beginFill(0xDEB887);
                    
                    if (isHorizontal) {
                        const y = chunkRandom.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                        path.drawRect(0, y - pathWidth/2, GAME_CONFIG.CHUNK_SIZE, pathWidth);
                    } else {
                        const x = chunkRandom.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                        path.drawRect(x - pathWidth/2, 0, pathWidth, GAME_CONFIG.CHUNK_SIZE);
                    }
                    
                    path.endFill();
                    chunkContainer.addChild(path);
                }
                
                // Thêm trang trí ngày 30/4 ngẫu nhiên (10% mỗi chunk)
                if (chunkRandom.next() < 0.1) {
                    const decX = chunkRandom.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                    const decY = chunkRandom.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                    
                    const decorationType = chunkRandom.nextInt(0, 1);
                    
                    if (decorationType === 0) {
                        // Cờ đỏ sao vàng
                        const flagPole = new PIXI.Graphics();
                        flagPole.beginFill(0x8B4513);
                        flagPole.drawRect(-3, 0, 6, 100);
                        flagPole.endFill();
                        
                        const flag = new PIXI.Graphics();
                        flag.beginFill(0xd22730);
                        flag.drawRect(0, 0, 60, 40);
                        flag.endFill();
                        
                        flag.beginFill(0xffff00);
                        this.drawStar(flag, 30, 20, 5, 12, 6);
                        flag.endFill();
                        
                        flag.x = 3;
                        flag.y = 10;
                        
                        // Hiệu ứng phấp phới
                        const waveIndex = chunkRandom.nextInt(0, 1000); // Random offset
                        this.app.ticker.add(() => {
                            flag.skew.y = Math.sin(this.app.ticker.lastTime / 500 + waveIndex) * 0.1;
                        });
                        
                        flagPole.addChild(flag);
                        flagPole.x = decX;
                        flagPole.y = decY;
                        chunkContainer.addChild(flagPole);
                    } else {
                        // Banner
                        const banner = new PIXI.Graphics();
                        banner.beginFill(0xd22730);
                        banner.drawRect(-80, -20, 160, 40);
                        banner.endFill();
                        
                        const text = new PIXI.Text("30/4", {
                            fontFamily: "Arial",
                            fontSize: 20,
                            fill: 0xffff00,
                            align: "center",
                            fontWeight: "bold"
                        });
                        text.anchor.set(0.5, 0.5);
                        banner.addChild(text);
                        
                        banner.x = decX;
                        banner.y = decY;
                        banner.rotation = chunkRandom.next() * 0.3 - 0.15;
                        chunkContainer.addChild(banner);
                    }
                }
                
                return chunkId;
            }
            
            // Hash string thành số
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash);
            }
            
            // Cập nhật các chunk active khi người chơi di chuyển
            updateActiveChunks() {
                if (!this.player) return;
                
                const currentChunkId = this.getChunkId(this.player.x, this.player.y);
                const [currentChunkX, currentChunkY] = currentChunkId.split(',').map(Number);
                
                // Tạo set để lưu các chunk mới cần active
                const newActiveChunks = new Set();
                
                // Duyệt qua các chunk xung quanh người chơi
                for (let dx = -GAME_CONFIG.ACTIVE_CHUNKS_RADIUS; dx <= GAME_CONFIG.ACTIVE_CHUNKS_RADIUS; dx++) {
                    for (let dy = -GAME_CONFIG.ACTIVE_CHUNKS_RADIUS; dy <= GAME_CONFIG.ACTIVE_CHUNKS_RADIUS; dy++) {
                        const chunkId = `${currentChunkX + dx},${currentChunkY + dy}`;
                        newActiveChunks.add(chunkId);
                        
                        // Tạo chunk nếu chưa tồn tại
                        if (!this.chunkDecorations[chunkId]) {
                            this.createChunk(chunkId);
                        }
                    }
                }
                
                // Ẩn các chunk không còn active
                for (const chunkId of this.activeChunks) {
                    if (!newActiveChunks.has(chunkId) && this.chunkDecorations[chunkId]) {
                        this.chunkDecorations[chunkId].container.visible = false;
                    }
                }
                
                // Hiện các chunk đang active
                for (const chunkId of newActiveChunks) {
                    if (this.chunkDecorations[chunkId]) {
                        this.chunkDecorations[chunkId].container.visible = true;
                    }
                }
                
                // Cập nhật set active chunks
                this.activeChunks = newActiveChunks;
            }
            
            // Kiểm tra và tạo các item mới
            checkItemGeneration() {
                const now = Date.now();
                if (now - this.lastItemGeneration < GAME_CONFIG.ITEM_SPAWN_INTERVAL) return;
                
                this.lastItemGeneration = now;
                
                // Cơ hội tạo item mới khi người chơi di chuyển
                if (Math.abs(this.player.speedX) < 0.1 && Math.abs(this.player.speedY) < 0.1) return;
                
                const currentChunkId = this.getChunkId(this.player.x, this.player.y);
                
                // Kiểm tra số lượng item trong chunk hiện tại
                if (!this.chunkDecorations[currentChunkId]) return;
                
                const chunkItems = this.chunkDecorations[currentChunkId].items || [];
                if (chunkItems.length >= GAME_CONFIG.MAX_ITEMS_PER_CHUNK) return;
                
                // Xác định loại item sẽ tạo
                let itemType = null;
                const rand = Math.random();
                
                if (rand < GAME_CONFIG.ITEM_SPAWN_CHANCE.FLAG) {
                    itemType = 'FLAG';
                } else if (rand < GAME_CONFIG.ITEM_SPAWN_CHANCE.FLAG + GAME_CONFIG.ITEM_SPAWN_CHANCE.GOLD) {
                    itemType = 'GOLD';
                } else if (rand < GAME_CONFIG.ITEM_SPAWN_CHANCE.FLAG + GAME_CONFIG.ITEM_SPAWN_CHANCE.GOLD + GAME_CONFIG.ITEM_SPAWN_CHANCE.BOMB) {
                    itemType = 'BOMB';
                } else if (rand < GAME_CONFIG.ITEM_SPAWN_CHANCE.FLAG + GAME_CONFIG.ITEM_SPAWN_CHANCE.GOLD + GAME_CONFIG.ITEM_SPAWN_CHANCE.BOMB + GAME_CONFIG.ITEM_SPAWN_CHANCE.SHIELD) {
                    itemType = 'SHIELD';
                }
                
                if (!itemType) return;
                
                // Xác định vị trí item trong phạm vi gần người chơi (200-500 đơn vị)
                const angle = Math.random() * Math.PI * 2;
                const distance = 200 + Math.random() * 300;
                const itemX = this.player.x + Math.cos(angle) * distance;
                const itemY = this.player.y + Math.sin(angle) * distance;
                
                // Tạo item mới
                this.createItem(itemType, itemX, itemY);
            }
            
            // Tạo item mới
            createItem(type, x, y) {
                const itemId = 'item_' + this.nextItemId++;
                const item = new Item(itemId, type, x, y);
                this.items.push(item);
                
                // Tạo sprite cho item
                const itemGraphic = new PIXI.Container();
                
                // Dựa vào loại item, tạo sprite tương ứng
                let itemSprite;
                
                switch (type) {
                    case 'FLAG':
                        // Tạo cờ Việt Nam
                        itemSprite = new PIXI.Graphics();
                        // Nền đỏ
                        itemSprite.beginFill(0xd22730);
                        itemSprite.drawRect(-15 * GAME_CONFIG.FLAG_SCALE, -10 * GAME_CONFIG.FLAG_SCALE, 
                                     30 * GAME_CONFIG.FLAG_SCALE, 20 * GAME_CONFIG.FLAG_SCALE);
                        itemSprite.endFill();
                        
                        // Ngôi sao vàng
                        itemSprite.beginFill(0xffff00);
                        this.drawStar(itemSprite, 0, 0, 5, 8 * GAME_CONFIG.FLAG_SCALE, 4 * GAME_CONFIG.FLAG_SCALE);
                        itemSprite.endFill();
                        
                        // Thêm cột cờ
                        itemSprite.beginFill(0x8B4513);
                        itemSprite.drawRect(-17 * GAME_CONFIG.FLAG_SCALE, -10 * GAME_CONFIG.FLAG_SCALE, 
                                    2 * GAME_CONFIG.FLAG_SCALE, 30 * GAME_CONFIG.FLAG_SCALE);
                        itemSprite.endFill();
                        
                        // Hiệu ứng rung lắc
                        this.app.ticker.add(() => {
                            itemSprite.rotation = Math.sin(this.app.ticker.lastTime / 500 + this.nextItemId) * 0.05;
                        });
                        break;
                        
                    case 'GOLD':
                        // Tạo đồng tiền vàng
                        itemSprite = new PIXI.Graphics();
                        itemSprite.beginFill(0xFFD700);
                        itemSprite.drawCircle(0, 0, 12);
                        itemSprite.endFill();
                        
                        // Viền
                        itemSprite.lineStyle(2, 0xFFAA00);
                        itemSprite.drawCircle(0, 0, 10);
                        
                        // Chữ "100"
                        const valueText = new PIXI.Text("100", {
                            fontFamily: "Arial",
                            fontSize: 8,
                            fill: 0x8B4513,
                            fontWeight: "bold"
                        });
                        valueText.anchor.set(0.5, 0.5);
                        itemSprite.addChild(valueText);
                        
                        // Hiệu ứng nhấp nháy
                        this.app.ticker.add(() => {
                            itemSprite.alpha = 0.8 + Math.sin(this.app.ticker.lastTime / 300) * 0.2;
                        });
                        break;
                        
                    case 'BOMB':
                        // Tạo quả bom
                        itemSprite = new PIXI.Graphics();
                        itemSprite.beginFill(0x000000);
                        itemSprite.drawCircle(0, 0, 15);
                        itemSprite.endFill();
                        
                        // Ngòi nổ
                        itemSprite.beginFill(0xDD0000);
                        itemSprite.drawCircle(0, -15, 5);
                        itemSprite.endFill();
                        
                        // Hiệu ứng nhấp nháy đỏ
                        this.app.ticker.add(() => {
                            const red = 0.5 + Math.sin(this.app.ticker.lastTime / 200) * 0.5;
                            itemSprite.tint = PIXI.utils.rgb2hex([1, red, red]);
                        });
                        break;
                        
                    case 'SHIELD':
                        // Tạo khiên bảo vệ
                        itemSprite = new PIXI.Graphics();
                        itemSprite.beginFill(0x0088FF, 0.7);
                        itemSprite.drawCircle(0, 0, 15);
                        itemSprite.endFill();
                        
                        // Viền khiên
                        itemSprite.lineStyle(3, 0x0055AA);
                        itemSprite.drawCircle(0, 0, 13);
                        
                        // Chữ "S"
                        const shieldText = new PIXI.Text("S", {
                            fontFamily: "Arial",
                            fontSize: 14,
                            fill: 0xFFFFFF,
                            fontWeight: "bold"
                        });
                        shieldText.anchor.set(0.5, 0.5);
                        itemSprite.addChild(shieldText);
                        
                        // Hiệu ứng nhấp nháy
                        this.app.ticker.add(() => {
                            itemSprite.alpha = 0.7 + Math.sin(this.app.ticker.lastTime / 200) * 0.3;
                        });
                        break;
                }
                
                itemGraphic.addChild(itemSprite);
                itemGraphic.x = x;
                itemGraphic.y = y;
                
                this.itemContainer.addChild(itemGraphic);
                
                this.itemSprites[itemId] = {
                    sprite: itemGraphic,
                    itemSprite
                };
                
                // Thêm item vào chunk tương ứng
                const chunkId = this.getChunkId(x, y);
                if (this.chunkDecorations[chunkId]) {
                    if (!this.chunkDecorations[chunkId].items) {
                        this.chunkDecorations[chunkId].items = [];
                    }
                    this.chunkDecorations[chunkId].items.push(itemId);
                }
                
                return item;
            }
            
            // Tạo kẻ thù (xe tăng địch)
            createEnemy() {
                if (!this.player) return;
                
                // Đặt enemy ở vị trí cách người chơi một khoảng
                const angle = Math.random() * Math.PI * 2;
                const distance = GAME_CONFIG.ENEMY_DETECTION_RADIUS + 200; // Outside detection radius
                const x = this.player.x + Math.cos(angle) * distance;
                const y = this.player.y + Math.sin(angle) * distance;
                
                const enemyId = 'enemy_' + Date.now();
                const enemy = new Enemy(enemyId, x, y, this.player);
                this.enemies.push(enemy);
                
                // Tạo sprite cho kẻ thù
                const enemyGraphic = new PIXI.Container();
                
                // Sử dụng texture xe tăng tương tự nhưng màu đỏ
                const tank = new PIXI.Sprite(this.enemyTexture);
                tank.anchor.set(0.5, 0.5);
                tank.scale.set(GAME_CONFIG.TANK_SCALE);
                tank.tint = 0xFF0000; // Màu đỏ
                tank.rotation = GAME_CONFIG.TANK_ROTATION_OFFSET;
                
                enemyGraphic.addChild(tank);
                
                // Đổ bóng đơn giản
                const shadow = new PIXI.Graphics();
                shadow.beginFill(0x000000, 0.3);
                shadow.drawEllipse(0, 5, 20, 10);
                shadow.endFill();
                shadow.y = 20;
                enemyGraphic.addChild(shadow);
                
                // Hiển thị thanh máu
                const healthBar = new PIXI.Graphics();
                healthBar.beginFill(0xFF0000);
                healthBar.drawRect(-15, -40, 30, 5);
                healthBar.endFill();
                enemyGraphic.addChild(healthBar);
                
                enemyGraphic.x = x;
                enemyGraphic.y = y;
                
                this.enemyContainer.addChild(enemyGraphic);
                
                this.enemySprites[enemyId] = {
                    sprite: enemyGraphic,
                    tank,
                    healthBar
                };
                
                // Hiển thị cảnh báo
                const alert = document.getElementById('enemyAlert');
                alert.textContent = 'Kẻ cướp đang tiếp cận!';
                alert.style.opacity = '1';
                setTimeout(() => {
                    alert.style.opacity = '0';
                }, 3000);
                
                return enemy;
            }
            
            // Cập nhật kẻ thù
            updateEnemies(delta) {
                if (!this.player) return;
                
                // Kiểm tra thời gian tạo kẻ thù mới
                const now = Date.now();
                if (now - this.lastEnemySpawn > GAME_CONFIG.ENEMY_SPAWN_INTERVAL) {
                    this.lastEnemySpawn = now;
                    this.createEnemy();
                }
                
                // Cập nhật vị trí và trạng thái của kẻ thù
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    
                    // Nếu kẻ thù không hoạt động, loại bỏ
                    if (!enemy.active) {
                        if (this.enemySprites[enemy.id]) {
                            this.enemyContainer.removeChild(this.enemySprites[enemy.id].sprite);
                            delete this.enemySprites[enemy.id];
                        }
                        this.enemies.splice(i, 1);
                        continue;
                    }
                    
                    // Cập nhật vị trí kẻ thù
                    enemy.update(delta);
                    
                    // Cập nhật sprite kẻ thù
                    if (this.enemySprites[enemy.id]) {
                        this.enemySprites[enemy.id].sprite.x = enemy.x;
                        this.enemySprites[enemy.id].sprite.y = enemy.y;
                        this.enemySprites[enemy.id].tank.rotation = enemy.angle + GAME_CONFIG.TANK_ROTATION_OFFSET;
                        
                        // Cập nhật thanh máu
                        const healthBar = this.enemySprites[enemy.id].healthBar;
                        healthBar.clear();
                        healthBar.beginFill(0xFF0000);
                        healthBar.drawRect(-15, -40, 30 * (enemy.health / 100), 5);
                        healthBar.endFill();
                    }
                    
                    // Kiểm tra va chạm với đạn (bomb)
                    if (this.player.usedBomb) {
                        const dx = enemy.x - this.player.x;
                        const dy = enemy.y - this.player.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 200) { // Bán kính nổ của bom
                            if (enemy.takeDamage(100)) { // Bom gây 100 đơn vị sát thương
                                this.showGameMessage("Đã tiêu diệt kẻ cướp!");
                            }
                        }
                        
                        // Reset trạng thái sử dụng bom
                        this.player.usedBomb = false;
                    }
                }
            }

            // Vẽ ngôi sao
            drawStar(graphics, x, y, points, outerRadius, innerRadius) {
                const startAngle = -Math.PI / 2; // Bắt đầu từ đỉnh trên
                const step = Math.PI / points;
                
                // Di chuyển đến điểm đầu tiên
                let angle = startAngle;
                const firstX = x + Math.cos(angle) * outerRadius;
                const firstY = y + Math.sin(angle) * outerRadius;
                graphics.moveTo(firstX, firstY);
                
                // Vẽ các điểm của ngôi sao
                for (let i = 1; i < points * 2; i++) {
                    angle += step;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const pointX = x + Math.cos(angle) * radius;
                    const pointY = y + Math.sin(angle) * radius;
                    graphics.lineTo(pointX, pointY);
                }
                
                // Kết nối lại với điểm đầu tiên
                graphics.lineTo(firstX, firstY);
            }

            // Khởi tạo người chơi với hình ảnh xe tăng
            createPlayer(id, name, x, y) {
                const player = new Player(id, name, x, y);
                
                // Tạo container cho người chơi
                const playerGraphic = new PIXI.Container();
                
                // Đổ bóng đơn giản
                const shadow = new PIXI.Graphics();
                shadow.beginFill(0x000000, 0.3);
                shadow.drawEllipse(0, 0, 20, 10);
                shadow.endFill();
                shadow.y = 20;
                playerGraphic.addChild(shadow);
                
                // Tạo sprite xe tăng từ texture đã tải
                const tank = new PIXI.Sprite(this.playerTexture);
                tank.anchor.set(0.5, 0.5);
                tank.scale.set(GAME_CONFIG.TANK_SCALE);
                // Xoay thêm 90 độ để mũi súng chỉ về đúng hướng di chuyển
                tank.rotation = GAME_CONFIG.TANK_ROTATION_OFFSET;
                
                playerGraphic.addChild(tank);
                
                // Tạo text tên người chơi
                const nameText = new PIXI.Text(name, {
                    fontFamily: "Arial",
                    fontSize: 16,
                    fill: 0xFFFFFF,
                    align: "center",
                    fontWeight: "bold",
                    stroke: 0x000000,
                    strokeThickness: 3
                });
                nameText.anchor.set(0.5, 0.5);
                nameText.y = -35;
                
                playerGraphic.addChild(nameText);
                
                // Điểm số
                const scoreText = new PIXI.Text("0", {
                    fontFamily: "Arial",
                    fontSize: 14,
                    fill: 0xFFFF00,
                    align: "center",
                    fontWeight: "bold",
                    stroke: 0x000000,
                    strokeThickness: 2
                });
                scoreText.anchor.set(0.5, 0.5);
                scoreText.y = 35;
                
                playerGraphic.addChild(scoreText);
                
                // Hiệu ứng khiên (ban đầu ẩn)
                const shield = new PIXI.Graphics();
                shield.beginFill(0x0088FF, 0.3);
                shield.drawCircle(0, 0, 40);
                shield.endFill();
                shield.visible = false;
                
                playerGraphic.addChild(shield);
                
                playerGraphic.x = x;
                playerGraphic.y = y;
                
                this.playerContainer.addChild(playerGraphic);
                
                this.playerSprites[id] = {
                    sprite: playerGraphic,
                    scoreText,
                    tank,
                    shield,
                    shadow
                };
                
                return player;
            }

            // Cập nhật trạng thái người chơi
            updatePlayer(player) {
                if (!this.playerSprites[player.id]) {
                    this.createPlayer(player.id, player.name, player.x, player.y);
                    this.players[player.id] = player;
                }
                
                const playerSprite = this.playerSprites[player.id].sprite;
                const scoreText = this.playerSprites[player.id].scoreText;
                const tank = this.playerSprites[player.id].tank;
                
                playerSprite.x = player.x;
                playerSprite.y = player.y;
                // Áp dụng góc xoay với offset để mũi súng luôn chỉ về hướng di chuyển
                tank.rotation = player.angle + GAME_CONFIG.TANK_ROTATION_OFFSET;
                scoreText.text = player.score.toString();
                
                // Cập nhật hiển thị vàng
                document.getElementById('goldValue').textContent = player.gold.toString();
                
                this.players[player.id] = player;
                
                // Kiểm tra và cập nhật các chunk khi người chơi di chuyển
                this.updateActiveChunks();
                
                // Kiểm tra và tạo item mới khi người chơi di chuyển
                this.checkItemGeneration();
                
                // Kiểm tra hiệu ứng nam châm
                if (this.magnetActive) {
                    this.applyMagnetEffect();
                }
            }
            
            // Áp dụng hiệu ứng nam châm
            applyMagnetEffect() {
                if (!this.player) return;
                
                // Tìm các item gần người chơi
                for (const item of this.items) {
                    if (item.collected) continue;
                    
                    const dx = this.player.x - item.x;
                    const dy = this.player.y - item.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    // Nếu trong bán kính hút
                    if (dist < GAME_CONFIG.MAGNET_RADIUS) {
                        // Di chuyển item về phía người chơi
                        const speed = 0.1;
                        const angle = Math.atan2(dy, dx);
                        
                        // Cập nhật vị trí item
                        item.x += Math.cos(angle) * speed * dist;
                        item.y += Math.sin(angle) * speed * dist;
                        
                        // Cập nhật vị trí sprite
                        if (this.itemSprites[item.id]) {
                            this.itemSprites[item.id].sprite.x = item.x;
                            this.itemSprites[item.id].sprite.y = item.y;
                        }
                        
                        // Nếu đủ gần, thu thập item
                        if (dist < 20) {
                            this.collectItem(item);
                        }
                    }
                }
            }

            // Kiểm tra va chạm với item
            checkItemCollision(x, y, distance = GAME_CONFIG.COLLECT_DISTANCE) {
                for (const item of this.items) {
                    if (!item.collected) {
                        const dx = item.x - x;
                        const dy = item.y - y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist <= distance) {
                            return item;
                        }
                    }
                }
                
                return null;
            }
            
            // Thu thập item
            collectItem(item) {
                if (!this.player || item.collected) return;
                
                // Đánh dấu item đã được nhặt
                item.collected = true;
                item.collectedBy = this.player.id;
                
                // Xử lý item theo loại
                switch (item.type) {
                    case 'FLAG':
                        // Cờ: +1 điểm và hiệu ứng pháo hoa
                        this.player.score += GAME_CONFIG.ITEM_VALUE.FLAG;
                        this.createFireworks(item.x, item.y);
                        this.showGameMessage("Đã nhặt được 1 lá cờ! +1 điểm");
                        break;
                        
                    case 'GOLD':
                        // Vàng: +100 vàng
                        this.player.gold += 100;
                        this.showGameMessage("Đã nhặt được 100 vàng!");
                        break;
                        
                    case 'BOMB':
                        // Thêm bomb vào túi đồ
                        this.player.inventory.BOMB += 1;
                        this.showGameMessage("Đã nhặt được 1 quả bom!");
                        break;
                        
                    case 'SHIELD':
                        // Thêm khiên vào túi đồ
                        this.player.inventory.SHIELD += 1;
                        this.showGameMessage("Đã nhặt được 1 khiên bảo vệ!");
                        break;
                }
                
                // Cập nhật điểm số hiển thị
                document.getElementById('scoreValue').textContent = this.player.score;
                document.getElementById('goldValue').textContent = this.player.gold;
                
                // Cập nhật điểm cao nếu cần
                if (this.player.score > this.highScore) {
                    this.highScore = this.player.score;
                    localStorage.setItem('highScore', this.highScore.toString());
                }
                
                // Ẩn sprite item
                if (this.itemSprites[item.id]) {
                    this.itemSprites[item.id].sprite.visible = false;
                }
                
                // Lưu trạng thái game
                this.saveGameState();
                
                // Hiệu ứng âm thanh hoặc hình ảnh khi nhặt item
                this.playSoundEffect(item.type);
            }

            // Thử nhặt item
            tryCollectItem() {
                if (!this.player || this.collectCooldown) return;
                
                const nearbyItem = this.checkItemCollision(
                    this.player.x,
                    this.player.y
                );
                
                if (nearbyItem) {
                    this.collectItem(nearbyItem);
                    
                    // Hiệu ứng cooldown
                    this.collectCooldown = true;
                    document.getElementById('collectButton').style.opacity = '0.5';
                    
                    setTimeout(() => {
                        this.collectCooldown = false;
                        document.getElementById('collectButton').style.opacity = '1';
                    }, 500);
                }
            }
            
            // Hiệu ứng âm thanh (giả lập bằng hiệu ứng rung)
            playSoundEffect(itemType) {
                // Rung nhẹ game container
                const gameContainer = document.getElementById('gameContainer');
                gameContainer.style.transition = 'none';
                
                switch (itemType) {
                    case 'FLAG':
                        gameContainer.style.transform = 'translate(2px, 2px)';
                        setTimeout(() => {
                            gameContainer.style.transform = 'translate(-2px, -2px)';
                            setTimeout(() => {
                                gameContainer.style.transform = 'translate(0, 0)';
                                gameContainer.style.transition = 'transform 0.3s';
                            }, 50);
                        }, 50);
                        break;
                        
                    case 'GOLD':
                        gameContainer.style.transform = 'translate(1px, 1px)';
                        setTimeout(() => {
                            gameContainer.style.transform = 'translate(-1px, -1px)';
                            setTimeout(() => {
                                gameContainer.style.transform = 'translate(0, 0)';
                                gameContainer.style.transition = 'transform 0.3s';
                            }, 30);
                        }, 30);
                        break;
                        
                    case 'BOMB':
                    case 'SHIELD':
                        gameContainer.style.transform = 'translate(3px, 3px)';
                        setTimeout(() => {
                            gameContainer.style.transform = 'translate(-3px, -3px)';
                            setTimeout(() => {
                                gameContainer.style.transform = 'translate(0, 0)';
                                gameContainer.style.transition = 'transform 0.3s';
                            }, 70);
                        }, 70);
                        break;
                }
            }

            // Mua item từ shop
            buyItem(itemType) {
                if (!this.player) return false;
                
                // Kiểm tra giá
                const price = GAME_CONFIG.SHOP_PRICES[itemType];
                if (!price || this.player.gold < price) {
                    this.showGameMessage("Không đủ vàng để mua!", 2000);
                    return false;
                }
                
                // Trừ vàng
                this.player.gold -= price;
                
                // Xử lý theo loại item
                switch (itemType) {
                    case 'BOMB':
                        this.player.inventory.BOMB += 1;
                        this.showGameMessage("Đã mua 1 quả bom!", 2000);
                        break;
                        
                    case 'SHIELD':
                        this.player.inventory.SHIELD += 1;
                        this.showGameMessage("Đã mua 1 khiên bảo vệ!", 2000);
                        break;
                        
                    case 'SPEED':
                        // Kích hoạt tăng tốc
                        this.speedBoostActive = true;
                        this.speedBoostEndTime = Date.now() + GAME_CONFIG.SPEED_BOOST_DURATION;
                        this.showGameMessage("Tăng tốc trong 30 giây!", 2000);
                        break;
                        
                    case 'MAGNET':
                        // Kích hoạt nam châm
                        this.magnetActive = true;
                        this.magnetEndTime = Date.now() + GAME_CONFIG.MAGNET_DURATION;
                        this.showGameMessage("Nam châm hoạt động trong 20 giây!", 2000);
                        break;
                }
                
                // Cập nhật hiển thị vàng
                document.getElementById('goldValue').textContent = this.player.gold;
                
                // Lưu trạng thái game
                this.saveGameState();
                
                return true;
            }
            
            // Kích hoạt khiên
            activateShield() {
                if (!this.player || this.player.inventory.SHIELD <= 0) return false;
                
                // Trừ khiên trong túi đồ
                this.player.inventory.SHIELD -= 1;
                
                // Kích hoạt khiên
                this.shieldActive = true;
                this.shieldEndTime = Date.now() + 30000; // 30 giây
                
                // Hiển thị hiệu ứng khiên
                if (this.playerSprites[this.player.id]) {
                    this.playerSprites[this.player.id].shield.visible = true;
                }
                
                // Hiển thị thời gian còn lại
                document.getElementById('shieldIndicator').style.display = 'block';
                document.getElementById('shieldTime').textContent = '30';
                
                this.showGameMessage("Đã kích hoạt khiên bảo vệ! (30 giây)");
                
                // Lưu trạng thái game
                this.saveGameState();
                
                return true;
            }
            
            // Sử dụng bom
            useBomb() {
                if (!this.player || this.player.inventory.BOMB <= 0) return false;
                
                // Trừ bom trong túi đồ
                this.player.inventory.BOMB -= 1;
                
                // Đánh dấu đã sử dụng bom
                this.player.usedBomb = true;
                
                // Hiệu ứng nổ
                this.createExplosion(this.player.x, this.player.y);
                
                this.showGameMessage("Đã sử dụng bom!");
                
                // Lưu trạng thái game
                this.saveGameState();
                
                return true;
            }
            
            // Tạo hiệu ứng nổ
            createExplosion(x, y) {
                // Vòng tròn nổ
                const explosion = new PIXI.Graphics();
                explosion.beginFill(0xFF5500, 0.7);
                explosion.drawCircle(0, 0, 20);
                explosion.endFill();
                
                explosion.x = x;
                explosion.y = y;
                
                this.mapContainer.addChild(explosion);
                
                // Hiệu ứng phóng to rồi mờ dần
                let size = 20;
                const maxSize = 200;
                const speed = 10;
                
                const explosionTicker = () => {
                    size += speed;
                    explosion.clear();
                    explosion.beginFill(0xFF5500, 0.7 * (1 - size/maxSize));
                    explosion.drawCircle(0, 0, size);
                    explosion.endFill();
                    
                    if (size >= maxSize) {
                        this.mapContainer.removeChild(explosion);
                        this.app.ticker.remove(explosionTicker);
                    }
                };
                
                this.app.ticker.add(explosionTicker);
                
                // Tạo thêm các mảnh vỡ
                for (let i = 0; i < 20; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 4;
                    const size = 2 + Math.random() * 4;
                    const lifespan = 500 + Math.random() * 500;
                    
                    const particle = new PIXI.Graphics();
                    particle.beginFill(0xFF5500);
                    particle.drawCircle(0, 0, size);
                    particle.endFill();
                    
                    particle.x = x;
                    particle.y = y;
                    particle.vx = Math.cos(angle) * speed;
                    particle.vy = Math.sin(angle) * speed;
                    particle.alpha = 1;
                    particle.createdAt = Date.now();
                    particle.lifespan = lifespan;
                    
                    this.mapContainer.addChild(particle);
                    
                    const particleTicker = () => {
                        const age = Date.now() - particle.createdAt;
                        if (age >= particle.lifespan) {
                            this.mapContainer.removeChild(particle);
                            this.app.ticker.remove(particleTicker);
                        } else {
                            particle.x += particle.vx;
                            particle.y += particle.vy;
                            particle.alpha = 1 - (age / particle.lifespan);
                        }
                    };
                    
                    this.app.ticker.add(particleTicker);
                }
            }

            // Cập nhật trạng thái khiên bảo vệ
            updateShieldStatus() {
                if (!this.shieldActive) return;
                
                const now = Date.now();
                if (now >= this.shieldEndTime) {
                    // Kết thúc hiệu ứng khiên
                    this.shieldActive = false;
                    if (this.playerSprites[this.player.id]) {
                        this.playerSprites[this.player.id].shield.visible = false;
                    }
                    document.getElementById('shieldIndicator').style.display = 'none';
                } else {
                    // Cập nhật thời gian còn lại
                    const secondsLeft = Math.ceil((this.shieldEndTime - now) / 1000);
                    document.getElementById('shieldTime').textContent = secondsLeft;
                }
            }
            
            // Cập nhật trạng thái tăng tốc
            updateSpeedBoostStatus() {
                const now = Date.now();
                if (this.speedBoostActive && now >= this.speedBoostEndTime) {
                    // Kết thúc hiệu ứng tăng tốc
                    this.speedBoostActive = false;
                    this.showGameMessage("Hết hiệu lực tăng tốc!");
                }
            }
            
            // Cập nhật trạng thái nam châm
            updateMagnetStatus() {
                const now = Date.now();
                if (this.magnetActive && now >= this.magnetEndTime) {
                    // Kết thúc hiệu ứng nam châm
                    this.magnetActive = false;
                    this.showGameMessage("Hết hiệu lực nam châm!");
                }
            }

            // Xử lý resize cửa sổ
            handleResize() {
                this.app.renderer.resize(window.innerWidth, window.innerHeight);
                this.centerCamera();
            }

            // Khởi tạo các điều khiển game
            initControls() {
                const joystickBase = document.getElementById('joystickBase');
                const joystickKnob = document.getElementById('joystickKnob');
                const collectButton = document.getElementById('collectButton');
                
                // Xử lý joystick cho di chuyển
                this.setupJoystick(joystickBase, joystickKnob);
                
                // Xử lý nút nhặt cờ
                collectButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!this.collectCooldown) {
                        this.collectButtonActive = true;
                        this.tryCollectItem();
                    }
                });
                collectButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.collectButtonActive = false;
                });
                collectButton.addEventListener('mousedown', (e) => {
                    if (!this.collectCooldown) {
                        this.collectButtonActive = true;
                        this.tryCollectItem();
                    }
                });
                collectButton.addEventListener('mouseup', () => {
                    this.collectButtonActive = false;
                });
                
                // Xử lý phím tắt
                document.addEventListener('keydown', (e) => {
                    if (!this.gameStarted || !this.player) return;
                    
                    switch (e.key) {
                        case 'b': // Sử dụng bom
                            this.useBomb();
                            break;
                            
                        case 's': // Kích hoạt khiên
                            this.activateShield();
                            break;
                            
                        case 'Escape': // Đóng shop/bảng xếp hạng
                            if (this.shopVisible) {
                                this.toggleShop();
                            } else if (this.leaderboardVisible) {
                                this.toggleLeaderboard();
                            }
                            break;
                    }
                });
            }

            // Thiết lập joystick
            setupJoystick(base, knob) {
                const baseBounds = base.getBoundingClientRect();
                const baseRadius = baseBounds.width / 2;
                const knobRadius = knob.offsetWidth / 2;
                const maxDistance = baseRadius - knobRadius;
                
                let isActive = false;
                let touchId = null;
                
                // Reset joystick
                const resetKnob = () => {
                    knob.style.transform = `translate(0px, 0px)`;
                    this.joystickActive = false;
                    this.joystickAngle = 0;
                    this.joystickStrength = 0;
                };
                
                // Xử lý di chuyển joystick
                const moveJoystick = (clientX, clientY) => {
                    const bounds = base.getBoundingClientRect();
                    const centerX = bounds.left + bounds.width / 2;
                    const centerY = bounds.top + bounds.height / 2;
                    const deltaX = clientX - centerX;
                    const deltaY = clientY - centerY;
                    
                    const distance = Math.min(Math.hypot(deltaX, deltaY), maxDistance);
                    const angle = Math.atan2(deltaY, deltaX);
                    
                    const moveX = distance * Math.cos(angle);
                    const moveY = distance * Math.sin(angle);
                    
                    knob.style.transform = `translate(${moveX}px, ${moveY}px)`;
                    
                    this.joystickActive = true;
                    this.joystickAngle = angle;
                    this.joystickStrength = distance / maxDistance;
                };
                
                // Xử lý sự kiện chuột
                base.addEventListener('mousedown', (e) => {
                    isActive = true;
                    moveJoystick(e.clientX, e.clientY);
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isActive) {
                        moveJoystick(e.clientX, e.clientY);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (isActive) {
                        isActive = false;
                        resetKnob();
                    }
                });
                
                // Xử lý sự kiện cảm ứng
                base.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!isActive && e.touches.length > 0) {
                        isActive = true;
                        touchId = e.touches[0].identifier;
                        moveJoystick(e.touches[0].clientX, e.touches[0].clientY);
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (isActive) {
                        e.preventDefault();
                        for (let i = 0; i < e.changedTouches.length; i++) {
                            const touch = e.changedTouches[i];
                            if (touch.identifier === touchId) {
                                moveJoystick(touch.clientX, touch.clientY);
                                break;
                            }
                        }
                    }
                });
                
                document.addEventListener('touchend', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        if (isActive && touch.identifier === touchId) {
                            isActive = false;
                            touchId = null;
                            resetKnob();
                            break;
                        }
                    }
                });
                
                document.addEventListener('touchcancel', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        if (isActive && touch.identifier === touchId) {
                            isActive = false;
                            touchId = null;
                            resetKnob();
                            break;
                        }
                    }
                });
            }

            // Khởi tạo các sự kiện UI
            initUIEvents() {
                const startButton = document.getElementById('startButton');
                const nameInput = document.getElementById('nameInput');
                const shopButton = document.getElementById('shopButton');
                const closeShop = document.getElementById('closeShop');
                const leaderboardButton = document.getElementById('leaderboardButton');
                const closeLeaderboard = document.getElementById('closeLeaderboard');
                
                // Tải tên người chơi từ localStorage nếu có
                const savedName = localStorage.getItem('playerName');
                if (savedName) {
                    nameInput.value = savedName;
                }
                
                // Xử lý nút bắt đầu chơi - Sử dụng function thay vì arrow function để đảm bảo binding đúng
                startButton.addEventListener('click', function() {
                    try {
                        console.log("Start button clicked");
                        
                        let playerName = nameInput.value.trim();
                        if (!playerName) playerName = `Player${Math.floor(Math.random() * 1000)}`;
                        if (playerName.length > 15) playerName = playerName.substring(0, 15);
                        
                        // Lưu tên người chơi
                        try {
                            localStorage.setItem('playerName', playerName);
                        } catch (e) {
                            console.log("Could not save player name to localStorage");
                        }
                        
                        // Khởi tạo người chơi ở trung tâm bản đồ (0,0)
                        const playerX = 0;
                        const playerY = 0;
                        
                        // Tạo ID cho người chơi
                        const playerId = 'player_' + Date.now();
                        
                        // Kiểm tra xem có dữ liệu đã lưu không
                        let x = playerX;
                        let y = playerY;
                        let score = 0;
                        let gold = 0;
                        
                        try {
                            const savedPlayerData = localStorage.getItem('playerData');
                            if (savedPlayerData) {
                                const savedPlayer = JSON.parse(savedPlayerData);
                                x = savedPlayer.x || playerX;
                                y = savedPlayer.y || playerY;
                                score = savedPlayer.score || 0;
                                gold = savedPlayer.gold || 0;
                            }
                        } catch (e) {
                            console.log("Could not load saved player data", e);
                            // Use defaults
                        }
                        
                        // Make sure we have a valid texture before creating the player
                        if (!game.playerTexture) {
                            // Create fallback texture if missing
                            const graphics = new PIXI.Graphics();
                            graphics.beginFill(0x5D5CDE);
                            graphics.drawRect(-32, -32, 64, 64);
                            graphics.endFill();
                            game.playerTexture = game.app.renderer.generateTexture(graphics);
                        }
                        
                        game.player = game.createPlayer(playerId, playerName, x, y);
                        game.player.score = score;
                        game.player.gold = gold;
                        
                        // Cập nhật điểm số hiển thị
                        document.getElementById('scoreValue').textContent = score;
                        document.getElementById('goldValue').textContent = gold;
                        game.playerSprites[playerId].scoreText.text = score.toString();
                        
                        // Ẩn màn hình giới thiệu
                        document.getElementById('introScreen').style.display = 'none';
                        
                        // Khôi phục trạng thái các item và khiên
                        try {
                            game.restoreGameState();
                        } catch (e) {
                            console.log("Could not restore game state", e);
                        }
                        
                        // Bắt đầu game
                        game.gameStarted = true;
                        console.log("Game started successfully");
                    } catch (error) {
                        console.error("Error starting game:", error);
                        // Fallback to ensure game starts even if there are errors
                        document.getElementById('introScreen').style.display = 'none';
                        
                        if (!game.player) {
                            const playerId = 'player_emergency_' + Date.now();
                            game.player = game.createPlayer(playerId, "Player", 0, 0);
                        }
                        
                        game.gameStarted = true;
                        alert("Game started with some errors. If you experience issues, please refresh the page.");
                    }
                });
                
                // Xử lý shop
                shopButton.addEventListener('click', () => {
                    this.toggleShop();
                });
                
                closeShop.addEventListener('click', () => {
                    this.toggleShop();
                });
                
                // Sự kiện mua item
                const shopItems = document.querySelectorAll('.shop-item');
                shopItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const itemType = item.getAttribute('data-item');
                        if (itemType) {
                            this.buyItem(itemType);
                        }
                    });
                });
                
                // Xử lý bảng xếp hạng
                leaderboardButton.addEventListener('click', () => {
                    this.toggleLeaderboard();
                });
                
                closeLeaderboard.addEventListener('click', () => {
                    this.toggleLeaderboard();
                });
            }
            
            // Hiển thị/ẩn cửa hàng
            toggleShop() {
                const shopPanel = document.getElementById('shopPanel');
                
                if (this.shopVisible) {
                    shopPanel.style.display = 'none';
                    this.shopVisible = false;
                } else {
                    // Cập nhật trạng thái nút mua dựa trên số vàng
                    this.updateShopButtons();
                    shopPanel.style.display = 'block';
                    this.shopVisible = true;
                    
                    // Nếu đang hiển thị bảng xếp hạng, ẩn đi
                    if (this.leaderboardVisible) {
                        this.toggleLeaderboard();
                    }
                }
            }
            
            // Cập nhật trạng thái nút mua trong shop
            updateShopButtons() {
                if (!this.player) return;
                
                const shopItems = document.querySelectorAll('.shop-item');
                shopItems.forEach(item => {
                    const itemType = item.getAttribute('data-item');
                    const price = GAME_CONFIG.SHOP_PRICES[itemType];
                    
                    if (this.player.gold < price) {
                        item.style.opacity = '0.5';
                        item.style.cursor = 'not-allowed';
                    } else {
                        item.style.opacity = '1';
                        item.style.cursor = 'pointer';
                    }
                });
            }

            // Hiển thị/ẩn bảng xếp hạng
            toggleLeaderboard() {
                const leaderboardPanel = document.getElementById('leaderboardPanel');
                
                if (this.leaderboardVisible) {
                    leaderboardPanel.style.display = 'none';
                    this.leaderboardVisible = false;
                } else {
                    // Cập nhật bảng xếp hạng
                    this.updateLeaderboard();
                    leaderboardPanel.style.display = 'block';
                    this.leaderboardVisible = true;
                    
                    // Nếu đang hiển thị shop, ẩn đi
                    if (this.shopVisible) {
                        this.toggleShop();
                    }
                }
            }

            // Cập nhật bảng xếp hạng
            updateLeaderboard() {
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';

                // Tạo một mục cho thành tích cao nhất
                const highScoreItem = document.createElement('li');
                highScoreItem.className = 'leaderboard-item';
                
                const rankSpan = document.createElement('span');
                rankSpan.className = 'leaderboard-rank';
                rankSpan.textContent = '1';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'leaderboard-name';
                nameSpan.textContent = 'Điểm cao nhất';
                
                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'leaderboard-score';
                scoreSpan.textContent = this.highScore;
                
                highScoreItem.appendChild(rankSpan);
                highScoreItem.appendChild(nameSpan);
                highScoreItem.appendChild(scoreSpan);
                
                leaderboardList.appendChild(highScoreItem);
                
                // Tạo mục cho người chơi hiện tại
                if (this.player) {
                    const playerItem = document.createElement('li');
                    playerItem.className = 'leaderboard-item';
                    playerItem.style.backgroundColor = 'rgba(93, 92, 222, 0.3)';
                    
                    const playerRankSpan = document.createElement('span');
                    playerRankSpan.className = 'leaderboard-rank';
                    playerRankSpan.textContent = '2';
                    
                    const playerNameSpan = document.createElement('span');
                    playerNameSpan.className = 'leaderboard-name';
                    playerNameSpan.textContent = this.player.name + ' (hiện tại)';
                    
                    const playerScoreSpan = document.createElement('span');
                    playerScoreSpan.className = 'leaderboard-score';
                    playerScoreSpan.textContent = this.player.score;
                    
                    playerItem.appendChild(playerRankSpan);
                    playerItem.appendChild(playerNameSpan);
                    playerItem.appendChild(playerScoreSpan);
                    
                    leaderboardList.appendChild(playerItem);
                }
            }

            // Tạo hiệu ứng pháo hoa
            createFireworks(x, y) {
                for (let i = 0; i < GAME_CONFIG.FIREWORK_COUNT; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 3;
                    const size = 3 + Math.random() * 4;
                    const lifespan = 1000 + Math.random() * 1000;
                    const colors = [0xd22730, 0xffff00, 0xffffff, 0xff9900, 0xff00ff];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    const particle = new PIXI.Graphics();
                    particle.beginFill(color);
                    particle.drawCircle(0, 0, size);
                    particle.endFill();
                    particle.x = x;
                    particle.y = y;
                    particle.vx = Math.cos(angle) * speed;
                    particle.vy = Math.sin(angle) * speed;
                    particle.alpha = 1;
                    particle.createdAt = Date.now();
                    particle.lifespan = lifespan;
                    
                    this.mapContainer.addChild(particle);
                    
                    // Thêm vào ticker để cập nhật vị trí
                    const tickerCallback = () => {
                        const age = Date.now() - particle.createdAt;
                        if (age >= particle.lifespan) {
                            // Xóa particle sau khi hết thời gian
                            this.mapContainer.removeChild(particle);
                            this.app.ticker.remove(tickerCallback);
                        } else {
                            // Cập nhật vị trí và độ trong suốt
                            particle.x += particle.vx;
                            particle.y += particle.vy;
                            particle.alpha = 1 - (age / particle.lifespan);
                            
                            // Thêm trọng lực nhẹ
                            particle.vy += 0.05;
                        }
                    };
                    
                    this.app.ticker.add(tickerCallback);
                }
            }

            // Hiển thị thông báo trong game
            showGameMessage(text, duration = 2000) {
                const messageElement = document.getElementById('gameMessage');
                messageElement.textContent = text;
                messageElement.style.opacity = '1';
                
                clearTimeout(this.messageTimeout);
                this.messageTimeout = setTimeout(() => {
                    messageElement.style.opacity = '0';
                }, duration);
            }

            // Vòng lặp game chính
            gameLoop(delta) {
                if (!this.gameStarted || !this.player) return;
                
                // Cập nhật vị trí mây
                this.updateClouds();
                
                // Cập nhật trạng thái tốc độ
                this.updateSpeedBoostStatus();
                
                // Cập nhật trạng thái nam châm
                this.updateMagnetStatus();
                
                // Tính tốc độ thực tế (có thể tăng nếu có hiệu ứng tăng tốc)
                let actualSpeed = GAME_CONFIG.PLAYER_SPEED;
                if (this.speedBoostActive) {
                    actualSpeed *= GAME_CONFIG.SPEED_BOOST_MULTIPLIER;
                }
                
                // Di chuyển người chơi theo joystick
                if (this.joystickActive && this.joystickStrength > 0.1) {
                    const speed = actualSpeed * this.joystickStrength;
                    this.player.speedX = Math.cos(this.joystickAngle) * speed;
                    this.player.speedY = Math.sin(this.joystickAngle) * speed;
                    this.player.angle = this.joystickAngle;
                } else {
                    // Giảm tốc độ khi không di chuyển
                    this.player.speedX *= 0.8;
                    this.player.speedY *= 0.8;
                    
                    if (Math.abs(this.player.speedX) < 0.1) this.player.speedX = 0;
                    if (Math.abs(this.player.speedY) < 0.1) this.player.speedY = 0;
                }
                
                // Cập nhật vị trí người chơi
                this.player.x += this.player.speedX * delta;
                this.player.y += this.player.speedY * delta;
                
                // Cập nhật sprite người chơi
                this.updatePlayer(this.player);
                
                // Cập nhật kẻ thù
                this.updateEnemies(delta);
                
                // Lưu trạng thái game định kỳ
                const now = Date.now();
                if (now - this.lastTimestamp > 5000) { // Mỗi 5 giây
                    this.saveGameState();
                    this.lastTimestamp = now;
                }
                
                // Cập nhật trạng thái khiên
                this.updateShieldStatus();
                
                // Đặt camera theo người chơi
                this.centerCamera();
            }

            // Đặt camera theo người chơi
            centerCamera() {
                if (!this.player) return;
                
                const viewWidth = window.innerWidth;
                const viewHeight = window.innerHeight;
                
                // Đặt vị trí container để camera tập trung vào người chơi
                this.mapContainer.x = viewWidth / 2 - this.player.x;
                this.mapContainer.y = viewHeight / 2 - this.player.y;
            }

            // Lưu trạng thái game
            saveGameState() {
                if (!this.player) return;
                
                // Lưu thông tin người chơi
                const playerData = {
                    id: this.player.id,
                    name: this.player.name,
                    x: this.player.x,
                    y: this.player.y,
                    score: this.player.score,
                    gold: this.player.gold,
                    inventory: this.player.inventory
                };
                
                // Lưu trạng thái item
                const itemsData = this.items.map(item => ({
                    id: item.id,
                    type: item.type,
                    x: item.x,
                    y: item.y,
                    collected: item.collected,
                    collectedBy: item.collectedBy
                }));
                
                // Lưu trạng thái hiệu ứng
                const effectsData = {
                    shield: {
                        active: this.shieldActive,
                        endTime: this.shieldEndTime
                    },
                    speedBoost: {
                        active: this.speedBoostActive,
                        endTime: this.speedBoostEndTime
                    },
                    magnet: {
                        active: this.magnetActive,
                        endTime: this.magnetEndTime
                    }
                };
                
                // Lưu vào localStorage
                try {
                    localStorage.setItem('playerData', JSON.stringify(playerData));
                    localStorage.setItem('itemsData', JSON.stringify(itemsData));
                    localStorage.setItem('effectsData', JSON.stringify(effectsData));
                    localStorage.setItem('gameTimestamp', Date.now().toString());
                    
                    // Cập nhật điểm cao nếu cần
                    if (this.player.score > this.highScore) {
                        this.highScore = this.player.score;
                        localStorage.setItem('highScore', this.highScore.toString());
                    }
                } catch (error) {
                    console.error("Error saving game state:", error);
                }
            }

            // Tải trạng thái game
            loadGameState() {
                try {
                    // Kiểm tra xem có dữ liệu đã lưu không
                    const playerData = localStorage.getItem('playerData');
                    const itemsData = localStorage.getItem('itemsData');
                    const effectsData = localStorage.getItem('effectsData');
                    const gameTimestamp = localStorage.getItem('gameTimestamp');
                    
                    // Nếu dữ liệu đã được lưu và không quá 1 ngày
                    if (playerData && gameTimestamp) {
                        const now = Date.now();
                        const timestamp = parseInt(gameTimestamp);
                        const oneDayMs = 24 * 60 * 60 * 1000;
                        
                        if (now - timestamp < oneDayMs) {
                            // Khôi phục trạng thái hiệu ứng
                            if (effectsData) {
                                const effects = JSON.parse(effectsData);
                                
                                // Khiên
                                if (effects.shield) {
                                    this.shieldActive = effects.shield.active;
                                    this.shieldEndTime = effects.shield.endTime;
                                    
                                    // Kiểm tra xem khiên có còn hiệu lực không
                                    if (this.shieldActive && now > this.shieldEndTime) {
                                        this.shieldActive = false;
                                    } else if (this.shieldActive) {
                                        document.getElementById('shieldIndicator').style.display = 'block';
                                        document.getElementById('shieldTime').textContent = 
                                            Math.ceil((this.shieldEndTime - now) / 1000);
                                    }
                                }
                                
                                // Tăng tốc
                                if (effects.speedBoost) {
                                    this.speedBoostActive = effects.speedBoost.active;
                                    this.speedBoostEndTime = effects.speedBoost.endTime;
                                    
                                    // Kiểm tra xem tăng tốc có còn hiệu lực không
                                    if (this.speedBoostActive && now > this.speedBoostEndTime) {
                                        this.speedBoostActive = false;
                                    }
                                }
                                
                                // Nam châm
                                if (effects.magnet) {
                                    this.magnetActive = effects.magnet.active;
                                    this.magnetEndTime = effects.magnet.endTime;
                                    
                                    // Kiểm tra xem nam châm có còn hiệu lực không
                                    if (this.magnetActive && now > this.magnetEndTime) {
                                        this.magnetActive = false;
                                    }
                                }
                            }
                            
                            // Dữ liệu còn mới, có thể sử dụng
                            return true;
                        }
                    }
                } catch (error) {
                    console.error("Error loading game state:", error);
                }
                
                return false;
            }
            
            // Khôi phục toàn bộ trạng thái game
            restoreGameState() {
                try {
                    // Khôi phục trạng thái item
                    const itemsData = localStorage.getItem('itemsData');
                    if (itemsData) {
                        const savedItems = JSON.parse(itemsData);
                        
                        // Xóa các item hiện có
                        this.items = [];
                        this.itemContainer.removeChildren();
                        this.itemSprites = {};
                        
                        // Xác định ID lớn nhất hiện tại để tiếp tục tạo ID mới
                        this.nextItemId = 0;
                        
                        // Tạo lại các item đã lưu
                        for (const savedItem of savedItems) {
                            if (!savedItem.collected) {
                                this.createItem(savedItem.type, savedItem.x, savedItem.y);
                            }
                            
                            // Cập nhật ID lớn nhất
                            const idMatch = savedItem.id.match(/\d+$/);
                            if (idMatch) {
                                const idNum = parseInt(idMatch[0]);
                                this.nextItemId = Math.max(this.nextItemId, idNum + 1);
                            }
                        }
                    }
                    
                    // Khôi phục trạng thái người chơi
                    const playerData = localStorage.getItem('playerData');
                    if (playerData && this.player) {
                        const saved = JSON.parse(playerData);
                        if (saved.inventory) {
                            this.player.inventory = saved.inventory;
                        }
                    }
                    
                    // Khôi phục trạng thái hiệu ứng
                    const effectsData = localStorage.getItem('effectsData');
                    if (effectsData) {
                        const effects = JSON.parse(effectsData);
                        
                        // Khiên
                        if (effects.shield && effects.shield.active) {
                            this.shieldActive = effects.shield.active;
                            this.shieldEndTime = effects.shield.endTime;
                            
                            // Hiển thị hiệu ứng khiên
                            if (this.playerSprites[this.player.id] && this.shieldActive) {
                                this.playerSprites[this.player.id].shield.visible = true;
                            }
                        }
                        
                        // Tăng tốc
                        if (effects.speedBoost) {
                            this.speedBoostActive = effects.speedBoost.active;
                            this.speedBoostEndTime = effects.speedBoost.endTime;
                        }
                        
                        // Nam châm
                        if (effects.magnet) {
                            this.magnetActive = effects.magnet.active;
                            this.magnetEndTime = effects.magnet.endTime;
                        }
                    }
                } catch (error) {
                    console.error("Error restoring game state:", error);
                }
            }
        }

        // Khởi tạo và bắt đầu game
        const game = new Game();
        game.init();
    </script>
</body>
</html>
