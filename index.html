<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cờ Chiến Thắng - Game 30/4</title>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.2.4/dist/pixi.min.js"></script>
    <style>
        :root {
            --primary-color: #d22730;
            --secondary-color: #ffff00;
            --text-color: #ffffff;
            --background-color: #f5f5f5;
            --control-bg: rgba(210, 39, 48, 0.7);
        }
        
        .dark {
            --primary-color: #c41e2a;
            --secondary-color: #ffff00;
            --text-color: #ffffff;
            --background-color: #181818;
            --control-bg: rgba(196, 30, 42, 0.8);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: var(--background-color);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        
        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #joystickContainer {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 120px;
            height: 120px;
            pointer-events: auto;
        }
        
        #joystickBase {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--control-bg);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #joystickKnob {
            width: 50%;
            height: 50%;
            border-radius: 50%;
            background: var(--secondary-color);
            position: relative;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .action-button {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--control-bg);
            border: 3px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-color);
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        
        #collectButton {
            bottom: 120px;
            right: 50px;
        }
        
        #bombButton {
            bottom: 50px;
            right: 130px;
        }
        
        #shieldButton {
            bottom: 50px;
            right: 50px;
        }
        
        .button-icon {
            width: 35px;
            height: 35px;
            fill: white;
        }
        
        .inventory-item {
            position: absolute;
            background: var(--control-bg);
            padding: 5px 10px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #flagContainer {
            top: 20px;
            left: 20px;
        }
        
        #goldContainer {
            top: 60px;
            left: 20px;
        }
        
        #bombContainer {
            top: 20px;
            right: 20px;
        }
        
        #shieldContainer {
            top: 60px;
            right: 20px;
        }
        
        .item-icon {
            width: 20px;
            height: 20px;
        }
        
        #timeContainer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--control-bg);
            padding: 5px 15px;
            border-radius: 15px;
            color: var(--text-color);
            font-weight: bold;
            font-size: 16px;
        }
        
        #gameMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-color);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 20;
        }
        
        #introScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            padding: 20px;
        }
        
        #gameTitle {
            color: var(--primary-color);
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        #gameTitle span {
            color: var(--secondary-color);
        }
        
        #nameInput {
            margin: 20px 0;
            padding: 15px;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            font-size: 16px;
            text-align: center;
        }
        
        #startButton {
            padding: 15px 40px;
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #startButton:active {
            transform: scale(0.95);
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        
        @media (max-width: 767px) {
            #joystickContainer {
                bottom: 80px;
                left: 30px;
                width: 100px;
                height: 100px;
            }
            
            .action-button {
                width: 60px;
                height: 60px;
            }
            
            #collectButton {
                bottom: 100px;
                right: 30px;
            }
            
            #bombButton {
                bottom: 40px;
                right: 100px;
            }
            
            #shieldButton {
                bottom: 40px;
                right: 30px;
            }
            
            .button-icon {
                width: 30px;
                height: 30px;
            }
            
            #gameTitle {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="gameUI">
            <div id="joystickContainer">
                <div id="joystickBase">
                    <div id="joystickKnob"></div>
                </div>
            </div>
            
            <div id="collectButton" class="action-button">
                <svg class="button-icon" viewBox="0 0 24 24" fill="white">
                    <path d="M12,5.5l7,7H5l7-7M12,1L3,10h18L12,1z M12,16.5l-7-7h14l-7,7M12,21l9-9H3L12,21z"/>
                </svg>
            </div>
            
            <div id="bombButton" class="action-button">
                <svg class="button-icon" viewBox="0 0 24 24" fill="white">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M17,13H7V11H17V13Z"/>
                </svg>
            </div>
            
            <div id="shieldButton" class="action-button">
                <svg class="button-icon" viewBox="0 0 24 24" fill="white">
                    <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                </svg>
            </div>
            
            <div id="flagContainer" class="inventory-item">
                <svg class="item-icon" viewBox="0 0 24 16">
                    <rect x="0" y="0" width="24" height="16" fill="#d22730"/>
                    <polygon points="12,3 14,8 19,8 15,11 17,16 12,13 7,16 9,11 5,8 10,8" fill="#ffff00"/>
                </svg>
                <span id="flagCount">0</span>
            </div>
            
            <div id="goldContainer" class="inventory-item">
                <svg class="item-icon" viewBox="0 0 24 24" fill="#FFD700">
                    <circle cx="12" cy="12" r="10"/>
                    <text x="12" y="17" font-size="14" text-anchor="middle" fill="#FFA500">₫</text>
                </svg>
                <span id="goldCount">0</span>
            </div>
            
            <div id="bombContainer" class="inventory-item">
                <svg class="item-icon" viewBox="0 0 24 24" fill="#333">
                    <circle cx="12" cy="12" r="10" fill="#333"/>
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M17,13H7V11H17V13Z" fill="#FF0000"/>
                </svg>
                <span id="bombCount">0</span>
            </div>
            
            <div id="shieldContainer" class="inventory-item">
                <svg class="item-icon" viewBox="0 0 24 24" fill="#1E90FF">
                    <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                </svg>
                <span id="shieldCount">0</span>
            </div>
            
            <div id="timeContainer">
                <span id="timeValue">00:00</span>
            </div>
            
            <div id="gameMessage"></div>
        </div>
        
        <div id="introScreen">
            <h1 id="gameTitle">CỜ <span>CHIẾN THẮNG</span></h1>
            <p style="color: white; text-align: center; margin-bottom: 15px;">Tự hào kỷ niệm ngày Giải phóng miền Nam 30/4</p>
            <input type="text" id="nameInput" placeholder="Nhập tên của bạn" maxlength="15">
            <button id="startButton">BẮT ĐẦU CHƠI</button>
        </div>
    </div>

    <script>
        // Xử lý chế độ màu (Dark/Light)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Các thiết lập game
        const GAME_CONFIG = {
            CHUNK_SIZE: 1000, // Kích thước 1 chunk của map
            VISIBLE_CHUNKS: 3, // Số lượng chunk hiển thị xung quanh người chơi
            PLAYER_SPEED: 2.5, // Tốc độ di chuyển của người chơi (giảm xuống)
            THIEF_SPEED: 3.0, // Tốc độ di chuyển của kẻ cướp
            THIEF_SPAWN_CHANCE: 0.005, // Tỉ lệ xuất hiện kẻ cướp mỗi giây
            ITEM_SPAWN_INTERVAL: 1000, // Khoảng thời gian sinh vật phẩm (ms)
            FLAG_SPAWN_CHANCE: 0.03, // Tỉ lệ xuất hiện cờ
            GOLD_SPAWN_CHANCE: 0.01, // Tỉ lệ xuất hiện vàng
            BOMB_SPAWN_CHANCE: 0.05, // Tỉ lệ xuất hiện bom
            SHIELD_SPAWN_CHANCE: 0.05, // Tỉ lệ xuất hiện khiên
            COLLECT_DISTANCE: 60, // Khoảng cách có thể nhặt vật phẩm
            AMBIENT_UPDATE_INTERVAL: 10000, // Khoảng thời gian cập nhật môi trường xung quanh (ms)
            DAY_CYCLE_DURATION: 300000, // Thời gian một chu kỳ ngày/đêm (ms) - 5 phút
            TIME_BETWEEN_GOLDS: 15 * 60 * 1000, // 15 phút cho 4 viên vàng
            FIREWORK_COUNT: 20, // Số lượng hạt pháo hoa
        };

        // Class GameObject - Lớp cơ sở cho tất cả các đối tượng trong game
        class GameObject {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.container = new PIXI.Container();
                this.container.x = x;
                this.container.y = y;
            }
            
            update(delta) {
                this.container.x = this.x;
                this.container.y = this.y;
            }
            
            destroy() {
                if (this.container && this.container.parent) {
                    this.container.parent.removeChild(this.container);
                }
            }
        }

        // Class Player - Người chơi
        class Player extends GameObject {
            constructor(x, y, name) {
                super(x, y);
                this.name = name;
                this.speedX = 0;
                this.speedY = 0;
                this.angle = 0;
                this.inventory = {
                    flags: 0,
                    gold: 0,
                    bombs: 5, // Bắt đầu với 5 quả bom
                    shields: 3 // Bắt đầu với 3 chiếc khiên
                };
                this.activeShield = false;
                this.shieldTimer = null;
                this.createSprite();
            }
            
            createSprite() {
                // Tạo sprite xe tăng từ ảnh thay vì vẽ đồ họa
                const tankTexture = PIXI.Texture.from('https://img.upanh.tv/2025/04/29/ChatGPT-Image-12_31_11-29-thg-4-2025.png');
                const tankSprite = new PIXI.Sprite(tankTexture);
                tankSprite.anchor.set(0.5, 0.5);
                tankSprite.width = 60;
                tankSprite.height = 60;
                
                this.body = tankSprite;
                this.direction = tankSprite; // Xe tăng tự thân đã có hướng
                
                // Tạo text tên người chơi
                const nameText = new PIXI.Text(this.name, {
                    fontFamily: "Arial",
                    fontSize: 14,
                    fill: 0xFFFFFF,
                    align: "center",
                    fontWeight: "bold",
                    stroke: 0x000000,
                    strokeThickness: 3
                });
                nameText.anchor.set(0.5, 0.5);
                nameText.y = -45;
                
                // Khiên bảo vệ
                const shield = new PIXI.Graphics();
                shield.beginFill(0x1E90FF, 0.5);
                shield.drawCircle(0, 0, 40);
                shield.endFill();
                shield.visible = false;
                this.shield = shield;
                
                this.container.addChild(shield); // Thêm khiên trước để nằm dưới xe tăng
                this.container.addChild(tankSprite);
                this.container.addChild(nameText);
                
                // Hiệu ứng tỏa sáng
                this.updateGlowEffect();
            }
            
            updateGlowEffect() {
                // Xóa hiệu ứng glow cũ nếu có
                if (this.glow && this.glow.parent) {
                    this.glow.parent.removeChild(this.glow);
                }
                
                // Tạo hiệu ứng glow mới
                this.glow = new PIXI.Graphics();
                this.glow.beginFill(0x5D5CDE, 0.3);
                this.glow.drawCircle(0, 0, 25);
                this.glow.endFill();
                
                // Thêm vào dưới người chơi
                if (this.container.parent) {
                    this.container.parent.addChildAt(this.glow, this.container.parent.children.indexOf(this.container));
                }
            }
            
            update(delta) {
                super.update(delta);
                
                // Cập nhật hướng mũi tên
                this.direction.rotation = this.angle;
                
                // Cập nhật hiệu ứng tỏa sáng
                if (this.glow) {
                    this.glow.x = this.x;
                    this.glow.y = this.y;
                    this.glow.alpha = 0.3 + Math.sin(Date.now() / 800) * 0.1;
                    this.glow.scale.set(1 + Math.sin(Date.now() / 1000) * 0.1);
                }
                
                // Cập nhật hiệu ứng khiên
                this.shield.visible = this.activeShield;
                if (this.activeShield) {
                    this.shield.alpha = 0.5 + Math.sin(Date.now() / 300) * 0.2;
                    this.shield.scale.set(1 + Math.sin(Date.now() / 500) * 0.1);
                }
            }
            
            activateShield(duration = 30000) {
                // Kích hoạt khiên bảo vệ (30 giây)
                this.activeShield = true;
                
                // Hủy timer cũ nếu có
                if (this.shieldTimer) {
                    clearTimeout(this.shieldTimer);
                }
                
                // Đặt timer mới
                this.shieldTimer = setTimeout(() => {
                    this.activeShield = false;
                }, duration);
            }
            
            useBomb() {
                if (this.inventory.bombs > 0) {
                    this.inventory.bombs--;
                    updateInventoryUI();
                    return true;
                }
                return false;
            }
            
            useShield() {
                if (this.inventory.shields > 0 && !this.activeShield) {
                    this.inventory.shields--;
                    updateInventoryUI();
                    this.activateShield();
                    return true;
                }
                return false;
            }
        }

        // Class Thief - Kẻ cướp
        class Thief extends GameObject {
            constructor(x, y, target) {
                super(x, y);
                this.target = target;
                this.speed = GAME_CONFIG.THIEF_SPEED;
                this.detectionRadius = 300;
                this.attackRadius = 50;
                this.state = 'patrolling'; // patrolling, chasing, stunned
                this.stunTimer = null;
                this.createSprite();
            }
            
            createSprite() {
                // Thân kẻ cướp
                const body = new PIXI.Graphics();
                body.beginFill(0xFF0000);
                body.drawCircle(0, 0, 18);
                body.endFill();
                
                // Đôi mắt
                const eyes = new PIXI.Graphics();
                eyes.beginFill(0xFFFFFF);
                eyes.drawCircle(-5, -5, 4);
                eyes.drawCircle(5, -5, 4);
                eyes.endFill();
                
                // Đồng tử
                const pupils = new PIXI.Graphics();
                pupils.beginFill(0x000000);
                pupils.drawCircle(-5, -5, 2);
                pupils.drawCircle(5, -5, 2);
                pupils.endFill();
                
                // Miệng
                const mouth = new PIXI.Graphics();
                mouth.beginFill(0x000000);
                mouth.drawRect(-8, 5, 16, 3);
                mouth.endFill();
                
                // Hiệu ứng stunned
                const stunnedEffect = new PIXI.Graphics();
                stunnedEffect.beginFill(0xFFFF00);
                stunnedEffect.drawStar(0, -25, 5, 7, 3);
                stunnedEffect.endFill();
                stunnedEffect.visible = false;
                this.stunnedEffect = stunnedEffect;
                
                this.container.addChild(body);
                this.container.addChild(eyes);
                this.container.addChild(pupils);
                this.container.addChild(mouth);
                this.container.addChild(stunnedEffect);
            }
            
            update(delta) {
                super.update(delta);
                
                if (this.state === 'stunned') {
                    // Hiệu ứng choáng
                    this.stunnedEffect.visible = true;
                    this.stunnedEffect.rotation += 0.1 * delta;
                    return;
                } else {
                    this.stunnedEffect.visible = false;
                }
                
                if (!this.target) return;
                
                // Tính khoảng cách đến người chơi
                const dx = this.target.x - this.x;
                const dy = this.target.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Chuyển sang chế độ đuổi theo nếu trong tầm phát hiện
                if (distance < this.detectionRadius) {
                    this.state = 'chasing';
                }
                
                // Hành vi dựa theo trạng thái
                if (this.state === 'patrolling') {
                    // Di chuyển ngẫu nhiên
                    if (Math.random() < 0.02) {
                        this.angle = Math.random() * Math.PI * 2;
                    }
                    
                    // Di chuyển chậm hơn khi đi tuần tra
                    this.x += Math.cos(this.angle) * this.speed * 0.5 * delta;
                    this.y += Math.sin(this.angle) * this.speed * 0.5 * delta;
                    
                } else if (this.state === 'chasing') {
                    // Tính góc đến người chơi
                    this.angle = Math.atan2(dy, dx);
                    
                    // Di chuyển về phía người chơi
                    this.x += Math.cos(this.angle) * this.speed * delta;
                    this.y += Math.sin(this.angle) * this.speed * delta;
                    
                    // Kiểm tra va chạm với người chơi
                    if (distance < this.attackRadius) {
                        this.attack();
                    }
                }
                
                // Hiệu ứng quay về phía người chơi
                this.container.rotation = this.angle + Math.PI/2;
            }
            
            attack() {
                // Không thể tấn công nếu người chơi có khiên
                if (this.target.activeShield) return;
                
                // Lấy 1 lá cờ nếu người chơi có
                if (this.target.inventory.flags > 0) {
                    this.target.inventory.flags--;
                    updateInventoryUI();
                    showGameMessage("Kẻ cướp đã lấy 1 lá cờ của bạn!");
                    
                    // Tạm thời vô hiệu hóa kẻ cướp
                    this.stun(3000);
                }
            }
            
            stun(duration) {
                // Làm choáng kẻ cướp
                this.state = 'stunned';
                
                // Hủy timer cũ nếu có
                if (this.stunTimer) {
                    clearTimeout(this.stunTimer);
                }
                
                // Đặt timer mới
                this.stunTimer = setTimeout(() => {
                    this.state = 'patrolling';
                }, duration);
            }
        }

        // Class Item - Vật phẩm trong game
        class Item extends GameObject {
            constructor(x, y, type) {
                super(x, y);
                this.type = type; // flag, gold, bomb, shield
                this.collected = false;
                this.createSprite();
            }
            
            createSprite() {
                let sprite;
                
                switch(this.type) {
                    case 'flag':
                        // Tạo lá cờ Việt Nam (nhỏ hơn)
                        sprite = new PIXI.Container();
                        
                        // Nền đỏ
                        const flagBase = new PIXI.Graphics();
                        flagBase.beginFill(0xd22730);
                        flagBase.drawRect(-12, -8, 24, 16);
                        flagBase.endFill();
                        
                        // Ngôi sao vàng
                        flagBase.beginFill(0xffff00);
                        this.drawStar(flagBase, 0, 0, 5, 6, 3);
                        flagBase.endFill();
                        
                        // Thêm cột cờ
                        flagBase.beginFill(0x8B4513);
                        flagBase.drawRect(-14, -8, 2, 24);
                        flagBase.endFill();
                        
                        sprite.addChild(flagBase);
                        
                        // Hiệu ứng tỏa sáng
                        const glow = new PIXI.Graphics();
                        glow.beginFill(0xffff00, 0.3);
                        glow.drawCircle(0, 0, 20);
                        glow.endFill();
                        sprite.addChildAt(glow, 0);
                        this.glow = glow;
                        break;
                        
                    case 'gold':
                        // Tạo đồng tiền vàng
                        sprite = new PIXI.Graphics();
                        sprite.beginFill(0xFFD700);
                        sprite.drawCircle(0, 0, 10);
                        sprite.endFill();
                        
                        // Ký hiệu ₫
                        const text = new PIXI.Text("₫", {
                            fontFamily: "Arial",
                            fontSize: 14,
                            fill: 0xFFA500,
                            fontWeight: "bold"
                        });
                        text.anchor.set(0.5, 0.5);
                        sprite.addChild(text);
                        
                        // Hiệu ứng tỏa sáng
                        const goldGlow = new PIXI.Graphics();
                        goldGlow.beginFill(0xFFD700, 0.3);
                        goldGlow.drawCircle(0, 0, 18);
                        goldGlow.endFill();
                        sprite.addChildAt(goldGlow, 0);
                        this.glow = goldGlow;
                        break;
                        
                    case 'bomb':
                        // Tạo quả bom
                        sprite = new PIXI.Graphics();
                        sprite.beginFill(0x000000);
                        sprite.drawCircle(0, 0, 8);
                        sprite.endFill();
                        
                        // Ngòi nổ
                        sprite.lineStyle(2, 0xFF0000);
                        sprite.moveTo(0, -8);
                        sprite.lineTo(0, -12);
                        sprite.endFill();
                        break;
                        
                    case 'shield':
                        // Tạo khiên
                        sprite = new PIXI.Graphics();
                        sprite.beginFill(0x1E90FF);
                        sprite.drawPolygon([
                            0, -10,
                            8, -5,
                            8, 5,
                            0, 10,
                            -8, 5,
                            -8, -5
                        ]);
                        sprite.endFill();
                        break;
                }
                
                this.sprite = sprite;
                this.container.addChild(sprite);
            }
            
            drawStar(graphics, x, y, points, outerRadius, innerRadius) {
                const startAngle = -Math.PI / 2; // Bắt đầu từ đỉnh trên
                const step = Math.PI / points;
                
                // Di chuyển đến điểm đầu tiên
                let angle = startAngle;
                const firstX = x + Math.cos(angle) * outerRadius;
                const firstY = y + Math.sin(angle) * outerRadius;
                graphics.moveTo(firstX, firstY);
                
                // Vẽ các điểm của ngôi sao
                for (let i = 1; i < points * 2; i++) {
                    angle += step;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const pointX = x + Math.cos(angle) * radius;
                    const pointY = y + Math.sin(angle) * radius;
                    graphics.lineTo(pointX, pointY);
                }
                
                // Kết nối lại với điểm đầu tiên
                graphics.lineTo(firstX, firstY);
            }
            
            update(delta) {
                super.update(delta);
                
                // Hiệu ứng rung lắc nhẹ
                this.container.rotation = Math.sin(Date.now() / 500) * 0.05;
                
                // Hiệu ứng tỏa sáng nếu có
                if (this.glow) {
                    this.glow.alpha = 0.3 + Math.sin(Date.now() / 800) * 0.1;
                    this.glow.scale.set(1 + Math.sin(Date.now() / 1000) * 0.1);
                }
            }
        }

        // Class Cloud - Mây trên bầu trời
        class Cloud extends GameObject {
            constructor(x, y) {
                super(x, y);
                this.speedX = 0.2 + Math.random() * 0.3;
                this.createSprite();
            }
            
            createSprite() {
                const cloud = new PIXI.Graphics();
                const scale = 0.5 + Math.random() * 1.0;
                const color = 0xFFFFFF;
                const alpha = 0.7 + Math.random() * 0.3;
                
                cloud.beginFill(color, alpha);
                
                // Vẽ hình mây
                const centerX = 0;
                const centerY = 0;
                cloud.drawCircle(centerX - 20 * scale, centerY, 20 * scale);
                cloud.drawCircle(centerX, centerY - 10 * scale, 25 * scale);
                cloud.drawCircle(centerX + 20 * scale, centerY, 20 * scale);
                cloud.drawCircle(centerX, centerY + 5 * scale, 22 * scale);
                
                cloud.endFill();
                
                this.sprite = cloud;
                this.container.addChild(cloud);
                
                // Đặt độ cao ngẫu nhiên
                this.container.y = y - 200 - Math.random() * 100;
                this.container.zIndex = -100; // Đặt ở phía sau các đối tượng khác
            }
            
            update(delta) {
                super.update(delta);
                
                // Di chuyển mây từ trái qua phải
                this.x += this.speedX * delta;
            }
        }

        // Class Bird - Chim bay trên bầu trời
        class Bird extends GameObject {
            constructor(x, y) {
                super(x, y);
                this.speedX = 1 + Math.random() * 2;
                this.amplitude = 10 + Math.random() * 20;
                this.frequency = 0.05 + Math.random() * 0.1;
                this.startY = y;
                this.time = Math.random() * 100;
                this.createSprite();
            }
            
            createSprite() {
                const bird = new PIXI.Graphics();
                
                // Vẽ hình chim đơn giản
                bird.beginFill(0x000000);
                
                // Thân chim
                bird.moveTo(0, 0);
                bird.lineTo(10, -5);
                bird.lineTo(5, 0);
                bird.lineTo(10, 5);
                bird.lineTo(0, 0);
                
                bird.endFill();
                
                this.sprite = bird;
                this.container.addChild(bird);
                
                // Đặt độ cao ngẫu nhiên
                this.container.y = y - 150 - Math.random() * 100;
                this.container.zIndex = -90; // Đặt ở phía sau hầu hết các đối tượng
            }
            
            update(delta) {
                // Di chuyển chim từ trái qua phải
                this.x += this.speedX * delta;
                
                // Chuyển động lên xuống theo hình sin
                this.time += this.frequency * delta;
                this.y = this.startY + Math.sin(this.time) * this.amplitude;
                
                // Đập cánh (hiệu ứng đơn giản)
                if (Math.floor(this.time * 5) % 2 === 0) {
                    this.sprite.scale.y = 1;
                } else {
                    this.sprite.scale.y = 0.7;
                }
                
                super.update(delta);
            }
        }

        // Class Torch - Đuốc/đèn chiếu sáng
        class Torch extends GameObject {
            constructor(x, y) {
                super(x, y);
                this.createSprite();
                this.lightTime = Math.random() * 100; // Giá trị khởi tạo ngẫu nhiên
            }
            
            createSprite() {
                const torch = new PIXI.Container();
                
                // Cột đuốc
                const pole = new PIXI.Graphics();
                pole.beginFill(0x8B4513);
                pole.drawRect(-2, 0, 4, 30);
                pole.endFill();
                
                // Phần đầu đuốc
                const head = new PIXI.Graphics();
                head.beginFill(0xA0522D);
                head.drawCircle(0, 0, 6);
                head.endFill();
                head.y = -5;
                
                // Hiệu ứng lửa
                const fire = new PIXI.Graphics();
                this.updateFire(fire);
                fire.y = -5;
                
                this.fire = fire;
                
                // Hiệu ứng ánh sáng
                const light = new PIXI.Graphics();
                light.beginFill(0xFFA500, 0.3);
                light.drawCircle(0, -5, 40);
                light.endFill();
                light.alpha = 0.5;
                
                this.light = light;
                
                torch.addChild(light);
                torch.addChild(pole);
                torch.addChild(head);
                torch.addChild(fire);
                
                this.sprite = torch;
                this.container.addChild(torch);
            }
            
            updateFire(graphics) {
                graphics.clear();
                graphics.beginFill(0xFF4500);
                
                // Vẽ ngọn lửa với hình dạng ngẫu nhiên
                const intensity = 0.5 + Math.random() * 0.5;
                graphics.moveTo(-5, 0);
                graphics.bezierCurveTo(
                    -3, -5 * intensity,
                    -1, -10 * intensity,
                    0, -15 * intensity
                );
                graphics.bezierCurveTo(
                    1, -10 * intensity,
                    3, -5 * intensity,
                    5, 0
                );
                graphics.lineTo(-5, 0);
                
                graphics.endFill();
                
                // Lớp lửa bên trong
                graphics.beginFill(0xFFFF00);
                graphics.moveTo(-3, 0);
                graphics.bezierCurveTo(
                    -2, -3 * intensity,
                    -1, -7 * intensity,
                    0, -10 * intensity
                );
                graphics.bezierCurveTo(
                    1, -7 * intensity,
                    2, -3 * intensity,
                    3, 0
                );
                graphics.lineTo(-3, 0);
                
                graphics.endFill();
            }
            
            update(delta) {
                super.update(delta);
                
                // Cập nhật hiệu ứng lửa
                this.lightTime += 0.1 * delta;
                
                if (Math.random() < 0.2) {
                    this.updateFire(this.fire);
                }
                
                // Hiệu ứng nhấp nháy của ánh sáng
                if (this.light) {
                    this.light.alpha = 0.3 + Math.sin(this.lightTime * 0.3) * 0.1 + Math.random() * 0.1;
                    this.light.scale.set(1 + Math.sin(this.lightTime * 0.2) * 0.1);
                }
                
                // Hiển thị đuốc chỉ vào ban đêm
                const dayTime = (game.dayTime % GAME_CONFIG.DAY_CYCLE_DURATION) / GAME_CONFIG.DAY_CYCLE_DURATION;
                
                if (dayTime > 0.7 || dayTime < 0.3) {
                    // Ban đêm hoặc hoàng hôn/bình minh
                    this.container.alpha = Math.min(1, Math.max(0, 
                        dayTime > 0.7 ? (dayTime - 0.7) * 5 : // Chiều tối
                        dayTime < 0.3 ? (0.3 - dayTime) * 5 : 0 // Sáng sớm
                    ));
                } else {
                    // Ban ngày
                    this.container.alpha = 0;
                }
            }
        }

        // Class Particle - Các hiệu ứng hạt (pháo hoa, vụ nổ)
        class Particle {
            constructor(x, y, options = {}) {
                this.x = x;
                this.y = y;
                this.speedX = options.speedX || (Math.random() * 4 - 2);
                this.speedY = options.speedY || (Math.random() * 4 - 2);
                this.gravity = options.gravity || 0.1;
                this.friction = options.friction || 0.98;
                this.size = options.size || 3 + Math.random() * 3;
                this.color = options.color || 0xFFFFFF;
                this.alpha = 1;
                this.alphaDecay = options.alphaDecay || 0.02;
                this.lifetime = options.lifetime || 60;
                this.life = this.lifetime;
                
                this.sprite = new PIXI.Graphics();
                this.sprite.beginFill(this.color);
                this.sprite.drawCircle(0, 0, this.size);
                this.sprite.endFill();
                this.sprite.x = this.x;
                this.sprite.y = this.y;
                
                // Thêm vào container
                if (options.container) {
                    options.container.addChild(this.sprite);
                }
            }
            
            update() {
                // Cập nhật vị trí
                this.speedX *= this.friction;
                this.speedY *= this.friction;
                this.speedY += this.gravity;
                
                this.x += this.speedX;
                this.y += this.speedY;
                
                // Cập nhật sprite
                this.sprite.x = this.x;
                this.sprite.y = this.y;
                
                // Giảm độ trong suốt theo thời gian
                this.life--;
                this.alpha = this.life / this.lifetime;
                this.sprite.alpha = this.alpha;
                
                // Trả về true nếu hạt vẫn còn sống
                return this.life > 0;
            }
            
            destroy() {
                if (this.sprite && this.sprite.parent) {
                    this.sprite.parent.removeChild(this.sprite);
                }
            }
        }

        // Class GameMap - Quản lý bản đồ vô hạn
        class GameMap {
            constructor() {
                this.chunks = new Map(); // Lưu trữ các chunk của bản đồ
                this.chunkContainer = new PIXI.Container();
                this.objectContainer = new PIXI.Container();
                this.skyContainer = new PIXI.Container();
                this.gameObjects = []; // Danh sách đối tượng trong game
                this.particles = []; // Danh sách các hạt hiệu ứng
                
                // Thiết lập z-index cho các container
                this.skyContainer.zIndex = -100;
                this.chunkContainer.zIndex = -10;
                this.objectContainer.zIndex = 10;
                
                // Màu nền cho ban ngày và ban đêm
                this.dayColor = 0x87CEEB; // Màu xanh nhạt cho bầu trời ban ngày
                this.nightColor = 0x000033; // Màu xanh đen cho bầu trời ban đêm
                
                // Tạo nền trời
                this.sky = new PIXI.Graphics();
                this.updateSkyColor(0);
                this.skyContainer.addChild(this.sky);
            }
            
            // Cập nhật màu nền dựa trên thời gian trong ngày
            updateSkyColor(dayTime) {
                // dayTime từ 0 đến 1, tương ứng với thời gian trong ngày
                const dayR = (this.dayColor >> 16) & 0xFF;
                const dayG = (this.dayColor >> 8) & 0xFF;
                const dayB = this.dayColor & 0xFF;
                
                const nightR = (this.nightColor >> 16) & 0xFF;
                const nightG = (this.nightColor >> 8) & 0xFF;
                const nightB = this.nightColor & 0xFF;
                
                let r, g, b;
                
                if (dayTime < 0.25) { // Bình minh
                    const t = dayTime / 0.25;
                    r = Math.floor(nightR + (dayR - nightR) * t);
                    g = Math.floor(nightG + (dayG - nightG) * t);
                    b = Math.floor(nightB + (dayB - nightB) * t);
                } else if (dayTime < 0.75) { // Ban ngày
                    r = dayR;
                    g = dayG;
                    b = dayB;
                } else { // Hoàng hôn/ban đêm
                    const t = (dayTime - 0.75) / 0.25;
                    r = Math.floor(dayR + (nightR - dayR) * t);
                    g = Math.floor(dayG + (nightG - dayG) * t);
                    b = Math.floor(dayB + (nightB - dayB) * t);
                }
                
                const color = (r << 16) | (g << 8) | b;
                
                this.sky.clear();
                this.sky.beginFill(color);
                this.sky.drawRect(-100000, -100000, 200000, 200000);
                this.sky.endFill();
                
                // Cập nhật độ tối cho các đối tượng
                const darkness = dayTime < 0.25 ? 1 - dayTime / 0.25 : 
                                 dayTime > 0.75 ? (dayTime - 0.75) / 0.25 : 0;
                
                this.updateObjectsDarkness(darkness);
            }
            
            // Cập nhật độ tối cho các đối tượng
            updateObjectsDarkness(darkness) {
                // Giảm độ sáng của các đối tượng vào ban đêm
                const minBrightness = 0.6; // Độ sáng tối thiểu
                const brightness = 1 - darkness * (1 - minBrightness);
                
                // Áp dụng cho tất cả các sprite trong chunk container
                this.chunkContainer.children.forEach(chunk => {
                    if (chunk.filters === null) {
                        chunk.filters = [new PIXI.ColorMatrixFilter()];
                    }
                    
                    const filter = chunk.filters[0];
                    filter.brightness(brightness);
                });
            }
            
            // Lấy key của chunk dựa vào vị trí
            getChunkKey(x, y) {
                const chunkX = Math.floor(x / GAME_CONFIG.CHUNK_SIZE);
                const chunkY = Math.floor(y / GAME_CONFIG.CHUNK_SIZE);
                return `${chunkX},${chunkY}`;
            }
            
            // Lấy chunk dựa vào key
            getChunk(key) {
                if (!this.chunks.has(key)) {
                    // Khởi tạo chunk mới nếu chưa tồn tại
                    const [chunkX, chunkY] = key.split(',').map(Number);
                    const chunk = this.createChunk(chunkX, chunkY);
                    this.chunks.set(key, chunk);
                    this.chunkContainer.addChild(chunk);
                }
                return this.chunks.get(key);
            }
            
            // Tạo chunk mới
            createChunk(chunkX, chunkY) {
                const chunk = new PIXI.Container();
                chunk.x = chunkX * GAME_CONFIG.CHUNK_SIZE;
                chunk.y = chunkY * GAME_CONFIG.CHUNK_SIZE;
                
                // Vẽ nền cỏ cho chunk
                const grass = new PIXI.Graphics();
                grass.beginFill(0x5EB45E);
                grass.drawRect(0, 0, GAME_CONFIG.CHUNK_SIZE, GAME_CONFIG.CHUNK_SIZE);
                grass.endFill();
                chunk.addChild(grass);
                
                // Tạo vật trang trí cho chunk
                this.createChunkDecorations(chunk, chunkX, chunkY);
                
                return chunk;
            }
            
            // Tạo vật trang trí cho chunk
            createChunkDecorations(chunk, chunkX, chunkY) {
                // Tạo seed cho random từ vị trí chunk
                const chunkSeed = chunkX * 12345 + chunkY * 67890;
                const random = this.createRandomGenerator(chunkSeed);
                
                // Tạo cây cối
                const treeCount = random.nextInt(10, 20);
                for (let i = 0; i < treeCount; i++) {
                    const treeSize = random.nextInt(30, 60);
                    const treeX = random.nextInt(20, GAME_CONFIG.CHUNK_SIZE - 20);
                    const treeY = random.nextInt(20, GAME_CONFIG.CHUNK_SIZE - 20);
                    
                    const tree = new PIXI.Graphics();
                    // Thân cây
                    tree.beginFill(0x8B4513);
                    tree.drawRect(treeX - 5, treeY, 10, 20);
                    tree.endFill();
                    
                    // Tán lá
                    tree.beginFill(0x2E8B57);
                    tree.drawCircle(treeX, treeY - 15, treeSize / 2);
                    tree.endFill();
                    
                    chunk.addChild(tree);
                }
                
                // Tạo các bụi cây nhỏ
                const bushCount = random.nextInt(20, 30);
                for (let i = 0; i < bushCount; i++) {
                    const bushSize = random.nextInt(15, 30);
                    const bushX = random.nextInt(10, GAME_CONFIG.CHUNK_SIZE - 10);
                    const bushY = random.nextInt(10, GAME_CONFIG.CHUNK_SIZE - 10);
                    
                    const bush = new PIXI.Graphics();
                    bush.beginFill(0x3CB371);
                    bush.drawCircle(bushX, bushY, bushSize / 2);
                    bush.endFill();
                    
                    chunk.addChild(bush);
                }
                
                // Tạo các hoa
                const flowerCount = random.nextInt(30, 50);
                for (let i = 0; i < flowerCount; i++) {
                    const flowerX = random.nextInt(5, GAME_CONFIG.CHUNK_SIZE - 5);
                    const flowerY = random.nextInt(5, GAME_CONFIG.CHUNK_SIZE - 5);
                    const flowerColor = [0xFF69B4, 0xFFFF00, 0xFF6347, 0x9370DB, 0xFF4500][random.nextInt(0, 4)];
                    
                    const flower = new PIXI.Graphics();
                    flower.beginFill(flowerColor);
                    flower.drawCircle(flowerX, flowerY, 3);
                    flower.endFill();
                    
                    chunk.addChild(flower);
                }
                
                // Tạo đường đi ngẫu nhiên
                if (random.next() < 0.3) {
                    const isHorizontal = random.next() < 0.5;
                    const pathWidth = 20;
                    
                    const path = new PIXI.Graphics();
                    path.beginFill(0xDEB887);
                    
                    if (isHorizontal) {
                        const y = random.nextInt(200, GAME_CONFIG.CHUNK_SIZE - 200);
                        path.drawRect(0, y - pathWidth/2, GAME_CONFIG.CHUNK_SIZE, pathWidth);
                    } else {
                        const x = random.nextInt(200, GAME_CONFIG.CHUNK_SIZE - 200);
                        path.drawRect(x - pathWidth/2, 0, pathWidth, GAME_CONFIG.CHUNK_SIZE);
                    }
                    
                    path.endFill();
                    chunk.addChildAt(path, 1);
                }
                
                // Thêm biểu tượng 30/4 ngẫu nhiên với tỉ lệ nhỏ
                if (random.next() < 0.1) {
                    // Cờ Việt Nam lớn
                    const flagX = random.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                    const flagY = random.nextInt(100, GAME_CONFIG.CHUNK_SIZE - 100);
                    
                    const flagMonument = new PIXI.Graphics();
                    
                    // Cột cờ
                    flagMonument.beginFill(0x8B4513);
                    flagMonument.drawRect(flagX - 5, flagY, 10, 100);
                    flagMonument.endFill();
                    
                    // Nền đỏ
                    flagMonument.beginFill(0xd22730);
                    flagMonument.drawRect(flagX + 5, flagY, 60, 40);
                    flagMonument.endFill();
                    
                    // Ngôi sao vàng
                    flagMonument.beginFill(0xffff00);
                    this.drawStar(flagMonument, flagX + 35, flagY + 20, 5, 15, 7);
                    flagMonument.endFill();
                    
                    chunk.addChild(flagMonument);
                    
                    // Thêm văn bản 30/4
                    const memorial = new PIXI.Text("30/4", {
                        fontFamily: "Arial",
                        fontSize: 24,
                        fill: 0xd22730,
                        fontWeight: "bold",
                        stroke: 0xffff00,
                        strokeThickness: 3
                    });
                    memorial.x = flagX + 5;
                    memorial.y = flagY + 50;
                    chunk.addChild(memorial);
                }
                
                // Thêm đuốc/đèn
                if (random.next() < 0.4) {
                    const torchX = random.nextInt(50, GAME_CONFIG.CHUNK_SIZE - 50);
                    const torchY = random.nextInt(50, GAME_CONFIG.CHUNK_SIZE - 50);
                    
                    const torch = new Torch(torchX + chunk.x, torchY + chunk.y);
                    this.addGameObject(torch);
                }
            }
            
            // Hàm vẽ ngôi sao
            drawStar(graphics, x, y, points, outerRadius, innerRadius) {
                const startAngle = -Math.PI / 2; // Bắt đầu từ đỉnh trên
                const step = Math.PI / points;
                
                // Di chuyển đến điểm đầu tiên
                let angle = startAngle;
                const firstX = x + Math.cos(angle) * outerRadius;
                const firstY = y + Math.sin(angle) * outerRadius;
                graphics.moveTo(firstX, firstY);
                
                // Vẽ các điểm của ngôi sao
                for (let i = 1; i < points * 2; i++) {
                    angle += step;
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const pointX = x + Math.cos(angle) * radius;
                    const pointY = y + Math.sin(angle) * radius;
                    graphics.lineTo(pointX, pointY);
                }
                
                // Kết nối lại với điểm đầu tiên
                graphics.lineTo(firstX, firstY);
            }
            
            // Tạo random generator từ seed
            createRandomGenerator(seed) {
                return {
                    _seed: seed,
                    next: function() {
                        this._seed = (this._seed * 9301 + 49297) % 233280;
                        return this._seed / 233280;
                    },
                    nextInt: function(min, max) {
                        return Math.floor(min + this.next() * (max - min + 1));
                    }
                };
            }
            
            // Cập nhật các chunk hiển thị dựa trên vị trí người chơi
            updateVisibleChunks(playerX, playerY) {
                // Lấy vị trí chunk hiện tại của người chơi
                const currentChunkX = Math.floor(playerX / GAME_CONFIG.CHUNK_SIZE);
                const currentChunkY = Math.floor(playerY / GAME_CONFIG.CHUNK_SIZE);
                
                // Hiển thị các chunk xung quanh người chơi
                const chunkRadius = GAME_CONFIG.VISIBLE_CHUNKS;
                for (let x = currentChunkX - chunkRadius; x <= currentChunkX + chunkRadius; x++) {
                    for (let y = currentChunkY - chunkRadius; y <= currentChunkY + chunkRadius; y++) {
                        const chunkKey = `${x},${y}`;
                        this.getChunk(chunkKey); // Đảm bảo chunk này được tạo và hiển thị
                    }
                }
            }
            
            // Thêm đối tượng vào bản đồ
            addGameObject(object) {
                this.gameObjects.push(object);
                this.objectContainer.addChild(object.container);
                return object;
            }
            
            // Xóa đối tượng khỏi bản đồ
            removeGameObject(object) {
                const index = this.gameObjects.indexOf(object);
                if (index !== -1) {
                    this.gameObjects.splice(index, 1);
                    object.destroy();
                }
            }
            
            // Sinh ngẫu nhiên vật phẩm xung quanh người chơi
            spawnRandomItems(playerX, playerY) {
                const radius = 300; // Khoảng cách tối đa từ người chơi
                const spawnChance = Math.random();
                
                if (spawnChance < GAME_CONFIG.FLAG_SPAWN_CHANCE) {
                    // Tạo cờ Việt Nam
                    const angle = Math.random() * Math.PI * 2;
                    const distance = radius * (0.7 + Math.random() * 0.3);
                    const x = playerX + Math.cos(angle) * distance;
                    const y = playerY + Math.sin(angle) * distance;
                    
                    this.addGameObject(new Item(x, y, 'flag'));
                } else if (spawnChance < GAME_CONFIG.FLAG_SPAWN_CHANCE + GAME_CONFIG.GOLD_SPAWN_CHANCE) {
                    // Sinh vàng theo tỉ lệ 4 viên mỗi 15 phút
                    const now = Date.now();
                    if (!this.lastGoldSpawn || now - this.lastGoldSpawn > GAME_CONFIG.TIME_BETWEEN_GOLDS / 4) {
                        const angle = Math.random() * Math.PI * 2;
                        const distance = radius * (0.6 + Math.random() * 0.4);
                        const x = playerX + Math.cos(angle) * distance;
                        const y = playerY + Math.sin(angle) * distance;
                        
                        this.addGameObject(new Item(x, y, 'gold'));
                        this.lastGoldSpawn = now;
                    }
                } else if (spawnChance < GAME_CONFIG.FLAG_SPAWN_CHANCE + GAME_CONFIG.GOLD_SPAWN_CHANCE + GAME_CONFIG.BOMB_SPAWN_CHANCE) {
                    // Tạo bom
                    const angle = Math.random() * Math.PI * 2;
                    const distance = radius * (0.5 + Math.random() * 0.5);
                    const x = playerX + Math.cos(angle) * distance;
                    const y = playerY + Math.sin(angle) * distance;
                    
                    this.addGameObject(new Item(x, y, 'bomb'));
                } else if (spawnChance < GAME_CONFIG.FLAG_SPAWN_CHANCE + GAME_CONFIG.GOLD_SPAWN_CHANCE + GAME_CONFIG.BOMB_SPAWN_CHANCE + GAME_CONFIG.SHIELD_SPAWN_CHANCE) {
                    // Tạo khiên
                    const angle = Math.random() * Math.PI * 2;
                    const distance = radius * (0.5 + Math.random() * 0.5);
                    const x = playerX + Math.cos(angle) * distance;
                    const y = playerY + Math.sin(angle) * distance;
                    
                    this.addGameObject(new Item(x, y, 'shield'));
                }
            }
            
            // Sinh ngẫu nhiên kẻ cướp
            spawnThief(playerX, playerY, player) {
                if (Math.random() < GAME_CONFIG.THIEF_SPAWN_CHANCE) {
                    // Kiểm tra nếu người chơi có dùng khiên thì tạm thời không sinh thêm kẻ cướp
                    if (player.activeShield) return;
                    
                    // Kiểm tra số lượng kẻ cướp hiện tại
                    const thiefCount = this.gameObjects.filter(obj => obj instanceof Thief).length;
                    if (thiefCount >= 3) return; // Giới hạn số lượng kẻ cướp
                    
                    // Chỉ sinh kẻ cướp khi người chơi có cờ
                    if (player.inventory.flags <= 0) return;
                    
                    // Tạo kẻ cướp ở khoảng cách xa từ người chơi
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 400 + Math.random() * 200;
                    const x = playerX + Math.cos(angle) * distance;
                    const y = playerY + Math.sin(angle) * distance;
                    
                    const thief = new Thief(x, y, player);
                    this.addGameObject(thief);
                    
                    // Thông báo
                    showGameMessage("Cẩn thận! Kẻ cướp đang đến gần!");
                }
            }
            
            // Tạo hiệu ứng pháo hoa
            createFireworks(x, y, count = GAME_CONFIG.FIREWORK_COUNT) {
                const colors = [0xd22730, 0xffff00, 0xffffff, 0xff9900, 0xff00ff];
                
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 3;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    const particle = new Particle(x, y, {
                        speedX: Math.cos(angle) * speed,
                        speedY: Math.sin(angle) * speed,
                        color: color,
                        container: this.objectContainer,
                        alphaDecay: 0.015,
                        lifetime: 60 + Math.random() * 40
                    });
                    
                    this.particles.push(particle);
                }
            }
            
            // Tạo hiệu ứng vụ nổ
            createExplosion(x, y, radius = 80, count = 50) {
                const colors = [0xFF0000, 0xFF5500, 0xFF9900, 0xFFCC00];
                
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 1 + Math.random() * 5;
                    const distance = Math.random() * radius;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    const particle = new Particle(
                        x + Math.cos(angle) * distance * 0.2, 
                        y + Math.sin(angle) * distance * 0.2, 
                        {
                            speedX: Math.cos(angle) * speed,
                            speedY: Math.sin(angle) * speed,
                            color: color,
                            container: this.objectContainer,
                            gravity: 0.05,
                            alphaDecay: 0.02,
                            lifetime: 40 + Math.random() * 30
                        }
                    );
                    
                    this.particles.push(particle);
                }
                
                // Tạo hiệu ứng sóng xung kích
                const shockwave = new PIXI.Graphics();
                shockwave.beginFill(0xFFFFFF, 0.5);
                shockwave.drawCircle(0, 0, 10);
                shockwave.endFill();
                shockwave.x = x;
                shockwave.y = y;
                this.objectContainer.addChild(shockwave);
                
                // Hiệu ứng mở rộng và mờ dần
                let frame = 0;
                const maxFrames = 20;
                
                const expandShockwave = () => {
                    frame++;
                    const progress = frame / maxFrames;
                    shockwave.scale.set(progress * radius / 10);
                    shockwave.alpha = 1 - progress;
                    
                    if (frame >= maxFrames) {
                        this.objectContainer.removeChild(shockwave);
                    } else {
                        requestAnimationFrame(expandShockwave);
                    }
                };
                
                expandShockwave();
            }
            
            // Cập nhật trạng thái bản đồ
            update(delta) {
                // Cập nhật tất cả đối tượng
                for (let i = this.gameObjects.length - 1; i >= 0; i--) {
                    this.gameObjects[i].update(delta);
                }
                
                // Cập nhật các hạt hiệu ứng
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    if (!particle.update()) {
                        particle.destroy();
                        this.particles.splice(i, 1);
                    }
                }
            }
            
            // Kiểm tra va chạm với vật phẩm
            checkItemCollision(x, y, distance = GAME_CONFIG.COLLECT_DISTANCE) {
                for (let i = 0; i < this.gameObjects.length; i++) {
                    const obj = this.gameObjects[i];
                    if (obj instanceof Item && !obj.collected) {
                        const dx = obj.x - x;
                        const dy = obj.y - y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist <= distance) {
                            return obj;
                        }
                    }
                }
                return null;
            }
            
            // Kiểm tra xem đã dùng bom có trúng kẻ cướp không
            checkBombHitThieves(x, y, radius = 100) {
                let hitCount = 0;
                
                for (let i = this.gameObjects.length - 1; i >= 0; i--) {
                    const obj = this.gameObjects[i];
                    if (obj instanceof Thief) {
                        const dx = obj.x - x;
                        const dy = obj.y - y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist <= radius) {
                            // Tiêu diệt kẻ cướp
                            this.removeGameObject(obj);
                            hitCount++;
                        }
                    }
                }
                
                return hitCount;
            }
        }

        // Class Game - Lớp quản lý game
        class Game {
            constructor() {
                this.app = null;
                this.player = null;
                this.gameMap = null;
                this.gameStarted = false;
                this.joystickActive = false;
                this.joystickAngle = 0;
                this.joystickStrength = 0;
                this.collectButtonActive = false;
                this.collectCooldown = false;
                this.lastItemSpawnTime = 0;
                this.lastAmbientUpdateTime = 0;
                this.lastSaveTime = 0;
                this.dayTime = 0; // Thời gian trong ngày (0-1)
                this.gameTime = 0; // Thời gian chơi game (giây)
            }
            
            // Khởi tạo game
            init() {
                // Khởi tạo PIXI.js
                this.app = new PIXI.Application({
                    view: document.getElementById('gameCanvas'),
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x87CEEB, // Màu trời xanh nhạt
                    resolution: window.devicePixelRatio || 1,
                    antialias: true,
                    autoDensity: true,
                });
                
                // Sắp xếp các container theo độ sâu (z-index)
                this.app.stage.sortableChildren = true;
                
                // Khởi tạo bản đồ vô hạn
                this.gameMap = new GameMap();
                this.app.stage.addChild(this.gameMap.skyContainer);
                this.app.stage.addChild(this.gameMap.chunkContainer);
                this.app.stage.addChild(this.gameMap.objectContainer);
                
                // Xử lý sự kiện resize
                window.addEventListener('resize', () => this.handleResize());
                this.handleResize();
                
                // Khởi tạo các điều khiển game
                this.initControls();
                
                // Khởi tạo UI sự kiện
                this.initUIEvents();
                
                // Tải dữ liệu từ localStorage nếu có
                this.loadGameState();
                
                // Bắt đầu vòng lặp game
                this.app.ticker.add(this.gameLoop.bind(this));
            }
            
            // Xử lý resize cửa sổ
            handleResize() {
                this.app.renderer.resize(window.innerWidth, window.innerHeight);
                if (this.player) {
                    this.centerCamera();
                }
            }
            
            // Khởi tạo các điều khiển game
            initControls() {
                const joystickBase = document.getElementById('joystickBase');
                const joystickKnob = document.getElementById('joystickKnob');
                const collectButton = document.getElementById('collectButton');
                const bombButton = document.getElementById('bombButton');
                const shieldButton = document.getElementById('shieldButton');
                
                // Xử lý joystick cho di chuyển
                this.setupJoystick(joystickBase, joystickKnob);
                
                // Xử lý nút nhặt cờ
                collectButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!this.collectCooldown) {
                        this.collectButtonActive = true;
                        this.collectItem();
                    }
                });
                collectButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.collectButtonActive = false;
                });
                collectButton.addEventListener('mousedown', (e) => {
                    if (!this.collectCooldown) {
                        this.collectButtonActive = true;
                        this.collectItem();
                    }
                });
                collectButton.addEventListener('mouseup', () => {
                    this.collectButtonActive = false;
                });
                
                // Xử lý nút đặt bom
                bombButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.useBomb();
                });
                bombButton.addEventListener('mousedown', () => {
                    this.useBomb();
                });
                
                // Xử lý nút dùng khiên
                shieldButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.useShield();
                });
                shieldButton.addEventListener('mousedown', () => {
                    this.useShield();
                });
            }
            
            // Thiết lập joystick
            setupJoystick(base, knob) {
                const baseBounds = base.getBoundingClientRect();
                const baseRadius = baseBounds.width / 2;
                const knobRadius = knob.offsetWidth / 2;
                const maxDistance = baseRadius - knobRadius;
                
                let isActive = false;
                let touchId = null;
                
                // Reset joystick
                const resetKnob = () => {
                    knob.style.transform = `translate(0px, 0px)`;
                    this.joystickActive = false;
                    this.joystickAngle = 0;
                    this.joystickStrength = 0;
                };
                
                // Xử lý di chuyển joystick
                const moveJoystick = (clientX, clientY) => {
                    const bounds = base.getBoundingClientRect();
                    const centerX = bounds.left + bounds.width / 2;
                    const centerY = bounds.top + bounds.height / 2;
                    const deltaX = clientX - centerX;
                    const deltaY = clientY - centerY;
                    
                    const distance = Math.min(Math.hypot(deltaX, deltaY), maxDistance);
                    const angle = Math.atan2(deltaY, deltaX);
                    
                    const moveX = distance * Math.cos(angle);
                    const moveY = distance * Math.sin(angle);
                    
                    knob.style.transform = `translate(${moveX}px, ${moveY}px)`;
                    
                    this.joystickActive = true;
                    this.joystickAngle = angle;
                    this.joystickStrength = distance / maxDistance;
                };
                
                // Xử lý sự kiện chuột
                base.addEventListener('mousedown', (e) => {
                    isActive = true;
                    moveJoystick(e.clientX, e.clientY);
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isActive) {
                        moveJoystick(e.clientX, e.clientY);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (isActive) {
                        isActive = false;
                        resetKnob();
                    }
                });
                
                // Xử lý sự kiện cảm ứng
                base.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!isActive && e.touches.length > 0) {
                        isActive = true;
                        touchId = e.touches[0].identifier;
                        moveJoystick(e.touches[0].clientX, e.touches[0].clientY);
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (isActive) {
                        e.preventDefault();
                        for (let i = 0; i < e.changedTouches.length; i++) {
                            const touch = e.changedTouches[i];
                            if (touch.identifier === touchId) {
                                moveJoystick(touch.clientX, touch.clientY);
                                break;
                            }
                        }
                    }
                });
                
                document.addEventListener('touchend', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        if (isActive && touch.identifier === touchId) {
                            isActive = false;
                            touchId = null;
                            resetKnob();
                            break;
                        }
                    }
                });
                
                document.addEventListener('touchcancel', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        if (isActive && touch.identifier === touchId) {
                            isActive = false;
                            touchId = null;
                            resetKnob();
                            break;
                        }
                    }
                });
            }
            
            // Khởi tạo các sự kiện UI
            initUIEvents() {
                const startButton = document.getElementById('startButton');
                const nameInput = document.getElementById('nameInput');
                
                // Tải tên người chơi từ localStorage nếu có
                const savedName = localStorage.getItem('playerName');
                if (savedName) {
                    nameInput.value = savedName;
                }
                
                // Xử lý nút bắt đầu chơi
                startButton.addEventListener('click', () => {
                    let playerName = nameInput.value.trim();
                    if (!playerName) playerName = `Player${Math.floor(Math.random() * 1000)}`;
                    if (playerName.length > 15) playerName = playerName.substring(0, 15);
                    
                    // Lưu tên người chơi
                    localStorage.setItem('playerName', playerName);
                    
                    // Khởi tạo người chơi và bắt đầu game
                    this.startGame(playerName);
                });
            }
            
            // Bắt đầu game
            startGame(playerName) {
                // Khởi tạo dữ liệu game
                const savedPlayer = JSON.parse(localStorage.getItem('playerData'));
                let x = 0;
                let y = 0;
                let inventory = { flags: 0, gold: 0, bombs: 5, shields: 3 };
                let gameTime = 0;
                
                if (savedPlayer) {
                    x = savedPlayer.x;
                    y = savedPlayer.y;
                    inventory = savedPlayer.inventory || inventory;
                    gameTime = savedPlayer.gameTime || 0;
                }
                
                // Khởi tạo người chơi
                this.player = new Player(x, y, playerName);
                this.player.inventory = inventory;
                this.gameMap.addGameObject(this.player);
                
                // Cập nhật giao diện kho đồ
                updateInventoryUI();
                
                // Đặt thời gian game
                this.gameTime = gameTime;
                updateTimeUI();
                
                // Cập nhật chunk hiện tại và center camera
                this.gameMap.updateVisibleChunks(x, y);
                this.centerCamera();
                
                // Ẩn màn hình giới thiệu
                document.getElementById('introScreen').style.display = 'none';
                
                // Tạo các đối tượng ban đầu trên bản đồ
                this.setupInitialObjects();
                
                // Bắt đầu game
                this.gameStarted = true;
                
                // Hiển thị thông báo chào mừng
                showGameMessage(`Chào mừng, ${playerName}! Hãy tìm và thu thập các lá cờ`, 3000);
            }
            
            // Thiết lập các đối tượng ban đầu trên bản đồ
            setupInitialObjects() {
                // Tạo một số mây ngẫu nhiên
                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 300 + Math.random() * 500;
                    const x = this.player.x + Math.cos(angle) * distance;
                    const y = this.player.y + Math.sin(angle) * distance;
                    
                    this.gameMap.addGameObject(new Cloud(x, y));
                }
                
                // Tạo một số chim ngẫu nhiên
                for (let i = 0; i < 5; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 200 + Math.random() * 300;
                    const x = this.player.x + Math.cos(angle) * distance;
                    const y = this.player.y + Math.sin(angle) * distance;
                    
                    this.gameMap.addGameObject(new Bird(x, y));
                }
                
                // Tạo một số đuốc/đèn ngẫu nhiên
                for (let i = 0; i < 8; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 100 + Math.random() * 400;
                    const x = this.player.x + Math.cos(angle) * distance;
                    const y = this.player.y + Math.sin(angle) * distance;
                    
                    this.gameMap.addGameObject(new Torch(x, y));
                }
                
                // Tạo một số vật phẩm ban đầu
                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 100 + Math.random() * 200;
                    const x = this.player.x + Math.cos(angle) * distance;
                    const y = this.player.y + Math.sin(angle) * distance;
                    
                    // Quyết định loại vật phẩm
                    const itemType = Math.random() < 0.3 ? 'flag' : 
                                    Math.random() < 0.5 ? 'bomb' : 'shield';
                    
                    this.gameMap.addGameObject(new Item(x, y, itemType));
                }
            }
            
            // Đặt camera theo người chơi
            centerCamera() {
                if (!this.player) return;
                
                const viewWidth = window.innerWidth;
                const viewHeight = window.innerHeight;
                
                // Đặt vị trí camera để tập trung vào người chơi
                this.app.stage.x = viewWidth / 2 - this.player.x;
                this.app.stage.y = viewHeight / 2 - this.player.y;
            }
            
            // Nhặt vật phẩm
            collectItem() {
                if (!this.player || this.collectCooldown) return;
                
                const nearbyItem = this.gameMap.checkItemCollision(
                    this.player.x,
                    this.player.y
                );
                
                if (nearbyItem) {
                    // Đánh dấu vật phẩm đã được nhặt
                    nearbyItem.collected = true;
                    
                    // Xử lý dựa trên loại vật phẩm
                    switch (nearbyItem.type) {
                        case 'flag':
                            this.player.inventory.flags++;
                            showGameMessage("Đã nhặt 1 lá cờ!");
                            this.gameMap.createFireworks(nearbyItem.x, nearbyItem.y);
                            break;
                            
                        case 'gold':
                            this.player.inventory.gold += 1000;
                            showGameMessage("Đã nhặt 1000 đồng vàng!");
                            this.gameMap.createFireworks(nearbyItem.x, nearbyItem.y, 15);
                            break;
                            
                        case 'bomb':
                            this.player.inventory.bombs++;
                            showGameMessage("Đã nhặt 1 quả bom!");
                            break;
                            
                        case 'shield':
                            this.player.inventory.shields++;
                            showGameMessage("Đã nhặt 1 khiên bảo vệ!");
                            break;
                    }
                    
                    // Cập nhật giao diện kho đồ
                    updateInventoryUI();
                    
                    // Xóa vật phẩm
                    this.gameMap.removeGameObject(nearbyItem);
                    
                    // Lưu trạng thái game
                    this.saveGameState();
                    
                    // Hiệu ứng cooldown
                    this.collectCooldown = true;
                    document.getElementById('collectButton').style.opacity = '0.5';
                    
                    setTimeout(() => {
                        this.collectCooldown = false;
                        document.getElementById('collectButton').style.opacity = '1';
                    }, 300);
                }
            }
            
            // Sử dụng bom
            useBomb() {
                if (!this.player) return;
                
                if (this.player.useBomb()) {
                    // Tạo hiệu ứng nổ
                    this.gameMap.createExplosion(this.player.x, this.player.y);
                    
                    // Kiểm tra có tiêu diệt được kẻ cướp không
                    const hitCount = this.gameMap.checkBombHitThieves(this.player.x, this.player.y);
                    if (hitCount > 0) {
                        showGameMessage(`Đã tiêu diệt ${hitCount} kẻ cướp!`);
                    } else {
                        showGameMessage("Đã sử dụng bom!");
                    }
                    
                    // Lưu trạng thái game
                    this.saveGameState();
                } else {
                    showGameMessage("Không còn bom!");
                }
            }
            
            // Sử dụng khiên
            useShield() {
                if (!this.player) return;
                
                if (this.player.useShield()) {
                    showGameMessage("Đã kích hoạt khiên bảo vệ (30 giây)!");
                    
                    // Lưu trạng thái game
                    this.saveGameState();
                } else if (this.player.activeShield) {
                    showGameMessage("Khiên đang hoạt động!");
                } else {
                    showGameMessage("Không còn khiên!");
                }
            }
            
            // Cập nhật môi trường xung quanh
            updateAmbient() {
                const now = Date.now();
                
                // Cập nhật chu kỳ ngày/đêm
                this.dayTime = (now % GAME_CONFIG.DAY_CYCLE_DURATION) / GAME_CONFIG.DAY_CYCLE_DURATION;
                this.gameMap.updateSkyColor(this.dayTime);
                
                // Tạo mây mới ngẫu nhiên
                if (Math.random() < 0.3) {
                    const side = Math.random() < 0.5 ? -1 : 1; // Trái hoặc phải
                    const x = this.player.x + side * (window.innerWidth / 2 + 100);
                    const y = this.player.y;
                    
                    this.gameMap.addGameObject(new Cloud(x, y));
                }
                
                // Tạo chim mới ngẫu nhiên
                if (Math.random() < 0.2) {
                    const x = this.player.x - window.innerWidth / 2 - 50;
                    const y = this.player.y + (Math.random() * window.innerHeight - window.innerHeight / 2);
                    
                    this.gameMap.addGameObject(new Bird(x, y));
                }
                
                // Xóa bỏ đối tượng quá xa người chơi để tiết kiệm tài nguyên
                const maxDistance = Math.max(window.innerWidth, window.innerHeight) * 2;
                for (let i = this.gameMap.gameObjects.length - 1; i >= 0; i--) {
                    const obj = this.gameMap.gameObjects[i];
                    
                    // Không xóa người chơi
                    if (obj === this.player) continue;
                    
                    // Tính khoảng cách đến người chơi
                    const dx = obj.x - this.player.x;
                    const dy = obj.y - this.player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Xóa các đối tượng ngoài tầm nhìn quá xa
                    if (distance > maxDistance) {
                        // Chỉ xóa các đối tượng không quan trọng như mây, chim
                        if (obj instanceof Cloud || obj instanceof Bird || 
                            (obj instanceof Item && (obj.type === 'bomb' || obj.type === 'shield'))) {
                            this.gameMap.removeGameObject(obj);
                        }
                    }
                }
            }
            
            // Lưu trạng thái game
            saveGameState() {
                if (!this.player) return;
                
                // Lưu thông tin người chơi
                const playerData = {
                    x: this.player.x,
                    y: this.player.y,
                    inventory: this.player.inventory,
                    gameTime: this.gameTime
                };
                
                // Lưu vào localStorage
                try {
                    localStorage.setItem('playerData', JSON.stringify(playerData));
                    localStorage.setItem('gameTimestamp', Date.now().toString());
                } catch (error) {
                    console.error("Error saving game state:", error);
                }
            }
            
            // Tải trạng thái game
            loadGameState() {
                try {
                    // Kiểm tra xem có dữ liệu đã lưu không
                    const playerData = localStorage.getItem('playerData');
                    const gameTimestamp = localStorage.getItem('gameTimestamp');
                    
                    // Nếu dữ liệu đã được lưu và không quá 1 ngày
                    if (playerData && gameTimestamp) {
                        const now = Date.now();
                        const timestamp = parseInt(gameTimestamp);
                        const oneDayMs = 24 * 60 * 60 * 1000;
                        
                        if (now - timestamp < oneDayMs) {
                            // Dữ liệu còn mới, có thể sử dụng
                            return true;
                        }
                    }
                } catch (error) {
                    console.error("Error loading game state:", error);
                }
                
                return false;
            }
            
            // Vòng lặp game chính
            gameLoop(delta) {
                if (!this.gameStarted || !this.player) return;
                
                // Tính thời gian game
                this.gameTime += delta / 60;
                
                // Cập nhật thời gian hiển thị (mỗi giây)
                if (Math.floor(this.gameTime) > Math.floor((this.gameTime - delta / 60))) {
                    updateTimeUI();
                }
                
                // Di chuyển người chơi theo joystick
                if (this.joystickActive && this.joystickStrength > 0.1) {
                    const speed = GAME_CONFIG.PLAYER_SPEED * this.joystickStrength;
                    this.player.speedX = Math.cos(this.joystickAngle) * speed;
                    this.player.speedY = Math.sin(this.joystickAngle) * speed;
                    this.player.angle = this.joystickAngle;
                } else {
                    // Giảm tốc độ khi không di chuyển
                    this.player.speedX *= 0.8;
                    this.player.speedY *= 0.8;
                    
                    if (Math.abs(this.player.speedX) < 0.1) this.player.speedX = 0;
                    if (Math.abs(this.player.speedY) < 0.1) this.player.speedY = 0;
                }
                
                // Cập nhật vị trí người chơi
                this.player.x += this.player.speedX * delta;
                this.player.y += this.player.speedY * delta;
                
                // Cập nhật các chunk hiển thị và center camera
                this.gameMap.updateVisibleChunks(this.player.x, this.player.y);
                this.centerCamera();
                
                // Sinh ngẫu nhiên vật phẩm
                const now = Date.now();
                if (now - this.lastItemSpawnTime > GAME_CONFIG.ITEM_SPAWN_INTERVAL) {
                    this.gameMap.spawnRandomItems(this.player.x, this.player.y);
                    this.gameMap.spawnThief(this.player.x, this.player.y, this.player);
                    this.lastItemSpawnTime = now;
                }
                
                // Cập nhật môi trường xung quanh
                if (now - this.lastAmbientUpdateTime > GAME_CONFIG.AMBIENT_UPDATE_INTERVAL) {
                    this.updateAmbient();
                    this.lastAmbientUpdateTime = now;
                }
                
                // Cập nhật tất cả đối tượng trên bản đồ
                this.gameMap.update(delta);
                
                // Lưu trạng thái game định kỳ
                if (now - this.lastSaveTime > 10000) { // Mỗi 10 giây
                    this.saveGameState();
                    this.lastSaveTime = now;
                }
            }
        }

        // Khởi tạo game
        const game = new Game();
        game.init();

        // Cập nhật giao diện kho đồ
        function updateInventoryUI() {
            if (!game.player) return;
            
            document.getElementById('flagCount').textContent = game.player.inventory.flags;
            document.getElementById('goldCount').textContent = game.player.inventory.gold;
            document.getElementById('bombCount').textContent = game.player.inventory.bombs;
            document.getElementById('shieldCount').textContent = game.player.inventory.shields;
        }

        // Cập nhật thời gian hiển thị
        function updateTimeUI() {
            if (!game.gameTime) return;
            
            const totalSeconds = Math.floor(game.gameTime);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            document.getElementById('timeValue').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Hiển thị thông báo trong game
        function showGameMessage(text, duration = 2000) {
            const messageElement = document.getElementById('gameMessage');
            messageElement.textContent = text;
            messageElement.style.opacity = '1';
            
            clearTimeout(window.messageTimeout);
            window.messageTimeout = setTimeout(() => {
                messageElement.style.opacity = '0';
            }, duration);
        }
    </script>
</body>
</html>
